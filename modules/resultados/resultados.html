<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;," />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MB Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- SheetJS for XLSX parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Chart.js DataLabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* --- Variáveis de Tema --- */
        :root {
            /* Cores de Acento e Ação (Tema Claro) */
            --accent-primary: #ac009e;   /* Magenta (Nova paleta) */
            --accent-secondary: #fd24a0; /* Pink (Nova paleta) */
            
            /* Cores Semânticas */
            --success-color: #70e000;    /* Verde (Nova paleta) */
            --warning-color: #f88f0b;    /* Laranja (Nova paleta) */
            --danger-color: #ef476f;     /* Vermelho (Mantido) */
            --info-color: #00d5ff;       /* Ciano (Nova paleta) */

            /* Paleta de Cores Adicional (para gráficos, etc.) */
            --brand-magenta: #ccff33;
            --brand-pink: #fd24a0;
            --brand-lime: #ccff33;
            --brand-green: #70e000;
            --brand-cyan: #00d5ff;
            --brand-orange: #f88f0b;
            --brand-dark-blue: #010d32;
            --brand-snow-white: #fffafa;
            
            /* Tema Claro (Padrão) - Melhorado */
            --bg-primary: #f8fafc;        /* Fundo principal - azul-cinza muito claro */
            --bg-secondary: #ffffff;      /* Fundo de cards, modais (branco puro) */
            --bg-tertiary: #f1f5f9;       /* Fundo de elementos aninhados - azul-cinza claro */
            
            --text-primary: #1e293b;      /* Texto principal - azul-cinza escuro moderno */
            --text-secondary: #64748b;    /* Texto secundário - cinza-azul médio */
            --text-accent: var(--accent-primary);
            --text-on-accent: #ffffff;    /* Texto sobre fundos de acento */
            
            --border-primary: #e2e8f0;      /* Bordas principais - azul-cinza suave */
            --border-secondary: #cbd5e1;    /* Bordas de inputs - azul-cinza médio */
            --border-accent: var(--accent-primary);
            
            /* Estados de hover e foco - Light Mode */
            --hover-overlay: rgba(148, 163, 184, 0.05);
            --focus-ring: rgba(172, 0, 158, 0.15);

            /* Sombras - Melhoradas */
            --shadow-color-rgb: 30, 41, 59;
            --shadow-sm: 0 1px 3px rgba(var(--shadow-color-rgb), 0.05);
            --shadow-md: 0 2px 8px rgba(var(--shadow-color-rgb), 0.08);
            --shadow-lg: 0 4px 16px rgba(var(--shadow-color-rgb), 0.12);

            /* Outras variáveis de layout */
            --border-radius: 10px;
            --border-radius-lg: 16px;
            --transition-fast: 0.13s cubic-bezier(0.4,0,0.2,1);
            --transition-normal: 0.22s cubic-bezier(0.4,0,0.2,1);
            --transition-slow: 0.33s cubic-bezier(0.4,0,0.2,1);
            --spacing-xs: 0.375rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1.25rem;
            --spacing-lg: 2rem;
            --spacing-xl: 2.5rem;

            /* Adicionado para usar em rgba() */
            --brand-cyan-rgb: 0, 213, 255;
            --success-color-rgb: 112, 224, 0;
            --warning-color-rgb: 248, 143, 11;
            --accent-secondary-rgb: 253, 36, 160;
            --brand-magenta-rgb: 172, 0, 158;
            --brand-green-rgb: 112, 224, 0;
            --brand-orange-rgb: 248, 143, 11;
        }

        /* Tema Escuro - Para modo dark */
        body.dark {
            /* Cores de Acento e Ação */
            --accent-primary: #fd24a0;   /* Pink (Nova paleta) */
            --accent-secondary: #ac009e; /* Magenta (Nova paleta) */

            /* Tema Escuro */
            --bg-primary: #010d32;      /* Fundo principal (Novo azul da marca) */
            --bg-secondary: #0b1a4c;    /* Fundo de cards (tom mais claro do novo azul) */
            --bg-tertiary: #11225a;     /* Fundo de elementos aninhados, hovers */
            
            --text-primary: #fffafa;     /* Texto principal (Novo branco 'snow') */
            --text-secondary: #a3aed0;   /* Mantido para bom contraste */
            
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.18);
            
            /* Sombras */
            --shadow-color-rgb: 0, 0, 0;
            --shadow-sm: 0 1px 4px rgba(var(--shadow-color-rgb), 0.18);
            --shadow-md: 0 3px 10px rgba(var(--shadow-color-rgb), 0.22);
            --shadow-lg: 0 6px 20px rgba(var(--shadow-color-rgb), 0.25);
        }

        /* Estilos globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            font-size: 1.05rem;
            line-height: 1.7;
            letter-spacing: 0.01em;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            overflow-x: hidden; /* Evita scroll horizontal */
        }

        /* Força o tema escuro como padrão */
        body.dark {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        /* Força o tema claro */
        body:not(.dark) {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        .text-text-secondary { color: var(--text-secondary); }

        a { text-decoration: none; color: var(--text-accent); }
        a:hover { color: var(--accent-secondary); }
        button { font-family: inherit; }
        i { line-height: 1; } /* Para ícones FA */
        svg.icon { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; vertical-align: middle; } /* Estilo base para SVGs como ícones */

        /* --- Layout Geral --- */
        .app-container { display: flex; height: 100vh; }

        /* --- Conteúdo Principal --- */
        .main-content {
            flex: 1;
            margin-left: 0; /* Ajustado para 0, pois a sidebar foi removida */
            transition: margin-left 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-primary) !important;
        }

        /* Container de Views */
        .view-container { display: none; flex-direction: column; height: 100%; }
        .view-container.active { display: flex; }

        /* --- Cabeçalho Geral das Views --- */
        .header {
            padding: 0 var(--spacing-lg); border-bottom: 1px solid var(--border-primary);
            display: flex; align-items: center; min-height: 65px; flex-wrap: wrap; gap: var(--spacing-md);
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            transition: background-color 0.3s, border-color 0.3s;
            box-shadow: var(--shadow-sm); flex-shrink: 0;
        }
        .header-main {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }
        .header-title {
            font-size: 1.45rem !important;
            font-weight: 600;
            letter-spacing: 0.01em;
            margin: 0;
            color: var(--text-primary);
            white-space: nowrap;
            display: inline-block;
        }
        .header-actions { display: flex; gap: var(--spacing-sm); align-items: center; }
        .header-center { flex: 1; display: flex; justify-content: center; }
        .header-right { flex: 0 0 200px; display: flex; justify-content: flex-end; gap: var(--spacing-sm); align-items: center; }

        /* --- Elementos Comuns (Estilo Unificado Dark) --- */

        /* Botão de Tema */
        .theme-toggle-btn {
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            background-color: transparent; border: none; display: flex;
            align-items: center; justify-content: center;
            color: var(--text-primary);
            transition: all var(--transition-normal);
        }
        .theme-toggle-btn:hover { background-color: var(--bg-tertiary); transform: rotate(15deg); }
        /* Ícones do botão de tema - usando !important para garantir que funcione */
        body.dark .theme-toggle-btn .fa-sun { display: inline-block !important; }
        body.dark .theme-toggle-btn .fa-moon { display: none !important; }
        body.light .theme-toggle-btn .fa-sun { display: none !important; }
        body.light .theme-toggle-btn .fa-moon { display: inline-block !important; }
        /* Fallback para quando não há classe específica (padrão escuro) */
        body:not(.light) .theme-toggle-btn .fa-sun { display: inline-block !important; }
        body:not(.light) .theme-toggle-btn .fa-moon { display: none !important; }

        /* Botões */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.75rem 1rem; border-radius: var(--border-radius);
            font-weight: 500; cursor: pointer; transition: all var(--transition-normal);
            border: none; font-size: 0.98rem !important; gap: 0.5rem;
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
        }
        .btn::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0); transition: background-color var(--transition-fast);
        }
        .btn:hover::after { background-color: rgba(255, 255, 255, 0.05); }
        .btn:active::after { background-color: rgba(255, 255, 255, 0.1); }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .btn-primary:hover { background-color: var(--accent-secondary); box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        .btn-outline { background-color: transparent; border: 1px solid var(--border-secondary); color: var(--text-primary); }
        .btn-outline:hover { 
            background-color: var(--bg-tertiary); 
            box-shadow: var(--shadow-md); 
            transform: translateY(-1px);
            border-color: var(--border-accent);
        }
        .btn-outline:active { transform: translateY(0); }
        .btn-danger { background-color: var(--danger-color); color: var(--text-on-accent); }
        .btn-danger:hover { background-color: var(--danger-dark); box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.98rem !important; }
        .btn-sm i, .btn-sm svg.icon { margin-right: 0.3rem; font-size: 0.7rem; width: 14px; height: 14px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none !important; }
        .btn:disabled::after { display: none; }
        .btn-whatsapp { background-color: #25D366; color: var(--text-primary); border-color: #25D366; }
        .btn-whatsapp:hover { background-color: #1DAE51; border-color: #1DAE51; }
        .btn-whatsapp i { margin-right: 0.5rem; }
        .btn-icon-only { padding: 0.5rem; width: 32px; height: 32px; }
        .btn-icon-only i, .btn-icon-only svg.icon { margin: 0; font-size: 1rem; width: 16px; height: 16px; }

        /* Input de Busca */
        .search-wrapper { position: relative; }
        .search-input {
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-secondary);
            background-color: var(--bg-secondary);
            width: 220px; font-size: 0.875rem;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            color: var(--text-primary);
        }
        .search-input::placeholder { color: var(--text-secondary); }
        .search-input:focus {
            outline: none;
            border-color: var(--border-accent);
            box-shadow: 0 0 0 3px var(--focus-ring);
            background-color: var(--bg-secondary);
        }
        .search-icon {
            position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%);
            color: var(--text-secondary); pointer-events: none; width: 16px; height: 16px;
        }

        /* Dropdowns */
        .dropdown { position: relative; }
        .dropdown-toggle {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: var(--border-radius);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.97rem !important; cursor: pointer; border: none;
            transition: all var(--transition-normal); box-shadow: var(--shadow-sm);
            max-width: 250px;
        }
        .dropdown-toggle:hover { 
            background-color: var(--bg-tertiary); 
            filter: brightness(0.98); 
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-secondary);
        }
        .dropdown-toggle span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }
        .dropdown-toggle svg.icon { color: var(--text-secondary); }
        .dropdown-menu {
            position: absolute; top: 100%; right: 0; width: 200px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius); box-shadow: var(--shadow-lg);
            z-index: 10; display: none; margin-top: 0.5rem; overflow: hidden;
            border: 1px solid var(--border-primary);
            animation: fadeIn var(--transition-fast);
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 0.75rem 1rem; cursor: pointer; transition: all var(--transition-fast);
            display: flex; align-items: center; color: var(--text-primary);
        }
        .dropdown-item:hover { background-color: var(--bg-tertiary); }
        .dropdown-item.active { background-color: var(--accent-primary); color: var(--text-on-accent); font-weight: bold; }
        .dropdown-item-check { margin-right: 0.5rem; opacity: 0; width: 1em; display: inline-block; }
        .dropdown-item.active .dropdown-item-check { opacity: 1; }

        /* Formulários Gerais */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.85rem !important; font-weight: 500; margin-bottom: 0.3rem; color: var(--text-secondary); }
        .form-input, .form-select, .form-textarea, .input {
            width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border-secondary);
            border-radius: var(--border-radius); font-size: 0.875rem;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
        }
        .form-input::placeholder, .form-textarea::placeholder, .input::placeholder { color: var(--text-secondary); }
        .form-input:focus, .form-select:focus, .form-textarea:focus, .input:focus {
            outline: none; border-color: var(--border-accent);
            box-shadow: 0 0 0 3px var(--focus-ring);
            background-color: var(--bg-secondary);
        }
        .form-textarea, .textarea { min-height: 80px; }
        .input-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }

        /* --- Estilos Específicos do Dashboard --- */
        .dashboard-container {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            overflow-y: auto; /* Permite scroll na área principal do dashboard */
            background-color: var(--bg-primary) !important;
        }

        /* Abas de navegação no topo (Gestão/Clientes) */
        .tab-navigation {
            display: flex;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 4px;
            box-shadow: var(--shadow-sm);
            border: 1.5px solid var(--border-primary);
            position: relative;
            margin-bottom: 1.2rem;
            gap: 0.5rem;
        }
        .tab-filter {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.97rem !important;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            justify-content: center;
            min-width: 96px;
            box-shadow: none;
        }
        .tab-filter:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        .tab-filter.active {
            color: #00d5ff;
            background: rgba(var(--accent-primary), 0.13);
            font-weight: 600;
            box-shadow: 0 1.5px 6px rgba(var(--accent-primary), 0.10);
        }
        .tab-icon {
            font-size: 12.8px;
            transition: transform 0.3s ease;
        }
        .tab-filter.active .tab-icon {
            transform: scale(1.08);
        }
        .tab-indicator {
            position: absolute;
            bottom: 4px;
            left: 0;
            height: 2.4px;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
        }
        .tab-filter.active ~ .tab-indicator,
        .tab-navigation:has(.tab-filter.active) .tab-indicator {
            width: auto;
        }
        @media (max-width: 1024px) {
            .tab-filter {
                padding: 7px 12px;
                font-size: 9.2px;
                min-width: 72px;
            }
            .tab-icon {
                font-size: 10.2px;
            }
        }
        @media (max-width: 768px) {
            .tab-filter {
                padding: 5px 8px;
                font-size: 8.2px;
                min-width: 56px;
            }
            .tab-navigation {
                padding: 2px;
            }
        }

        /* Tab Content Styles */
        .tab-content-section {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content-section.hidden {
            display: none;
        }

        /* Cartões de Métricas - Melhorados */
        .metric-card-dashboard {
            background: var(--bg-secondary) !important;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            color: var(--text-primary) !important;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .metric-card-dashboard:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-secondary);
        }
        /* Adiciona um sutil overlay no hover para light mode */
        body:not(.dark) .metric-card-dashboard:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--hover-overlay);
            pointer-events: none;
            z-index: 0;
        }
        .metric-card-dashboard h3 {
            font-size: 1.08rem !important;
            font-weight: 600;
            letter-spacing: 0.01em;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        .metric-value-main {
            font-size: 2.2rem !important;
            font-weight: 700;
            letter-spacing: 0.01em;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .metric-card-dashboard:hover .metric-value-main {
            color: var(--accent-primary);
        }
        .metric-sub-value {
            font-size: 1.08rem !important;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .metric-sub-label {
            font-size: 0.7rem !important;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .metric-comparison {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .metric-comparison-value {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .metric-comparison-value i.fa-caret-up { color: var(--success-color); }
        .metric-comparison-value i.fa-caret-down { color: var(--danger-color); }
        .metric-comparison-value i.fa-equals { color: var(--text-secondary); }

        /* Gráficos - Melhorados */
        .chart-container-card {
            background: var(--bg-secondary) !important;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            border: 1px solid var(--border-primary);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chart-container-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--border-secondary);
        }
        .chart-container-card h3 {
            font-size: 1.08rem !important;
            font-weight: 600;
            letter-spacing: 0.01em;
            margin-bottom: 1rem;
            color: var(--text-primary) !important;
        }
        canvas {
            width: 100% !important;
            max-width: 100%;
            height: 350px !important;
            min-height: 220px;
            max-height: 350px;
            display: block;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            canvas {
                height: 220px !important;
                min-height: 120px;
                max-height: 220px;
            }
        }

        /* Tabelas de Clientes */
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-primary);
        }
        .modern-table thead th {
            background-color: var(--brand-dark-blue);
            color: var(--text-on-accent);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 1.01rem !important;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 1px solid var(--border-primary);
        }
        .modern-table tbody tr:nth-child(odd) { background-color: var(--bg-tertiary); }
        .modern-table tbody tr:nth-child(even) { background-color: var(--bg-secondary); }
        .modern-table tbody tr:hover { 
            background-color: var(--bg-tertiary); 
            filter: brightness(0.98);
            transition: all 0.2s ease;
        }
        .modern-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-primary);
            font-size: 0.97rem !important;
            color: var(--text-primary);
        }
        .status-badge-table {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        .status-active { background-color: var(--success-color); color: var(--text-primary); }
        .status-recurrent { background-color: var(--info-color); color: var(--text-primary); }
        .status-attention { background-color: var(--warning-color); color: var(--text-primary); }
        .status-urgent { background-color: var(--danger-color); color: var(--text-on-accent); }

        /* Modal e Upload */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.show { opacity: 1; display: flex; }
        .modal-content-custom {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-out;
        }
        .modal-backdrop.show .modal-content-custom { transform: scale(1); opacity: 1; }
        .drop-zone {
            border: 2px dashed var(--border-primary);
            border-radius: var(--border-radius);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .drop-zone:hover, .drop-zone.dragover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        .drop-zone i { color: var(--accent-primary); }

        /* Animações */
        .icon-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .main-content { margin-left: 0; } /* Ajustado */
            .header-main { flex: 1; }
            .header-actions { flex-wrap: wrap; justify-content: flex-end; }
            .header-center { display: none; } /* Oculta o dropdown de empresa no mobile */
            .header-right { flex: 1; justify-content: flex-end; }
            .metric-card-dashboard { padding: 1rem; }
            .metric-card-dashboard h3 { font-size: 1rem; margin-bottom: 0.5rem; }
            .metric-value-main { font-size: 2rem; margin-bottom: 1rem; }
            .metric-sub-value { font-size: 0.9rem; }
            .metric-sub-label { font-size: 0.65rem; }
            .metric-comparison { font-size: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; }
            .tab-navigation { flex-wrap: wrap; justify-content: center; }
            .tab-filter { flex: 1 1 auto; min-width: unset; padding: 10px 15px; }
            .tab-icon { font-size: 14px; }
            .modern-table thead th, .modern-table td { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
            .chart-container-card { padding: 1rem; }
            .chart-container-card h3 { font-size: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header { padding: 0 var(--spacing-sm); min-height: 55px; gap: 0.5rem; }
            .header-title { font-size: 1rem; }
            .header-actions .btn span { display: none; }
            .header-actions .btn i, .header-actions .btn svg.icon { margin-right: 0; }
            .dashboard-container { padding: var(--spacing-sm); }
            .metric-card-dashboard { margin-bottom: 1rem; }
            .grid-cols-1.lg\:grid-cols-3 { grid-template-columns: 1fr; }
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 { grid-template-columns: 1fr; }
            .tab-navigation { padding: 4px; }
            .tab-filter { padding: 8px 12px; font-size: 12px; }
            .tab-icon { font-size: 14px; }
        }

        /* Ajuste para dashboard compacto */
        .dashboard-container {
            padding: 0.5rem;
            min-height: unset;
            max-height: 100vh;
            overflow-y: auto;
        }
        .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 0.55rem !important;
        }
        .metric-card-dashboard {
            padding: 0.75rem 0.75rem 0.75rem 0.75rem !important;
            min-width: 0;
            min-height: 0;
            box-shadow: none;
            margin-bottom: 0.5rem;
        }
        .metric-card-dashboard h3 {
            font-size: 1rem !important;
            margin-bottom: 0.5rem !important;
        }
        .metric-value-main {
            font-size: 1.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        .metric-sub-value {
            font-size: 0.95rem !important;
        }
        .metric-sub-label {
            font-size: 0.65rem !important;
        }
        .metric-comparison {
            margin-top: 0.5rem !important;
            padding-top: 0.5rem !important;
            font-size: 0.75rem !important;
        }
        .chart-container-card {
            padding: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        .chart-container-card h3 {
            font-size: 0.95rem !important;
            margin-bottom: 0.5rem !important;
        }
        canvas {
            height: 120px !important;
            min-height: 80px !important;
            max-height: 120px !important;
        }
        @media (max-width: 1024px) {
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        @media (max-width: 768px) {
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            .dashboard-container {
                padding: 0.25rem;
            }
        }

        /* Dashboard compacto e visual aprimorado */
        .dashboard-container {
            padding: 1.5rem 1rem;
            max-width: 100vw;
            overflow-x: hidden;
        }
        .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 1.25rem !important;
        }
        .metric-card-dashboard {
            padding: 1.25rem 1rem 1.25rem 1rem !important;
            min-width: 0;
            min-height: 0;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 4px 18px 0 rgba(var(--shadow-color-rgb),0.18), 0 1.5px 4px 0 rgba(var(--accent-primary),0.08);
            border: 1.5px solid var(--border-primary);
            margin-bottom: 1rem;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .metric-card-dashboard:hover {
            box-shadow: 0 8px 32px 0 rgba(var(--shadow-color-rgb),0.22), 0 2px 8px 0 rgba(var(--accent-primary),0.12);
            transform: translateY(-2px) scale(1.01);
        }
        .metric-card-dashboard h3 {
            font-size: 1.15rem !important;
            margin-bottom: 0.5rem !important;
            letter-spacing: 0.02em;
            color: var(--accent-primary);
            text-shadow: 0 1px 2px rgba(var(--shadow-color-rgb),0.08);
        }
        .metric-value-main {
            font-size: 2.1rem !important;
            margin-bottom: 0.7rem !important;
            color: var(--text-primary);
            text-shadow: 0 2px 8px rgba(var(--accent-primary),0.08);
        }
        .metric-sub-value {
            font-size: 1.05rem !important;
            color: var(--text-primary);
        }
        .metric-sub-label {
            font-size: 0.7rem !important;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .metric-comparison {
            margin-top: 0.7rem !important;
            padding-top: 0.7rem !important;
            font-size: 0.8rem !important;
            border-top: 1px solid var(--border-primary);
        }
        .chart-container-card {
            padding: 1.5rem 1rem 1.5rem 1rem !important;
            margin-bottom: 1.2rem !important;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1.5px solid var(--border-primary);
            background: var(--bg-secondary);
        }
        .chart-container-card h3 {
            font-size: 1.08rem !important;
            margin-bottom: 0.7rem !important;
            color: var(--accent-primary);
        }
        /* Espaço maior para o gráfico de Atendimentos por Dia do Mês */
        #grafico-atendimentos-dia {
            height: 260px !important;      /* Aumentado de 208px */
            min-height: 180px !important;     /* Aumentado de 144px */
            max-height: 320px !important;    /* Aumentado de 256px */
        }
        
        /* Estilo especial para o container do gráfico de atendimentos */
        .chart-container-card:has(#grafico-atendimentos-dia) {
            border: 1.5px solid var(--info-color);
            box-shadow: 0 4px 18px 0 rgba(0, 213, 255, 0.15), 0 1.5px 4px 0 rgba(0, 213, 255, 0.08);
        }
        
        .chart-container-card:has(#grafico-atendimentos-dia):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px 0 rgba(0, 213, 255, 0.2), 0 2px 8px 0 rgba(0, 213, 255, 0.12);
            transition: all 0.3s ease;
        }
        canvas {
            height: 96px !important;
            min-height: 64px !important;
            max-height: 96px !important;
        }
        @media (max-width: 1024px) {
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            #grafico-atendimentos-dia {
                height: 220px !important;      /* Aumentado de 144px */
                min-height: 150px !important;     /* Aumentado de 96px */
                max-height: 250px !important;    /* Aumentado de 176px */
            }
        }
        @media (max-width: 768px) {
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            .dashboard-container {
                padding: 0.25rem;
            }
            #grafico-atendimentos-dia {
                height: 180px !important;      /* Aumentado de 96px */
                min-height: 120px !important;     /* Aumentado de 64px */
                max-height: 200px !important;    /* Aumentado de 112px */
            }
        }
        .dashboard-container {
            padding: 1.2rem 0.8rem;
        }
        .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
            gap: 1rem !important;
        }
        .metric-card-dashboard {
            padding: 1rem 0.8rem 1rem 0.8rem !important;
            border-radius: var(--border-radius);
            margin-bottom: 0.8rem;
        }
        .metric-card-dashboard h3 {
            font-size: 0.92rem !important;
            margin-bottom: 0.4rem !important;
        }
        .metric-value-main {
            font-size: 1.68rem !important;
            margin-bottom: 0.56rem !important;
        }
        .metric-sub-value {
            font-size: 0.84rem !important;
        }
        .metric-sub-label {
            font-size: 0.56rem !important;
        }
        .metric-comparison {
            margin-top: 0.56rem !important;
            padding-top: 0.56rem !important;
            font-size: 0.64rem !important;
        }
        .chart-container-card {
            padding: 1.2rem 0.8rem 1.2rem 0.8rem !important;
            border-radius: var(--border-radius);
            margin-bottom: 1rem !important;
        }
        .chart-container-card h3 {
            font-size: 0.86rem !important;
            margin-bottom: 0.56rem !important;
        }
        #grafico-atendimentos-dia {
            height: 260px !important;      /* Aumentado de 208px */
            min-height: 180px !important;     /* Aumentado de 144px */
            max-height: 320px !important;    /* Aumentado de 256px */
        }
        canvas {
            height: 96px !important;
            min-height: 64px !important;
            max-height: 96px !important;
        }
        @media (max-width: 1024px) {
            #grafico-atendimentos-dia {
                height: 220px !important;      /* Aumentado de 144px */
                min-height: 150px !important;     /* Aumentado de 96px */
                max-height: 250px !important;    /* Aumentado de 176px */
            }
        }
        @media (max-width: 768px) {
            #grafico-atendimentos-dia {
                height: 180px !important;      /* Aumentado de 96px */
                min-height: 120px !important;     /* Aumentado de 64px */
                max-height: 200px !important;    /* Aumentado de 112px */
            }
        }
        .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
            margin-bottom: 0.3rem !important;
        }
        .chart-container-card {
            margin-top: 0.3rem !important;
        }
        .metric-card-dashboard {
            padding-top: 0.68rem !important;
            padding-bottom: 0.68rem !important;
        }
        .metric-card-dashboard h3 {
            margin-bottom: 0.28rem !important;
        }
        .metric-value-main {
            margin-bottom: 0.40rem !important;
        }
        .metric-comparison {
            margin-top: 0.40rem !important;
            padding-top: 0.40rem !important;
        }
        #clientes-cards-group {
            justify-content: center;
            display: flex;
            gap: 0.25rem !important;
            width: auto;
            margin-bottom: 1.2rem;
        }
        @media (max-width: 900px) {
            #clientes-cards-group {
                flex-wrap: wrap;
                gap: 0.15rem !important;
            }
        }
        #btn-clientes-total.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--info-color) !important;
        }
        #btn-clientes-total .metric-value-main {
            color: var(--info-color) !important;
        }
        #btn-clientes-total i {
            color: var(--info-color) !important;
        }
        #btn-clientes-recorrentes.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--success-color) !important;
        }
        #btn-clientes-recorrentes .metric-value-main {
            color: var(--success-color) !important;
        }
        #btn-clientes-recorrentes i {
            color: var(--success-color) !important;
        }
        #btn-clientes-atencao.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--warning-color) !important;
        }
        #btn-clientes-atencao .metric-value-main {
            color: var(--warning-color) !important;
        }
        #btn-clientes-atencao i {
            color: var(--warning-color) !important;
        }
        @media (max-width: 900px) {
            #clientes-cards-group {
                flex-wrap: wrap;
                gap: 0.15rem !important;
            }
        }
        #clientes-cards-group button.metric-card-dashboard {
            max-width: 180px;
            min-width: 140px;
            /* Remover margin: 0 auto; */
            padding: 0.6rem 0.7rem 0.6rem 0.7rem !important;
            border-radius: 12px !important;
            box-shadow: var(--shadow-sm);
            font-size: 0.92rem !important;
            margin-bottom: 0 !important;
            background: var(--bg-secondary);
            border: 1.2px solid var(--border-primary);
            transition: box-shadow 0.18s, transform 0.18s;
        }
        #clientes-cards-group button.metric-card-dashboard:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px) scale(1.01);
        }
        #clientes-cards-group .metric-value-main {
            font-size: 1.25rem !important;
            margin-bottom: 0.2rem !important;
        }
        #clientes-cards-group .metric-sub-label {
            font-size: 0.68rem !important;
            margin-bottom: 0.1rem !important;
        }
        #clientes-cards-group i {
            font-size: 1.1rem !important;
        }
        #clientes-cards-group .bg-white\/10 {
            padding: 0.6rem !important;
            background-color: var(--bg-tertiary);
        }
        #clientes-cards-group .flex.items-center.justify-between {
            justify-content: center !important;
            gap: 0.5rem !important;
        }

        /* --- NOVO: Estilo dos cards de filtro de cliente --- */
        #client-filter-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .client-filter-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-primary);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: left;
            box-shadow: var(--shadow-sm);
        }

        .client-filter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-secondary);
        }
        
        .client-filter-card.active {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .client-filter-card .filter-card-label {
            font-size: 0.8rem !important;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
            transition: color var(--transition-fast);
        }

        .client-filter-card .filter-card-value {
            font-size: 1.75rem !important;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            transition: color var(--transition-normal);
        }

        .client-filter-card .filter-card-icon-wrapper {
            background-color: var(--bg-tertiary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .client-filter-card .filter-card-icon-wrapper i {
            font-size: 1.1rem;
            color: var(--text-secondary);
            transition: all var(--transition-normal);
        }

        /* Estilos de Ativação e Cores */
        .client-filter-card#btn-clientes-total.active { border-color: var(--info-color); }
        .client-filter-card#btn-clientes-total.active .filter-card-label,
        .client-filter-card#btn-clientes-total.active .filter-card-value { color: var(--info-color); }
        .client-filter-card#btn-clientes-total.active .filter-card-icon-wrapper { background-color: rgba(var(--brand-cyan-rgb), 0.15); }
        .client-filter-card#btn-clientes-total.active .filter-card-icon-wrapper i { color: var(--info-color); }

        .client-filter-card#btn-clientes-recorrentes.active { border-color: var(--success-color); }
        .client-filter-card#btn-clientes-recorrentes.active .filter-card-label,
        .client-filter-card#btn-clientes-recorrentes.active .filter-card-value { color: var(--success-color); }
        .client-filter-card#btn-clientes-recorrentes.active .filter-card-icon-wrapper { background-color: rgba(var(--success-color-rgb), 0.15); }
        .client-filter-card#btn-clientes-recorrentes.active .filter-card-icon-wrapper i { color: var(--success-color); }

        .client-filter-card#btn-clientes-atencao.active { border-color: var(--warning-color); }
        .client-filter-card#btn-clientes-atencao.active .filter-card-label,
        .client-filter-card#btn-clientes-atencao.active .filter-card-value { color: var(--warning-color); }
        .client-filter-card#btn-clientes-atencao.active .filter-card-icon-wrapper { background-color: rgba(var(--warning-color-rgb), 0.15); }
        .client-filter-card#btn-clientes-atencao.active .filter-card-icon-wrapper i { color: var(--warning-color); }
        
        /* O card "Outros" é apenas informativo, sem interatividade */
        #btn-clientes-outros {
            cursor: default;
        }
        #btn-clientes-outros:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
            border-color: var(--border-primary);
        }

        @media (max-width: 1024px) {
            #client-filter-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }

        @media (max-width: 640px) {
            #client-filter-cards {
                grid-template-columns: 1fr;
            }
        }

        /* === DIFERENCIAÇÃO DE COR PARA CARDS DE GESTÃO === */
        #card-atendimentos.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--brand-cyan) !important;
        }
        #card-atendimentos .metric-value-main {
            color: var(--brand-cyan) !important;
        }
        #card-atendimentos .text-xl.text-info-color {
            color: var(--brand-cyan) !important;
        }
        #card-faturamento.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--brand-green) !important;
        }
        #card-faturamento .metric-value-main {
            color: var(--brand-green) !important;
        }
        #card-faturamento .text-xl.text-success-color {
            color: var(--brand-green) !important;
        }
        #card-clientes.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--brand-orange) !important;
        }
        #card-clientes .metric-value-main {
            color: var(--brand-orange) !important;
        }
        #card-clientes .text-xl.text-warning-color {
            color: var(--brand-orange) !important;
        }
        #card-semana.metric-card-dashboard {
            background-color: var(--bg-secondary) !important;
            border: 1.5px solid var(--brand-magenta) !important;
        }
        #card-semana .metric-value-main {
            color: var(--brand-magenta) !important;
        }
        #card-semana i {
            color: var(--brand-magenta) !important;
        }

        /* === AJUSTE DE FONTES PARA CARDS DE GESTÃO === */
        #tab-content-gestao .metric-card-dashboard h3 {
            font-size: 1.18rem !important;
            font-weight: 700;
            letter-spacing: 0.01em;
            margin-bottom: 0.45rem;
            color: var(--accent-primary);
        }
        #tab-content-gestao .metric-value-main {
            font-size: 2.25rem !important;
            font-weight: 700;
            margin-bottom: 0.65rem !important;
            letter-spacing: 0.01em;
        }
        #tab-content-gestao .metric-sub-label {
            font-size: 0.78rem !important;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.12rem;
        }
        #tab-content-gestao .metric-sub-value {
            font-size: 1.08rem !important;
            font-weight: 500;
            color: var(--text-primary);
        }
        #tab-content-gestao .metric-comparison {
            font-size: 0.92rem !important;
            margin-top: 0.6rem !important;
            padding-top: 0.6rem !important;
        }
        /* === AJUSTE DE FONTES PARA TABELA DO GRÁFICO ATENDIMENTOS POR DIA DO MÊS === */
        #tab-content-gestao .chart-container-card h3 {
            font-size: 1.08rem !important;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.6rem;
        }
        #tab-content-gestao .chart-container-card table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        #tab-content-gestao .chart-container-card table.modern-table td {
            font-size: 0.97rem !important;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
        }
        #tab-content-gestao .metric-card-dashboard h3 {
            margin-bottom: 0.18rem !important;
        }
        #tab-content-gestao .metric-value-main {
            margin-bottom: 0.45rem !important;
        }
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            padding-top: 0.38rem !important;
            padding-bottom: 0.38rem !important;
            line-height: 1.15 !important;
        }
        /* Centralizar números principais nos cards de métricas da aba gestão */
        #tab-content-gestao .metric-value-main {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        /* Centralizar informações dos cards de métricas da aba gestão, exceto o título */
        #tab-content-gestao .metric-value-main,
        #tab-content-gestao .metric-sub-label,
        #tab-content-gestao .metric-sub-value,
        #tab-content-gestao .metric-comparison {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #tab-content-gestao .metric-comparison {
            justify-content: center !important;
        }
        /* Centralizar apenas o valor comparativo do rodapé dos cards de métricas da aba gestão, mantendo o label alinhado à esquerda */
        #tab-content-gestao .metric-comparison {
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto !important;
            min-height: 48px;
            text-align: initial !important;
        }
        #tab-content-gestao .metric-comparison .metric-comparison-value {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #card-semana .metric-comparison {
            font-size: 0.92rem !important;
            margin-top: auto !important;
            padding-top: 0.6rem !important;
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            min-height: 48px;
            text-align: initial !important;
        }
        /* Otimização dos controles de paginação das tabelas de clientes */
        #paginacao-clientes-ativos-div,
        #paginacao-clientes-ativos-div-top,
        #paginacao-clientes-recorrentes-div,
        #paginacao-clientes-recorrentes-div-top,
        #paginacao-clientes-atencao-div,
        #paginacao-clientes-atencao-div-top {
            padding-top: 0.35rem;
            padding-bottom: 0.35rem;
            margin-top: 0;
            margin-bottom: 0;
            gap: 0.3rem !important;
            display: flex;
            justify-content: center !important;
            align-items: center;
            width: 100%;
        }
        #paginacao-clientes-ativos-div .btn,
        #paginacao-clientes-ativos-div-top .btn,
        #paginacao-clientes-recorrentes-div .btn,
        #paginacao-clientes-recorrentes-div-top .btn,
        #paginacao-clientes-atencao-div .btn,
        #paginacao-clientes-atencao-div-top .btn {
            padding: 0.2rem 0.7rem !important;
            font-size: 0.85rem !important;
            min-width: 60px;
            height: 28px;
        }
        #paginacao-clientes-ativos-div span,
        #paginacao-clientes-ativos-div-top span,
        #paginacao-clientes-recorrentes-div span,
        #paginacao-clientes-recorrentes-div-top span,
        #paginacao-clientes-atencao-div span,
        #paginacao-clientes-atencao-div-top span {
            font-size: 0.85rem !important;
            padding: 0 0.2rem;
        }
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper .chart-container-card,
        #tabela-clientes-recorrentes-wrapper .chart-container-card,
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table td,
        #tabela-clientes-ativos-wrapper table.modern-table th,
        #tabela-clientes-recorrentes-wrapper table.modern-table td,
        #tabela-clientes-recorrentes-wrapper table.modern-table th,
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            font-size: 0.97rem !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table thead th,
        #tabela-clientes-recorrentes-wrapper table.modern-table thead th,
        #tabela-clientes-atencao-wrapper table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-on-accent);
            background: var(--brand-dark-blue);
        }
        /* --- NOVO: Estilo do select para parecer parte do título --- */
        .db-title-select, .db-title-label {
            background: transparent;
            color: #ccff33;
            font-family: 'Inter', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            border: none;
            outline: none;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: none;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            white-space: nowrap;
        }
        .db-title-select:focus, .db-title-select:hover {
            background: var(--bg-tertiary);
        }
        .db-title-select option {
            color: #ccff33;
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }
        .db-title-label {
            cursor: default;
            color: #ccff33 !important;
        }
        @media (max-width: 768px) {
            .db-title-select, .db-title-label {
                font-size: 1rem;
                padding: 0 0.3rem;
            }
        }

        /* --- NOVO: Melhorias na Tabela de Clientes --- */
        #clientes-tabelas .chart-container-card {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0 !important;
            margin-top: 1rem !important;
        }

        #clientes-tabelas .modern-table {
            border-spacing: 0;
            text-align: left;
        }

        #clientes-tabelas .modern-table thead th {
            background: var(--brand-dark-blue);
            color: var(--text-on-accent);
            font-size: 0.8rem !important;
            padding: 0.75rem 1rem !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid var(--border-primary); /* Cor padrão */
            transition: border-color var(--transition-normal);
        }
        
        /* --- Cores dinâmicas para o cabeçalho da tabela --- */
        #tabela-clientes-ativos-wrapper.active .modern-table thead th {
            border-bottom-color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .modern-table thead th {
            border-bottom-color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .modern-table thead th {
            border-bottom-color: var(--warning-color);
        }

        #clientes-tabelas .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #clientes-tabelas .modern-table tbody tr:hover {
            background-color: rgba(var(--brand-cyan-rgb), 0.08);
        }

        #clientes-tabelas .modern-table tbody td {
            padding: 1rem 1rem !important;
            font-size: 0.9rem !important;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-primary);
        }

        #clientes-tabelas .modern-table tbody td:first-child {
            font-weight: 500;
            color: var(--text-primary);
        }

        #clientes-tabelas .modern-table .table-row:last-child td {
            border-bottom: none;
        }
        
        #clientes-tabelas .modern-table .btn-sm {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            padding: 0.3rem 0.8rem !important;
            font-size: 0.75rem !important;
            font-weight: 600;
        }
        
        #clientes-tabelas .modern-table .btn-sm:hover {
            background-color: var(--accent-secondary);
        }

        /* Título para cada tabela (desativado)
        .client-table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 4px solid var(--border-primary); 
            transition: border-color var(--transition-normal), color var(--transition-normal);
        }

        #tabela-clientes-ativos-wrapper.active .client-table-title {
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .client-table-title {
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .client-table-title {
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }
        */

        /* --- FIM: Melhorias na Tabela de Clientes --- */

        /* --- NOVO LAYOUT: CARDS DE MÉTRICAS (GESTÃO) --- */
        #tab-content-gestao .metric-card-dashboard {
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem !important;
            border: 1px solid var(--border-primary);
            border-left-width: 4px;
            border-radius: var(--border-radius-lg);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
            min-width: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(var(--shadow-color-rgb), 0.12);
        }

        .card-bg-icon {
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 80px;
            opacity: 0.06;
            color: var(--text-primary);
            transition: all var(--transition-slow);
            z-index: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover .card-bg-icon {
            transform: scale(1.15) rotate(-8deg);
            opacity: 0.09;
        }

        .card-content-wrapper { z-index: 1; }

        .card-title {
            font-size: 0.85rem !important;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.7rem;
        }

        .main-metric {
            font-size: 2.4rem !important;
            margin-bottom: 0.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .sub-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 0.8rem;
        }

        .sub-metric-item .sub-metric-label {
            font-size: 0.7rem !important;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .sub-metric-item .sub-metric-value {
            font-size: 1.1rem !important;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .sub-metric-item .sub-metric-percent {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 6px;
            margin-left: 0.5rem;
        }

        .card-footer {
            border-top: 1px solid var(--border-primary);
            padding-top: 0.75rem;
            margin-top: auto; /* Garante que o rodapé fique no fundo */
        }
        .card-footer .metric-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem !important;
            color: var(--text-secondary);
        }

        /* Theming de Cor por Card */
        #card-atendimentos { border-left-color: var(--brand-cyan); }
        #card-atendimentos .main-metric, #card-atendimentos .card-bg-icon { color: var(--brand-cyan); }
        #card-atendimentos:hover { border-color: var(--brand-cyan); box-shadow: 0 4px 16px rgba(var(--brand-cyan-rgb), 0.2); }

        #card-faturamento { border-left-color: var(--brand-green); }
        #card-faturamento .main-metric, #card-faturamento .card-bg-icon { color: var(--brand-green); }
        #card-faturamento:hover { border-color: var(--brand-green); box-shadow: 0 4px 16px rgba(var(--brand-green-rgb), 0.2); }
        
        #card-clientes { border-left-color: var(--brand-orange); }
        #card-clientes .main-metric, #card-clientes .card-bg-icon { color: var(--brand-orange); }
        #card-clientes:hover { border-color: var(--brand-orange); box-shadow: 0 4px 16px rgba(var(--brand-orange-rgb), 0.2); }
        
        #card-semana { border-left-color: var(--brand-magenta); }
        #card-semana .main-metric, #card-semana .card-bg-icon { color: var(--brand-magenta); }
        #card-semana:hover { border-color: var(--brand-magenta); box-shadow: 0 4px 16px rgba(var(--brand-magenta-rgb), 0.2); }
        
        #card-semana .week-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        #card-semana .week-nav button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 28px; height: 28px;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }
        #card-semana .week-nav button:hover {
            border-color: var(--brand-magenta);
            color: var(--brand-magenta);
        }
        #card-semana .week-nav .week-title {
            text-align: center;
        }
        #card-semana .week-nav .week-title h3 {
            margin-bottom: 0 !important;
        }

        /* --- FIM NOVO LAYOUT --- */


        /* === AJUSTE DE FONTES PARA TABELA DO GRÁFICO ATENDIMENTOS POR DIA DO MÊS === */
        #tab-content-gestao .chart-container-card h3 {
            font-size: 1.08rem !important;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.6rem;
        }
        #tab-content-gestao .chart-container-card table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        #tab-content-gestao .chart-container-card table.modern-table td {
            font-size: 0.97rem !important;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
        }
        #tab-content-gestao .metric-card-dashboard h3 {
            margin-bottom: 0.18rem !important;
        }
        #tab-content-gestao .metric-value-main {
            margin-bottom: 0.45rem !important;
        }
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            padding-top: 0.38rem !important;
            padding-bottom: 0.38rem !important;
            line-height: 1.15 !important;
        }
        /* Centralizar números principais nos cards de métricas da aba gestão */
        #tab-content-gestao .metric-value-main {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        /* Centralizar informações dos cards de métricas da aba gestão, exceto o título */
        #tab-content-gestao .metric-value-main,
        #tab-content-gestao .metric-sub-label,
        #tab-content-gestao .metric-sub-value,
        #tab-content-gestao .metric-comparison {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #tab-content-gestao .metric-comparison {
            justify-content: center !important;
        }
        /* Centralizar apenas o valor comparativo do rodapé dos cards de métricas da aba gestão, mantendo o label alinhado à esquerda */
        #tab-content-gestao .metric-comparison {
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto !important;
            min-height: 48px;
            text-align: initial !important;
        }
        #tab-content-gestao .metric-comparison .metric-comparison-value {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #card-semana .metric-comparison {
            font-size: 0.92rem !important;
            margin-top: auto !important;
            padding-top: 0.6rem !important;
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            min-height: 48px;
            text-align: initial !important;
        }
        /* Otimização dos controles de paginação das tabelas de clientes */
        #paginacao-clientes-ativos-div,
        #paginacao-clientes-ativos-div-top,
        #paginacao-clientes-recorrentes-div,
        #paginacao-clientes-recorrentes-div-top,
        #paginacao-clientes-atencao-div,
        #paginacao-clientes-atencao-div-top {
            padding-top: 0.35rem;
            padding-bottom: 0.35rem;
            margin-top: 0;
            margin-bottom: 0;
            gap: 0.3rem !important;
            display: flex;
            justify-content: center !important;
            align-items: center;
            width: 100%;
        }
        #paginacao-clientes-ativos-div .btn,
        #paginacao-clientes-ativos-div-top .btn,
        #paginacao-clientes-recorrentes-div .btn,
        #paginacao-clientes-recorrentes-div-top .btn,
        #paginacao-clientes-atencao-div .btn,
        #paginacao-clientes-atencao-div-top .btn {
            padding: 0.2rem 0.7rem !important;
            font-size: 0.85rem !important;
            min-width: 60px;
            height: 28px;
        }
        #paginacao-clientes-ativos-div span,
        #paginacao-clientes-ativos-div-top span,
        #paginacao-clientes-recorrentes-div span,
        #paginacao-clientes-recorrentes-div-top span,
        #paginacao-clientes-atencao-div span,
        #paginacao-clientes-atencao-div-top span {
            font-size: 0.85rem !important;
            padding: 0 0.2rem;
        }
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper .chart-container-card,
        #tabela-clientes-recorrentes-wrapper .chart-container-card,
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table td,
        #tabela-clientes-ativos-wrapper table.modern-table th,
        #tabela-clientes-recorrentes-wrapper table.modern-table td,
        #tabela-clientes-recorrentes-wrapper table.modern-table th,
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            font-size: 0.97rem !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table thead th,
        #tabela-clientes-recorrentes-wrapper table.modern-table thead th,
        #tabela-clientes-atencao-wrapper table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-on-accent);
            background: var(--brand-dark-blue);
        }
        /* --- NOVO: Estilo do select para parecer parte do título --- */
        .db-title-select, .db-title-label {
            background: transparent;
            color: #ccff33;
            font-family: 'Inter', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            border: none;
            outline: none;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: none;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            white-space: nowrap;
        }
        .db-title-select:focus, .db-title-select:hover {
            background: var(--bg-tertiary);
        }
        .db-title-select option {
            color: #ccff33;
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }
        .db-title-label {
            cursor: default;
            color: #ccff33 !important;
        }
        @media (max-width: 768px) {
            .db-title-select, .db-title-label {
                font-size: 1rem;
                padding: 0 0.3rem;
            }
        }

        /* --- NOVO: Melhorias na Tabela de Clientes --- */
        #clientes-tabelas .chart-container-card {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0 !important;
            margin-top: 1rem !important;
        }

        #clientes-tabelas .modern-table {
            border-spacing: 0;
            text-align: left;
        }

        #clientes-tabelas .modern-table thead th {
            background: var(--brand-dark-blue);
            color: var(--text-on-accent);
            font-size: 0.8rem !important;
            padding: 0.75rem 1rem !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid var(--border-primary); /* Cor padrão */
            transition: border-color var(--transition-normal);
        }
        
        /* --- Cores dinâmicas para o cabeçalho da tabela --- */
        #tabela-clientes-ativos-wrapper.active .modern-table thead th {
            border-bottom-color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .modern-table thead th {
            border-bottom-color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .modern-table thead th {
            border-bottom-color: var(--warning-color);
        }

        #clientes-tabelas .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #clientes-tabelas .modern-table tbody tr:hover {
            background-color: rgba(var(--brand-cyan-rgb), 0.08);
        }

        #clientes-tabelas .modern-table tbody td {
            padding: 1rem 1rem !important;
            font-size: 0.9rem !important;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-primary);
        }

        #clientes-tabelas .modern-table tbody td:first-child {
            font-weight: 500;
            color: var(--text-primary);
        }

        #clientes-tabelas .modern-table .table-row:last-child td {
            border-bottom: none;
        }
        
        #clientes-tabelas .modern-table .btn-sm {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            padding: 0.3rem 0.8rem !important;
            font-size: 0.75rem !important;
            font-weight: 600;
        }
        
        #clientes-tabelas .modern-table .btn-sm:hover {
            background-color: var(--accent-secondary);
        }

        /* Título para cada tabela (desativado)
        .client-table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 4px solid var(--border-primary); 
            transition: border-color var(--transition-normal), color var(--transition-normal);
        }

        #tabela-clientes-ativos-wrapper.active .client-table-title {
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .client-table-title {
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .client-table-title {
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }
        */

        /* --- FIM: Melhorias na Tabela de Clientes --- */

        /* --- NOVO LAYOUT: CARDS DE MÉTRICAS (GESTÃO) --- */
        #tab-content-gestao .metric-card-dashboard {
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem !important;
            border: 1px solid var(--border-primary);
            border-left-width: 4px;
            border-radius: var(--border-radius-lg);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
            min-width: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(var(--shadow-color-rgb), 0.12);
        }

        .card-bg-icon {
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 80px;
            opacity: 0.06;
            color: var(--text-primary);
            transition: all var(--transition-slow);
            z-index: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover .card-bg-icon {
            transform: scale(1.15) rotate(-8deg);
            opacity: 0.09;
        }

        .card-content-wrapper { z-index: 1; }

        .card-title {
            font-size: 0.85rem !important;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.7rem;
        }

        .main-metric {
            font-size: 2.4rem !important;
            margin-bottom: 0.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .sub-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 0.8rem;
        }

        .sub-metric-item .sub-metric-label {
            font-size: 0.7rem !important;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .sub-metric-item .sub-metric-value {
            font-size: 1.1rem !important;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .sub-metric-item .sub-metric-percent {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 6px;
            margin-left: 0.5rem;
        }

        .card-footer {
            border-top: 1px solid var(--border-primary);
            padding-top: 0.75rem;
            margin-top: auto; /* Garante que o rodapé fique no fundo */
        }
        .card-footer .metric-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem !important;
            color: var(--text-secondary);
        }

        /* Theming de Cor por Card */
        #card-atendimentos { border-left-color: var(--brand-cyan); }
        #card-atendimentos .main-metric, #card-atendimentos .card-bg-icon { color: var(--brand-cyan); }
        #card-atendimentos:hover { border-color: var(--brand-cyan); box-shadow: 0 4px 16px rgba(var(--brand-cyan-rgb), 0.2); }

        #card-faturamento { border-left-color: var(--brand-green); }
        #card-faturamento .main-metric, #card-faturamento .card-bg-icon { color: var(--brand-green); }
        #card-faturamento:hover { border-color: var(--brand-green); box-shadow: 0 4px 16px rgba(var(--brand-green-rgb), 0.2); }
        
        #card-clientes { border-left-color: var(--brand-orange); }
        #card-clientes .main-metric, #card-clientes .card-bg-icon { color: var(--brand-orange); }
        #card-clientes:hover { border-color: var(--brand-orange); box-shadow: 0 4px 16px rgba(var(--brand-orange-rgb), 0.2); }
        
        #card-semana { border-left-color: var(--brand-magenta); }
        #card-semana .main-metric, #card-semana .card-bg-icon { color: var(--brand-magenta); }
        #card-semana:hover { border-color: var(--brand-magenta); box-shadow: 0 4px 16px rgba(var(--brand-magenta-rgb), 0.2); }
        
        #card-semana .week-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        #card-semana .week-nav button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 28px; height: 28px;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }
        #card-semana .week-nav button:hover {
            border-color: var(--brand-magenta);
            color: var(--brand-magenta);
        }
        #card-semana .week-nav .week-title {
            text-align: center;
        }
        #card-semana .week-nav .week-title h3 {
            margin-bottom: 0 !important;
        }

        /* --- FIM NOVO LAYOUT --- */


        /* === AJUSTE DE FONTES PARA TABELA DO GRÁFICO ATENDIMENTOS POR DIA DO MÊS === */
        #tab-content-gestao .chart-container-card h3 {
            font-size: 1.08rem !important;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.6rem;
        }
        #tab-content-gestao .chart-container-card table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        #tab-content-gestao .chart-container-card table.modern-table td {
            font-size: 0.97rem !important;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
        }
        #tab-content-gestao .metric-card-dashboard h3 {
            margin-bottom: 0.18rem !important;
        }
        #tab-content-gestao .metric-value-main {
            margin-bottom: 0.45rem !important;
        }
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            padding-top: 0.38rem !important;
            padding-bottom: 0.38rem !important;
            line-height: 1.15 !important;
        }
        /* Centralizar números principais nos cards de métricas da aba gestão */
        #tab-content-gestao .metric-value-main {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        /* Centralizar informações dos cards de métricas da aba gestão, exceto o título */
        #tab-content-gestao .metric-value-main,
        #tab-content-gestao .metric-sub-label,
        #tab-content-gestao .metric-sub-value,
        #tab-content-gestao .metric-comparison {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #tab-content-gestao .metric-comparison {
            justify-content: center !important;
        }
        /* Centralizar apenas o valor comparativo do rodapé dos cards de métricas da aba gestão, mantendo o label alinhado à esquerda */
        #tab-content-gestao .metric-comparison {
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto !important;
            min-height: 48px;
            text-align: initial !important;
        }
        #tab-content-gestao .metric-comparison .metric-comparison-value {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #card-semana .metric-comparison {
            font-size: 0.92rem !important;
            margin-top: auto !important;
            padding-top: 0.6rem !important;
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            min-height: 48px;
            text-align: initial !important;
        }
        /* Otimização dos controles de paginação das tabelas de clientes */
        #paginacao-clientes-ativos-div,
        #paginacao-clientes-ativos-div-top,
        #paginacao-clientes-recorrentes-div,
        #paginacao-clientes-recorrentes-div-top,
        #paginacao-clientes-atencao-div,
        #paginacao-clientes-atencao-div-top {
            padding-top: 0.35rem;
            padding-bottom: 0.35rem;
            margin-top: 0;
            margin-bottom: 0;
            gap: 0.3rem !important;
            display: flex;
            justify-content: center !important;
            align-items: center;
            width: 100%;
        }
        #paginacao-clientes-ativos-div .btn,
        #paginacao-clientes-ativos-div-top .btn,
        #paginacao-clientes-recorrentes-div .btn,
        #paginacao-clientes-recorrentes-div-top .btn,
        #paginacao-clientes-atencao-div .btn,
        #paginacao-clientes-atencao-div-top .btn {
            padding: 0.2rem 0.7rem !important;
            font-size: 0.85rem !important;
            min-width: 60px;
            height: 28px;
        }
        #paginacao-clientes-ativos-div span,
        #paginacao-clientes-ativos-div-top span,
        #paginacao-clientes-recorrentes-div span,
        #paginacao-clientes-recorrentes-div-top span,
        #paginacao-clientes-atencao-div span,
        #paginacao-clientes-atencao-div-top span {
            font-size: 0.85rem !important;
            padding: 0 0.2rem;
        }
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper .chart-container-card,
        #tabela-clientes-recorrentes-wrapper .chart-container-card,
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table td,
        #tabela-clientes-ativos-wrapper table.modern-table th,
        #tabela-clientes-recorrentes-wrapper table.modern-table td,
        #tabela-clientes-recorrentes-wrapper table.modern-table th,
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            font-size: 0.97rem !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table thead th,
        #tabela-clientes-recorrentes-wrapper table.modern-table thead th,
        #tabela-clientes-atencao-wrapper table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-on-accent);
            background: var(--brand-dark-blue);
        }
        /* --- NOVO: Estilo do select para parecer parte do título --- */
        .db-title-select, .db-title-label {
            background: transparent;
            color: #ccff33;
            font-family: 'Inter', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            border: none;
            outline: none;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: none;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            white-space: nowrap;
        }
        .db-title-select:focus, .db-title-select:hover {
            background: var(--bg-tertiary);
        }
        .db-title-select option {
            color: #ccff33;
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }
        .db-title-label {
            cursor: default;
            color: #ccff33 !important;
        }
        @media (max-width: 768px) {
            .db-title-select, .db-title-label {
                font-size: 1rem;
                padding: 0 0.3rem;
            }
        }

        /* --- NOVO: Melhorias na Tabela de Clientes --- */
        #clientes-tabelas .chart-container-card {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0 !important;
            margin-top: 1rem !important;
        }

        #clientes-tabelas .modern-table {
            border-spacing: 0;
            text-align: left;
        }

        #clientes-tabelas .modern-table thead th {
            background: var(--brand-dark-blue);
            color: var(--text-on-accent);
            font-size: 0.8rem !important;
            padding: 0.75rem 1rem !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid var(--border-primary); /* Cor padrão */
            transition: border-color var(--transition-normal);
        }
        
        /* --- Cores dinâmicas para o cabeçalho da tabela --- */
        #tabela-clientes-ativos-wrapper.active .modern-table thead th {
            border-bottom-color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .modern-table thead th {
            border-bottom-color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .modern-table thead th {
            border-bottom-color: var(--warning-color);
        }

        #clientes-tabelas .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #clientes-tabelas .modern-table tbody tr:hover {
            background-color: rgba(var(--brand-cyan-rgb), 0.08);
        }

        #clientes-tabelas .modern-table tbody td {
            padding: 1rem 1rem !important;
            font-size: 0.9rem !important;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-primary);
        }

        #clientes-tabelas .modern-table tbody td:first-child {
            font-weight: 500;
            color: var(--text-primary);
        }

        #clientes-tabelas .modern-table .table-row:last-child td {
            border-bottom: none;
        }
        
        #clientes-tabelas .modern-table .btn-sm {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            padding: 0.3rem 0.8rem !important;
            font-size: 0.75rem !important;
            font-weight: 600;
        }
        
        #clientes-tabelas .modern-table .btn-sm:hover {
            background-color: var(--accent-secondary);
        }

        /* Título para cada tabela (desativado)
        .client-table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 4px solid var(--border-primary); 
            transition: border-color var(--transition-normal), color var(--transition-normal);
        }

        #tabela-clientes-ativos-wrapper.active .client-table-title {
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .client-table-title {
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .client-table-title {
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }
        */

        /* --- FIM: Melhorias na Tabela de Clientes --- */

        /* --- NOVO LAYOUT: CARDS DE MÉTRICAS (GESTÃO) --- */
        #tab-content-gestao .metric-card-dashboard {
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem !important;
            border: 1px solid var(--border-primary);
            border-left-width: 4px;
            border-radius: var(--border-radius-lg);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
            min-width: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(var(--shadow-color-rgb), 0.12);
        }

        .card-bg-icon {
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 80px;
            opacity: 0.06;
            color: var(--text-primary);
            transition: all var(--transition-slow);
            z-index: 0;
        }
        #tab-content-gestao .metric-card-dashboard:hover .card-bg-icon {
            transform: scale(1.15) rotate(-8deg);
            opacity: 0.09;
        }

        .card-content-wrapper { z-index: 1; }

        .card-title {
            font-size: 0.85rem !important;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.7rem;
        }

        .main-metric {
            font-size: 2.4rem !important;
            margin-bottom: 0.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .sub-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 0.8rem;
        }

        .sub-metric-item .sub-metric-label {
            font-size: 0.7rem !important;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .sub-metric-item .sub-metric-value {
            font-size: 1.1rem !important;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .sub-metric-item .sub-metric-percent {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 6px;
            margin-left: 0.5rem;
        }

        .card-footer {
            border-top: 1px solid var(--border-primary);
            padding-top: 0.75rem;
            margin-top: auto; /* Garante que o rodapé fique no fundo */
        }
        .card-footer .metric-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem !important;
            color: var(--text-secondary);
        }

        /* Theming de Cor por Card */
        #card-atendimentos { border-left-color: var(--brand-cyan); }
        #card-atendimentos .main-metric, #card-atendimentos .card-bg-icon { color: var(--brand-cyan); }
        #card-atendimentos:hover { border-color: var(--brand-cyan); box-shadow: 0 4px 16px rgba(var(--brand-cyan-rgb), 0.2); }

        #card-faturamento { border-left-color: var(--brand-green); }
        #card-faturamento .main-metric, #card-faturamento .card-bg-icon { color: var(--brand-green); }
        #card-faturamento:hover { border-color: var(--brand-green); box-shadow: 0 4px 16px rgba(var(--brand-green-rgb), 0.2); }
        
        #card-clientes { border-left-color: var(--brand-orange); }
        #card-clientes .main-metric, #card-clientes .card-bg-icon { color: var(--brand-orange); }
        #card-clientes:hover { border-color: var(--brand-orange); box-shadow: 0 4px 16px rgba(var(--brand-orange-rgb), 0.2); }
        
        #card-semana { border-left-color: var(--brand-magenta); }
        #card-semana .main-metric, #card-semana .card-bg-icon { color: var(--brand-magenta); }
        #card-semana:hover { border-color: var(--brand-magenta); box-shadow: 0 4px 16px rgba(var(--brand-magenta-rgb), 0.2); }
        
        #card-semana .week-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        #card-semana .week-nav button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 28px; height: 28px;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }
        #card-semana .week-nav button:hover {
            border-color: var(--brand-magenta);
            color: var(--brand-magenta);
        }
        #card-semana .week-nav .week-title {
            text-align: center;
        }
        #card-semana .week-nav .week-title h3 {
            margin-bottom: 0 !important;
        }

        /* --- FIM NOVO LAYOUT --- */


        /* === AJUSTE DE FONTES PARA TABELA DO GRÁFICO ATENDIMENTOS POR DIA DO MÊS === */
        #tab-content-gestao .chart-container-card h3 {
            font-size: 1.08rem !important;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.6rem;
        }
        #tab-content-gestao .chart-container-card table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        #tab-content-gestao .chart-container-card table.modern-table td {
            font-size: 0.97rem !important;
            color: var(--text-primary);
            padding: 0.7rem 1rem;
        }
        #tab-content-gestao .metric-card-dashboard h3 {
            margin-bottom: 0.18rem !important;
        }
        #tab-content-gestao .metric-value-main {
            margin-bottom: 0.45rem !important;
        }
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            padding-top: 0.38rem !important;
            padding-bottom: 0.38rem !important;
            line-height: 1.15 !important;
        }
        /* Centralizar números principais nos cards de métricas da aba gestão */
        #tab-content-gestao .metric-value-main {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        /* Centralizar informações dos cards de métricas da aba gestão, exceto o título */
        #tab-content-gestao .metric-value-main,
        #tab-content-gestao .metric-sub-label,
        #tab-content-gestao .metric-sub-value,
        #tab-content-gestao .metric-comparison {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #tab-content-gestao .metric-comparison {
            justify-content: center !important;
        }
        /* Centralizar apenas o valor comparativo do rodapé dos cards de métricas da aba gestão, mantendo o label alinhado à esquerda */
        #tab-content-gestao .metric-comparison {
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto !important;
            min-height: 48px;
            text-align: initial !important;
        }
        #tab-content-gestao .metric-comparison .metric-comparison-value {
            text-align: center !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        #card-semana .metric-comparison {
            font-size: 0.92rem !important;
            margin-top: auto !important;
            padding-top: 0.6rem !important;
            display: flex !important;
            flex-direction: row;
            align-items: flex-end;
            justify-content: space-between;
            min-height: 48px;
            text-align: initial !important;
        }
        /* Otimização dos controles de paginação das tabelas de clientes */
        #paginacao-clientes-ativos-div,
        #paginacao-clientes-ativos-div-top,
        #paginacao-clientes-recorrentes-div,
        #paginacao-clientes-recorrentes-div-top,
        #paginacao-clientes-atencao-div,
        #paginacao-clientes-atencao-div-top {
            padding-top: 0.35rem;
            padding-bottom: 0.35rem;
            margin-top: 0;
            margin-bottom: 0;
            gap: 0.3rem !important;
            display: flex;
            justify-content: center !important;
            align-items: center;
            width: 100%;
        }
        #paginacao-clientes-ativos-div .btn,
        #paginacao-clientes-ativos-div-top .btn,
        #paginacao-clientes-recorrentes-div .btn,
        #paginacao-clientes-recorrentes-div-top .btn,
        #paginacao-clientes-atencao-div .btn,
        #paginacao-clientes-atencao-div-top .btn {
            padding: 0.2rem 0.7rem !important;
            font-size: 0.85rem !important;
            min-width: 60px;
            height: 28px;
        }
        #paginacao-clientes-ativos-div span,
        #paginacao-clientes-ativos-div-top span,
        #paginacao-clientes-recorrentes-div span,
        #paginacao-clientes-recorrentes-div-top span,
        #paginacao-clientes-atencao-div span,
        #paginacao-clientes-atencao-div-top span {
            font-size: 0.85rem !important;
            padding: 0 0.2rem;
        }
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper .chart-container-card,
        #tabela-clientes-recorrentes-wrapper .chart-container-card,
        #tabela-clientes-atencao-wrapper .chart-container-card {
            margin-top: 0.2rem !important;
            padding-top: 0 !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table td,
        #tabela-clientes-ativos-wrapper table.modern-table th,
        #tabela-clientes-recorrentes-wrapper table.modern-table td,
        #tabela-clientes-recorrentes-wrapper table.modern-table th,
        #tabela-clientes-atencao-wrapper table.modern-table td,
        #tabela-clientes-atencao-wrapper table.modern-table th {
            font-size: 0.97rem !important;
        }
        #tabela-clientes-ativos-wrapper table.modern-table thead th,
        #tabela-clientes-recorrentes-wrapper table.modern-table thead th,
        #tabela-clientes-atencao-wrapper table.modern-table thead th {
            font-size: 1.01rem !important;
            font-weight: 600;
            color: var(--text-on-accent);
            background: var(--brand-dark-blue);
        }
        /* --- NOVO: Estilo do select para parecer parte do título --- */
        .db-title-select, .db-title-label {
            background: transparent;
            color: #ccff33;
            font-family: 'Inter', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            border: none;
            outline: none;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: none;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            white-space: nowrap;
        }
        .db-title-select:focus, .db-title-select:hover {
            background: var(--bg-tertiary);
        }
        .db-title-select option {
            color: #ccff33;
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }
        .db-title-label {
            cursor: default;
            color: #ccff33 !important;
        }
        @media (max-width: 768px) {
            .db-title-select, .db-title-label {
                font-size: 1rem;
                padding: 0 0.3rem;
            }
        }

        /* --- NOVO: Melhorias na Tabela de Clientes --- */
        #clientes-tabelas .chart-container-card {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0 !important;
            margin-top: 1rem !important;
        }

        #clientes-tabelas .modern-table {
            border-spacing: 0;
            text-align: left;
        }

        #clientes-tabelas .modern-table thead th {
            background: var(--brand-dark-blue);
            color: var(--text-on-accent);
            font-size: 0.8rem !important;
            padding: 0.75rem 1rem !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid var(--border-primary); /* Cor padrão */
            transition: border-color var(--transition-normal);
        }
        
        /* --- Cores dinâmicas para o cabeçalho da tabela --- */
        #tabela-clientes-ativos-wrapper.active .modern-table thead th {
            border-bottom-color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .modern-table thead th {
            border-bottom-color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .modern-table thead th {
            border-bottom-color: var(--warning-color);
        }

        #clientes-tabelas .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #clientes-tabelas .modern-table tbody tr:hover {
            background-color: rgba(var(--brand-cyan-rgb), 0.08);
        }

        #clientes-tabelas .modern-table tbody td {
            padding: 1rem 1rem !important;
            font-size: 0.9rem !important;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-primary);
        }

        #clientes-tabelas .modern-table tbody td:first-child {
            font-weight: 500;
            color: var(--text-primary);
        }

        #clientes-tabelas .modern-table .table-row:last-child td {
            border-bottom: none;
        }
        
        #clientes-tabelas .modern-table .btn-sm {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            padding: 0.3rem 0.8rem !important;
            font-size: 0.75rem !important;
            font-weight: 600;
        }
        
        #clientes-tabelas .modern-table .btn-sm:hover {
            background-color: var(--accent-secondary);
        }

        /* Título para cada tabela (desativado)
        .client-table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 4px solid var(--border-primary); 
            transition: border-color var(--transition-normal), color var(--transition-normal);
        }

        #tabela-clientes-ativos-wrapper.active .client-table-title {
            border-left-color: var(--info-color);
            color: var(--info-color);
        }
        #tabela-clientes-recorrentes-wrapper.active .client-table-title {
            border-left-color: var(--success-color);
            color: var(--success-color);
        }
        #tabela-clientes-atencao-wrapper.active .client-table-title {
            border-left-color: var(--warning-color);
            color: var(--warning-color);
        }
        */

        /* --- FIM: Melhorias na Tabela de Clientes --- */

        /* --- Ajuste visual para selects de filtro de mês/ano --- */
        #monthFilter, #yearFilter {
            min-width: 90px;
            font-weight: 700;
            color: var(--accent-primary);
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.25rem;
            padding: 0 0.3rem;
            margin-left: 0.2rem;
            margin-right: 0.2rem;
            transition: color 0.2s, background 0.2s;
        }
        #monthFilter:focus, #yearFilter:focus, #monthFilter:hover, #yearFilter:hover {
            background: var(--bg-tertiary);
            color: var(--accent-secondary);
        }
        #monthFilter option, #yearFilter option {
            color: var(--text-primary);
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }
        #tab-content-gestao .metric-card-dashboard {
            /* ...outros estilos... */
            padding: 0.75rem 0.6rem !important;
            min-height: 0;
        }
        .main-metric {
            font-size: 1.85rem !important;
            margin-bottom: 0.6rem;
        }
        .card-title {
            margin-bottom: 0.5rem;
        }
        .sub-metrics-grid {
            margin-bottom: 0.5rem;
        }
        .card-footer {
            padding-top: 0.5rem;
        }
        #tab-content-gestao .metric-card-dashboard {
            padding: 0.55rem 0.5rem !important;
        }
        .main-metric {
            font-size: 1.6rem !important;
            margin-bottom: 0.35rem;
        }
        .card-title {
            margin-bottom: 0.3rem;
        }
        .sub-metrics-grid {
            margin-bottom: 0.25rem;
        }
        .card-footer {
            padding-top: 0.25rem;
        }
        #tab-content-gestao .metric-card-dashboard {
            padding: 0.55rem 0.5rem !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .card-title {
            margin-bottom: 0.3rem;
            font-size: 1rem !important;
        }
        .main-metric {
            font-size: 1.85rem !important;
            margin-bottom: 0.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }
        .sub-metrics-grid {
            margin-bottom: 0.25rem;
            justify-items: center;
        }
        .sub-metric-item .sub-metric-label {
            font-size: 0.85rem !important;
        }
        .sub-metric-item .sub-metric-value {
            font-size: 1.15rem !important;
            font-weight: 600;
        }
        .sub-metric-item .sub-metric-percent {
            font-size: 0.8rem;
        }
        .card-footer {
            padding-top: 0.25rem;
            width: 100%;
        }
        .card-footer .metric-comparison {
            justify-content: center !important;
            font-size: 0.95rem !important;
        }
        #tab-content-gestao .metric-card-dashboard {
            padding: 1.1rem 1rem !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .card-title {
            margin-bottom: 0.5rem;
        }
        .main-metric {
            margin-bottom: 0.7rem;
        }
        .sub-metrics-grid {
            margin-bottom: 0.5rem;
        }
        .card-footer {
            padding-top: 0.5rem;
        }
        /* Percentual acima das colunas do gráfico de atendimentos por dia */
        #tab-content-gestao .chart-container-card .chartjs-datalabel {
            font-size: 1.15rem !important;
            font-weight: 700;
            color: var(--accent-primary) !important;
        }
    </style>
</head>
<body class="dark">
    <!-- LOGIN CONTAINER (inspirado no login-dash.html) -->
    <div id="login-container" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-primary); position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999;">
      <div class="login-container" style="background: var(--bg-secondary); padding: 40px 30px; border-radius: 20px; box-shadow: var(--shadow-lg); max-width: 360px; width: 100%; border: 1px solid var(--border-primary);">
        <h2 style="color: var(--text-primary); text-align: center; margin-bottom: 40px; font-size: 32px; font-weight: 600; letter-spacing: 1px;">
          <img src="https://iili.io/3IVuaEb.png" alt="Logo" style="max-width: 60%; height: auto; display: block; margin: 0 auto;">
        </h2>
        <form id="loginForm">
          <div class="input-group" style="margin-bottom: 25px;">
            <label for="email" style="color: var(--text-primary); display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; opacity: 0.9;">E-mail</label>
            <input type="email" id="loginEmail" name="email" placeholder="Digite seu e-mail" required style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-secondary); border-radius: var(--border-radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px;">
          </div>
          <div class="input-group" style="margin-bottom: 25px;">
            <label for="password" style="color: var(--text-primary); display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; opacity: 0.9;">Senha</label>
            <input type="password" id="loginPassword" name="password" placeholder="Digite sua senha" required style="width: 100%; padding: 14px 16px; border: 1px solid var(--border-secondary); border-radius: var(--border-radius); background: var(--bg-tertiary); color: var(--text-primary); font-size: 16px;">
          </div>
          <button type="submit" id="loginButton" style="width: 100%; padding: 14px; border: none; border-radius: var(--border-radius); background: var(--accent-primary); color: var(--text-on-accent); font-size: 16px; font-weight: 600; cursor: pointer;">Entrar</button>
          <div class="error-message" id="loginErrorMessage" style="color: var(--danger-color); text-align: center; margin-top: 20px; font-size: 14px; display: none; font-weight: 500;"></div>
        </form>
      </div>
    </div>

    <!-- DASHBOARD CONTAINER (restante do HTML) -->
    <div id="dashboard-container" style="display: none;">
        <div class="app-container">
            <!-- O conteúdo principal agora ocupa toda a largura disponível -->
            <div class="main-content">
                <div class="header">
                    <div class="header-main flex items-center gap-2">
                        <h1 class="header-title">Dashboard</h1>
                        <select id="dbSelect" class="db-title-select ml-2 focus:outline-none">
                            <!-- Opções serão preenchidas via JS -->
                        </select>
                    </div>
                    <div class="header-center flex-grow">
                        <div class="flex items-center gap-2 bg-tertiary rounded-md px-3 py-1 shadow-sm border border-border-primary">
                            <label class="text-xs font-semibold text-text-secondary">Mês</label>
                            <select id="monthFilter" class="db-title-select ml-2 focus:outline-none">
                                <option value="">Todos</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <label class="text-xs font-semibold text-text-secondary ml-3">Ano</label>
                            <select id="yearFilter" class="db-title-select ml-2 focus:outline-none">
                                <option value="">Todos</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                    <div class="header-right">
                        <button id="uploadBtn" class="btn btn-sm btn-outline btn-icon-only" title="Upload XLSX">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button id="refreshBtn" class="btn btn-sm btn-outline btn-icon-only" title="Atualizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="themeToggle" class="btn btn-sm btn-outline btn-icon-only theme-toggle-btn" title="Alternar tema claro/escuro">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </button>
                        <!-- Botão de Configuração -->
                        <button id="configBtn" class="btn btn-sm btn-outline btn-icon-only" title="Configurações">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="logoutBtn" class="btn btn-sm btn-danger" title="Sair">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>

                <!-- Dashboard Content Area -->
                <div class="dashboard-container">
                    <!-- Tab Navigation for Gestão / Clientes -->
                    <div class="w-full mb-6">
                        <div class="tab-navigation">
                            <button class="tab-filter active" data-tab="gestao">
                                <i class="fas fa-chart-line tab-icon"></i> Gestão
                            </button>
                            <button class="tab-filter" data-tab="clientes">
                                <i class="fas fa-users tab-icon"></i> Clientes
                            </button>
                            <div class="tab-indicator"></div>
                        </div>
                    </div>

                    <!-- Gestão Tab Content -->
                    <div id="tab-content-gestao" class="tab-content-section">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-5 xl:gap-6 mb-6 md:mb-8">
                            <!-- Card: Atendimentos -->
                            <div class="metric-card-dashboard" id="card-atendimentos">
                                <i class="fas fa-calendar-check card-bg-icon"></i>
                                <div class="card-content-wrapper">
                                    <div>
                                        <h3 class="card-title">Atendimentos no Mês</h3>
                                        <p class="main-metric" id="metric-atendimentos-mes">-</p>
                                        <div class="sub-metrics-grid">
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Média/Dia</p>
                                                <p class="sub-metric-value" id="metric-media-dia">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Pré-Agendados</p>
                                                <p class="sub-metric-value" id="metric-pre-agendados">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Comercial</p>
                                                <div class="flex items-baseline">
                                                    <p class="sub-metric-value" id="metric-atendimentos-comercial">-</p>
                                                    <span class="sub-metric-percent" id="percentual-comercial">-%</span>
                                                </div>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Residencial</p>
                                                <div class="flex items-baseline">
                                                    <p class="sub-metric-value" id="metric-atendimentos-residencial">-</p>
                                                    <span class="sub-metric-percent" id="percentual-residencial">-%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="metric-comparison" id="atendimento-crescimento">
                                            <span>vs. Ano Anterior</span>
                                            <span><i class="fas fa-equals"></i> 0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Faturamento -->
                            <div class="metric-card-dashboard" id="card-faturamento">
                                <i class="fas fa-dollar-sign card-bg-icon"></i>
                                <div class="card-content-wrapper">
                                    <div>
                                        <h3 class="card-title">Faturamento do Mês</h3>
                                        <p class="main-metric" id="metric-faturamento-mes">-</p>
                                        <div class="sub-metrics-grid">
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Média/Atend.</p>
                                                <p class="sub-metric-value" id="metric-valor-medio">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Média/Repasse</p>
                                                <p class="sub-metric-value" id="metric-media-repasse">-</p>
                                            </div>
                                            <div class="sub-metric-item" style="grid-column: span 2;">
                                                <p class="sub-metric-label">Margem Média/Atend.</p>
                                                <p class="sub-metric-value" id="metric-valor-medio-atendimento-margem">-</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="metric-comparison" id="faturamento-crescimento">
                                            <span>vs. Ano Anterior</span>
                                            <span><i class="fas fa-equals"></i> 0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Clientes -->
                            <div class="metric-card-dashboard" id="card-clientes">
                                <i class="fas fa-users card-bg-icon"></i>
                                <div class="card-content-wrapper">
                                    <div>
                                        <h3 class="card-title">Clientes no Mês</h3>
                                        <p class="main-metric" id="metric-clientes">-</p>
                                        <div class="sub-metrics-grid">
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Atend./Cliente</p>
                                                <p class="sub-metric-value" id="metric-atendimento-medio">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Recorrentes</p>
                                                <p class="sub-metric-value" id="metric-clientes-recorrentes-card">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Outros</p>
                                                <p class="sub-metric-value" id="metric-clientes-outros">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Churn</p>
                                                <p class="sub-metric-value" id="metric-churn">-%</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="metric-comparison" id="clientes-crescimento">
                                            <span>vs. Ano Anterior</span>
                                            <span><i class="fas fa-equals"></i> 0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card: Atendimentos da Semana -->
                            <div class="metric-card-dashboard" id="card-semana">
                                <i class="fas fa-calendar-week card-bg-icon"></i>
                                <div class="card-content-wrapper">
                                    <div>
                                        <div class="week-nav">
                                            <button id="btn-semana-anterior" title="Semana anterior"><i class="fas fa-chevron-left"></i></button>
                                            <div class="week-title">
                                                <h3 class="card-title">Semana</h3>
                                                <span id="semana-intervalo" class="text-xs text-text-secondary"></span>
                                            </div>
                                            <button id="btn-semana-proxima" title="Próxima semana"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                        <p class="main-metric" id="metric-atendimentos-semana">-</p>
                                        <div class="sub-metrics-grid">
                                             <div class="sub-metric-item">
                                                <p class="sub-metric-label">Faturamento</p>
                                                <p class="sub-metric-value" id="metric-faturamento-semana">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Clientes</p>
                                                <p class="sub-metric-value" id="metric-clientes-semana">-</p>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Comercial</p>
                                                 <div class="flex items-baseline">
                                                    <p class="sub-metric-value" id="metric-atendimentos-semana-comercial">-</p>
                                                    <span class="sub-metric-percent" id="percentual-semana-comercial">-%</span>
                                                </div>
                                            </div>
                                            <div class="sub-metric-item">
                                                <p class="sub-metric-label">Residencial</p>
                                                 <div class="flex items-baseline">
                                                    <p class="sub-metric-value" id="metric-atendimentos-semana-residencial">-</p>
                                                    <span class="sub-metric-percent" id="percentual-semana-residencial">-%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="metric-comparison" id="atendimento-semana-crescimento">
                                            <span>vs. Semana Anterior</span>
                                            <span><i class="fas fa-equals"></i> 0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráfico de Atendimentos por Dia -->
                        <div class="chart-container-card">
                            <div class="flex justify-between items-center mb-4">
                                <h3>Atendimentos por Dia do Mês</h3>
                                <div id="grafico-atendimentos-dia-legend" class="flex items-center gap-4"></div>
                            </div>
                            <canvas id="grafico-atendimentos-dia"></canvas>
                        </div>
                    </div>

                    <!-- Clientes Tab Content -->
                    <div id="tab-content-clientes" class="tab-content-section hidden">
                        <!-- Métricas Gerais de Clientes -->
                        <div id="client-filter-cards">
                            <button class="client-filter-card" data-filter="total" id="btn-clientes-total" type="button">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="filter-card-label">Total</div>
                                        <div class="filter-card-value" id="metric-total-clientes">-</div>
                                    </div>
                                    <div class="filter-card-icon-wrapper">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </button>
                            <button class="client-filter-card" data-filter="recorrentes" id="btn-clientes-recorrentes" type="button">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="filter-card-label">Recorrentes</div>
                                        <div class="filter-card-value" id="metric-clientes-recorrentes">-</div>
                                    </div>
                                    <div class="filter-card-icon-wrapper">
                                        <i class="fas fa-redo"></i>
                                    </div>
                                </div>
                            </button>
                            <button class="client-filter-card" data-filter="atencao" id="btn-clientes-atencao" type="button">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="filter-card-label">Atenção</div>
                                        <div class="filter-card-value" id="metric-clientes-atencao">-</div>
                                    </div>
                                    <div class="filter-card-icon-wrapper">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                            </button>
                            <div class="client-filter-card" id="btn-clientes-outros">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="filter-card-label">Outros</div>
                                        <div class="filter-card-value" id="metric-clientes-outros-card">-</div>
                                    </div>
                                    <div class="filter-card-icon-wrapper">
                                        <i class="fas fa-user-minus"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tabelas de Clientes -->
                        <div id="clientes-tabelas">
                            <div id="tabela-clientes-ativos-wrapper" class="clientes-tabela-section">
                                <div class="chart-container-card">
                                    <!-- <h3 class="client-table-title">Clientes Ativos</h3> -->
                                    <div id="paginacao-clientes-ativos-div-top"></div>
                                    <div class="overflow-x-auto rounded-lg">
                                        <table class="modern-table">
                                            <thead id="thead-clientes-ativos">
                                                <!-- Cabeçalho será preenchido via JS -->
                                            </thead>
                                            <tbody id="tabela-clientes-ativos">
                                                <tr><td colspan="7" class="text-center text-text-secondary py-8">Carregando clientes ativos...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div id="tabela-clientes-recorrentes-wrapper" class="clientes-tabela-section hidden">
                                <div class="chart-container-card">
                                    <!-- <h3 class="client-table-title">Clientes Recorrentes</h3> -->
                                    <div id="paginacao-clientes-recorrentes-div-top"></div>
                                    <div class="overflow-x-auto rounded-lg">
                                        <table class="modern-table">
                                            <thead id="thead-clientes-recorrentes">
                                                <!-- Cabeçalho será preenchido via JS -->
                                            </thead>
                                            <tbody id="tabela-clientes-recorrentes">
                                                <tr><td colspan="6" class="text-center text-text-secondary py-8">Carregando clientes recorrentes...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div id="tabela-clientes-atencao-wrapper" class="clientes-tabela-section hidden">
                                <div class="chart-container-card">
                                    <!-- <h3 class="client-table-title">Clientes em Atenção</h3> -->
                                    <div id="paginacao-clientes-atencao-div-top"></div>
                                    <div class="overflow-x-auto rounded-lg">
                                        <table class="modern-table">
                                            <thead id="thead-clientes-atencao">
                                                <!-- Cabeçalho será preenchido via JS -->
                                            </thead>
                                            <tbody id="tabela-clientes-atencao">
                                                <tr><td colspan="6" class="text-center text-text-secondary py-8">Carregando clientes que requerem atenção...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div id="tabela-clientes-outros-wrapper" class="clientes-tabela-section hidden">
                                <div class="chart-container-card text-center py-12">
                                    <i class="fas fa-info-circle text-4xl text-text-secondary mb-4"></i>
                                    <h3 class="text-xl font-semibold text-text-primary">Clientes "Outros"</h3>
                                    <p class="text-text-secondary mt-2">Esta categoria representa clientes que tiveram seu primeiro atendimento no período selecionado.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Gráfico de Evolução de Clientes -->
                        <!-- Removido o gráfico de evolução de clientes por mês -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Upload XLSX -->
    <div id="uploadModal" class="modal-backdrop">
        <div class="modal-content-custom">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-text-primary">Upload de Planilha XLSX</h2>
                <button id="closeUploadModal" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="dropZone" class="drop-zone">
    <i class="fas fa-cloud-upload-alt text-4xl mb-4"></i>
    <p class="text-lg font-medium mb-2">Arraste o arquivo XLSX aqui</p>
    <p class="text-text-secondary mb-4">ou clique para selecionar</p>
    <input type="file" id="xlsxInput" accept=".xlsx" style="display: none;" />
    <button type="button" class="btn btn-primary" onclick="document.getElementById('xlsxInput').click()">
        Selecionar Arquivo
    </button>
    <div class="mt-4 text-sm text-gray-600">
        <p><strong>Filtros planilha Atendimentos:</strong></p>
        <p>Colunas - Local de atendimento, Valor, Origem, Repasse, Cupom de desconto, Dia da semana.</p>
        <p>Filtros - Programado, Concluido, Previstos, Não concluidos, Pendente.</p>
    </div>
</div>
            
            <div id="uploadPreview" class="mt-4 p-4 bg-bg-tertiary rounded-lg hidden">
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-excel text-success-color text-xl"></i>
                    <div>
                        <div class="font-medium text-text-primary" id="fileName"></div>
                        <div class="text-sm text-text-secondary" id="fileInfo"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="processFile" class="btn btn-primary">
                        <i class="fas fa-cog mr-2"></i>
                        Processar Arquivo
                    </button>
                </div>
            </div>
            
            <div id="uploadStatus" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Modal Editar Resultado (Simplificado, apenas para demonstração) -->
    <div id="editResultModal" class="modal-backdrop">
        <div class="modal-content-custom">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-text-primary">Editar Resultado</h2>
                <button id="closeEditResultModal" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editResultForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Data *</label>
                    <input type="text" id="editData" name="DATA" class="form-input" placeholder="DD/MM/AAAA" maxlength="10" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Cliente *</label>
                    <input type="text" id="editCliente" name="CLIENTE" class="form-input" placeholder="Nome do cliente" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Serviço *</label>
                    <input type="text" id="editServico" name="SERVIÇO" class="form-input" placeholder="Serviço" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Valor (R$) *</label>
                    <input type="text" id="editValor" name="VALOR" class="form-input currency-input" placeholder="0,00" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Repasse (R$)</label>
                    <input type="text" id="editRepasse" name="REPASSE" class="form-input currency-input" placeholder="0,00" />
                </div>
                <div class="form-group">
                    <label class="form-label">Profissional</label>
                    <input type="text" id="editProfissional" name="PROFISSIONAL" class="form-input" placeholder="Nome do profissional" />
                </div>
            </form>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" id="cancelEditResult" class="btn btn-outline">Cancelar</button>
                <button type="submit" form="editResultForm" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div class="toast-container fixed bottom-4 right-4 z-[1100] flex flex-col gap-2" id="toastContainer"></div>

    <!-- MODAL DE CONFIGURAÇÃO DE USUÁRIO -->
    <div id="configModal" class="modal-backdrop">
        <div class="modal-content-custom" style="max-width: 350px;">
            <h2 class="text-xl font-semibold text-text-primary mb-4">Configurações da Conta</h2>
            <form id="formConfigUsuario">
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" id="configEmail" class="form-input" required placeholder="Novo e-mail">
                </div>
                <div class="form-group">
                    <label class="form-label">Nova senha</label>
                    <input type="password" id="configSenha" class="form-input" minlength="6" placeholder="Nova senha">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar nova senha</label>
                    <input type="password" id="configConfirmarSenha" class="form-input" minlength="6" placeholder="Confirme a nova senha">
                </div>
                <div id="erroConfigUsuario" style="color:var(--danger-color); font-size:14px; margin-bottom:10px; display:none;"></div>
                <button type="submit" class="btn btn-primary w-full">Salvar alterações</button>
                <button type="button" id="cancelConfigUsuario" class="btn btn-outline w-full mt-2">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // Configuração global para logs de depuração
        window.debugMode = true; // Defina como 'false' para produção

        // Função para log condicional
        function debugLog(message, data) {
            if (window.debugMode) {
                console.log(message, data);
            }
        }

        // --- Supabase Configuration ---
        // Usando a chave de 'service_role' do DASHBOARD_Coba.html, mais apropriada para operações de escrita.
        const SUPABASE_URL = "https://nehmpbytxsvmsevrxvxa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5laG1wYnl0eHN2bXNldnJ4dnhhIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MjkzMDM2NCwiZXhwIjoyMDU4NTA2MzY0fQ.yoFlEi2c7SODvcEy57kKVaEREh044Cnu8TFYlZ4cROc";
        // --- INÍCIO: Lista fixa de tabelas disponíveis ---
        // REMOVIDO: const TABLES_AVAILABLE = [...];
        // --- FIM: Lista fixa de tabelas disponíveis ---
        // REMOVIDO: let selectedTable = localStorage.getItem('selectedTable') || 'resultados_mbteresina';
        // --- FIM: Supabase Configuration ---

        // O restante do código permanece igual. TABLES_AVAILABLE e selectedTable são definidos dinamicamente após o login.

        // Função para obter dinamicamente a tabela selecionada pelo usuário
        function getSelectedTableName() {
            // Usa window.selectedTable se disponível, senão usa resultados_mbteresina como fallback
            return window.selectedTable || "resultados_mbteresina";
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Headers esperados da planilha (para upload)
        // Ajustado para corresponder exatamente aos cabeçalhos da sua planilha XLSX
        const EXPECTED_HEADERS = [
            'Orçamento', 'Número', 'Data', 'Horário', 'Período', 'Serviço', 'Tipo', 'Horas',
            'Cliente', 'Profissionais', 'Repasse (R$)', 'Situação', 'Recorrente',
            'Local de Atendimento', 'Valor (R$)', 'Cupom de Desconto', 'Origem',
            'Data de cadastro', 'Dia da semana'
        ];

        // Lista de campos válidos do schema do banco de dados
        // Ajustado para incluir APENAS as colunas que existem na sua tabela 'resultados_mblondrina'
        const VALID_FIELDS = [
            'id', 'created_at', 'DATA', 'HORARIO', 'VALOR', 'SERVIÇO', 'TIPO', 'PERÍODO',
            'CLIENTE', 'PROFISSIONAL', 'ENDEREÇO', 'DIA', 'REPASSE', 'whatscliente',
            'CUPOM', 'ORIGEM', 'ATENDIMENTO_ID', 'IS_DIVISAO', 'CADASTRO', 'ACAO'
        ];

        // Variáveis globais de estado
        let resultadosData = [];
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentMainTab = 'gestao'; // 'gestao' ou 'clientes'
        let currentClientSubTab = 'ativos-list'; // 'ativos-list', 'recorrentes-list', 'atencao-list'
        let chartAtendimentosDia = null;
        let chartEvolucaoClientes = null;
        let semanaOffset = 0;

        // --- Funções de Inicialização ---
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM Content Loaded. Waiting for login...');
            // Inicializar tema imediatamente
            initTheme();
            // Não inicializa o dashboard aqui!
            // O dashboard só será inicializado após login/autenticação.
        });

        // --- Event Listeners ---
        function initEventListeners() {
            debugLog('Initializing event listeners...');

            // Wait a bit to ensure DOM is fully ready
            setTimeout(() => {
                debugLog('DOM should be ready now, setting up event listeners...');
                
                // REMOVIDO: Sidebar toggle
                // const toggleSidebarBtn = document.getElementById('toggle-sidebar');
                // if (toggleSidebarBtn) {
                //     toggleSidebarBtn.addEventListener('click', toggleSidebar);
                // }

            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                debugLog('Theme toggle button found, adding event listener...');
                
                themeToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    debugLog('Theme toggle clicked, current theme:', currentTheme);
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    debugLog('Switching to theme:', newTheme);
                    setTheme(newTheme);
                });
                
            } else {
                debugLog('Theme toggle button not found!');
            }

            // Month and Year filters
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            if (monthFilter) monthFilter.addEventListener('change', loadResults);
            if (yearFilter) yearFilter.addEventListener('change', loadResults);

            // Upload and Refresh buttons
            const uploadBtn = document.getElementById('uploadBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            if (uploadBtn) uploadBtn.addEventListener('click', openUploadModal);
            if (refreshBtn) refreshBtn.addEventListener('click', loadResults);

            // Upload Modal
            const closeUploadModalBtn = document.getElementById('closeUploadModal');
            const xlsxInput = document.getElementById('xlsxInput');
            const processFileBtn = document.getElementById('processFile');
            const dropZone = document.getElementById('dropZone');

            if (closeUploadModalBtn) closeUploadModalBtn.addEventListener('click', closeUploadModal);
            if (xlsxInput) xlsxInput.addEventListener('change', handleFileSelect);
            if (processFileBtn) processFileBtn.addEventListener('click', processUploadedFile);
            if (dropZone) {
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
            }

            // Edit Result Modal (simplified)
            const closeEditResultModalBtn = document.getElementById('closeEditResultModal');
            const cancelEditResultBtn = document.getElementById('cancelEditResult');
            const editResultForm = document.getElementById('editResultForm');

            if (closeEditResultModalBtn) closeEditResultModalBtn.addEventListener('click', closeEditResultModal);
            if (cancelEditResultBtn) cancelEditResultBtn.addEventListener('click', closeEditResultModal);
            if (editResultForm) editResultForm.addEventListener('submit', saveEditResult);

            // Main Dashboard Tabs (Gestão / Clientes)
            document.querySelectorAll('.tab-navigation button[data-tab]').forEach(button => {
                button.addEventListener('click', (event) => {
                    const tabName = event.target.closest('button').dataset.tab;
                    switchDashboardTab(tabName, event.target.closest('button'));
                });
            });

            // Client Sub-Tabs (Ativos / Recorrentes / Atenção)
            document.querySelectorAll('#client-tabs .tab-filter').forEach(button => {
                button.addEventListener('click', (event) => {
                    const tabName = event.target.closest('button').dataset.tab;
                    switchClientSubTab(tabName, event.target.closest('button'));
                });
            });

            // Botão de configuração
            const configBtn = document.getElementById('configBtn');
            if (configBtn) {
                debugLog('Config button found, adding event listener...');
                configBtn.addEventListener('click', function() {
                    debugLog('Config button clicked');
                    const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
                    document.getElementById('configEmail').value = usuario && usuario.email ? usuario.email : '';
                    document.getElementById('configSenha').value = '';
                    document.getElementById('configConfirmarSenha').value = '';
                    document.getElementById('erroConfigUsuario').style.display = 'none';
                    const configModal = document.getElementById('configModal');
                    configModal.classList.add('show');
                });
                
                // Test: Add a visual indicator that the button is working
                configBtn.addEventListener('mousedown', () => {
                    configBtn.style.backgroundColor = 'rgba(255, 0, 153, 0.3)';
                });
                configBtn.addEventListener('mouseup', () => {
                    setTimeout(() => {
                        configBtn.style.backgroundColor = '';
                    }, 100);
                });
            } else {
                debugLog('Config button not found!');
            }
            // Botão cancelar do modal de configuração
            const cancelConfigUsuario = document.getElementById('cancelConfigUsuario');
            if (cancelConfigUsuario) {
                cancelConfigUsuario.addEventListener('click', function() {
                    const configModal = document.getElementById('configModal');
                    configModal.classList.remove('show');
                });
            }
            // Fechar modal ao clicar fora dele
            const configModal = document.getElementById('configModal');
            if (configModal) {
                configModal.addEventListener('click', function(e) {
                    if (e.target === configModal) {
                        configModal.classList.remove('show');
                    }
                });
            }
            // Fechar modal com tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && configModal && configModal.classList.contains('show')) {
                    configModal.classList.remove('show');
                }
            });

            // Botão de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                debugLog('Logout button found, adding event listener...');
                logoutBtn.addEventListener('click', function() {
                    debugLog('Logout button clicked');
                    localStorage.removeItem('usuarioLogado');
                    localStorage.removeItem('selectedTable');
                    // Limpa variáveis globais e dados em memória
                    window.TABLES_AVAILABLE = [];
                    window.selectedTable = null;
                    window.resultadosData = [];
                    // Recarrega a página para garantir contexto limpo
                    location.reload();
                });
            } else {
                debugLog('Logout button not found!');
            }
            
            }, 100); // End of setTimeout
        }

        // --- Theme Management ---
        function initTheme() {
            debugLog('Initializing theme...');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            debugLog('Saved theme from localStorage:', savedTheme);
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            debugLog('Setting theme to:', theme);
            
            // Remove todas as classes de tema primeiro
            document.body.classList.remove('dark', 'light');
            
            // Force reflow para garantir que a mudança seja aplicada
            document.body.offsetHeight;
            
            // Adiciona a classe do tema
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.add('light');
            }
            
            // Atualiza variável global
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            
            debugLog('Theme set successfully, currentTheme is now:', currentTheme);
            debugLog('Body classes:', document.body.className);
            
            // Debug das variáveis CSS
            const computedStyle = getComputedStyle(document.documentElement);
            debugLog('CSS Variables after theme change:');
            debugLog('--bg-primary:', computedStyle.getPropertyValue('--bg-primary').trim());
            debugLog('--bg-secondary:', computedStyle.getPropertyValue('--bg-secondary').trim());
            debugLog('--text-primary:', computedStyle.getPropertyValue('--text-primary').trim());
            
            // Força atualização dos ícones
            const themeToggleBtn = document.getElementById('themeToggle');
            if (themeToggleBtn) {
                const sunIcon = themeToggleBtn.querySelector('.fa-sun');
                const moonIcon = themeToggleBtn.querySelector('.fa-moon');
                
                if (theme === 'dark') {
                    // No tema escuro, mostra sol (para mudar para claro)
                    if (sunIcon) sunIcon.style.display = 'inline-block';
                    if (moonIcon) moonIcon.style.display = 'none';
                } else {
                    // No tema claro, mostra lua (para mudar para escuro)
                    if (sunIcon) sunIcon.style.display = 'none';
                    if (moonIcon) moonIcon.style.display = 'inline-block';
                }
            }
            
            // Force CSS recalculation para todos os elementos
            document.documentElement.style.display = 'none';
            document.documentElement.offsetHeight; // trigger reflow
            document.documentElement.style.display = '';
            
            // Força aplicação das variáveis CSS em elementos específicos
            const elementsToUpdate = [
                document.body,
                document.querySelector('.main-content'),
                document.querySelector('.dashboard-container'),
                document.querySelector('.header')
            ];
            
            elementsToUpdate.forEach(el => {
                if (el) {
                    el.style.backgroundColor = '';
                    el.style.color = '';
                    // Force CSS recalculation
                    el.offsetHeight;
                }
            });
            
            // Atualiza os gráficos se existirem para refletir o tema
            if (chartAtendimentosDia) chartAtendimentosDia.update();
            if (chartEvolucaoClientes) chartEvolucaoClientes.update();
            
            debugLog('Theme change completed');
        }

        // --- Sidebar Toggle REMOVIDA ---
        // function toggleSidebar() {
        //     const sidebar = document.querySelector('.sidebar');
        //     const mainContent = document.querySelector('.main-content');
        //     const toggleBtn = document.getElementById('toggle-sidebar');

        //     if (sidebar && mainContent && toggleBtn) {
        //         sidebar.classList.toggle('minimized');
        //         mainContent.classList.toggle('minimized');
        //         const icon = toggleBtn.querySelector('svg polyline');
        //         if (icon) {
        //             if (sidebar.classList.contains('minimized')) {
        //                 icon.setAttribute('points', '9 18 15 12 9 6');
        //             } else {
        //                 icon.setAttribute('points', '15 18 9 12 15 6');
        //             }
        //         }
        //     }
        // }

        function handleResize() {
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;

            // Com a sidebar removida, o main-content sempre ocupa 100% da largura.
            // Não há necessidade de ajustar margens com base no tamanho da tela para a sidebar.
            // Apenas garantir que não há margin-left residual.
            mainContent.style.marginLeft = '0px';

            // Se houver outros elementos que dependiam do estado da sidebar, eles precisariam ser ajustados aqui.
            // No entanto, para esta remoção simples, apenas o main-content é afetado diretamente.
        }

        // --- Currency Formatting ---
        function setupCurrencyInputs() {
            document.querySelectorAll('.currency-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value) {
                        value = (parseInt(value, 10) / 100).toFixed(2);
                        value = value.replace('.', ',');
                        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        e.target.value = value;
                    }
                });
                input.addEventListener('blur', function(e) {
                    if (e.target.value && !e.target.value.includes(',')) {
                        e.target.value += ',00';
                    } else if (e.target.value && e.target.value.split(',')[1].length < 2) {
                        e.target.value = e.target.value.padEnd(e.target.value.length + (2 - e.target.value.split(',')[1].length), '0');
                    }
                });
            });
        }

        function parseValueFromCurrency(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            let str = value.toString();
            str = str.replace(/[R$\s]/g, '');
            if (str.includes(',')) {
                str = str.replace(/\./g, '').replace(',', '.');
            }
            const numValue = parseFloat(str);
            return isNaN(numValue) ? 0 : numValue;
        }

        function formatCurrencyDisplay(value) {
            if (typeof value !== 'number' || isNaN(value)) {
                value = 0;
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // --- Data Loading and Filtering ---
        async function loadResults() {
            showLoading(true);
            debugLog('Loading results from Supabase...');
            try {
                let allData = [];
                if (selectedTable === 'ALL') {
                    // Buscar dados de todas as tabelas e somar
                    for (const tbl of TABLES_AVAILABLE) {
                        let page = 0;
                        const pageSize = 1000;
                        let hasMore = true;
                        while (hasMore) {
                            const { data, error } = await supabase
                                .from(tbl.value)
                                .select('*')
                                .order('DATA', { ascending: false })
                                .range(page * pageSize, (page + 1) * pageSize - 1);
                            if (error) {
                                console.error(`Erro ao carregar página ${page + 1} da tabela ${tbl.value}:`, error);
                                throw new Error(`Erro ao carregar dados de ${tbl.label}: ${error.message}`);
                            }
                            if (data && data.length > 0) {
                                allData = allData.concat(data);
                                debugLog(`Tabela ${tbl.value} - Página ${page + 1} carregada: ${data.length} registros`);
                                page++;
                                if (data.length < pageSize) {
                                    hasMore = false;
                                }
                            } else {
                                hasMore = false;
                            }
                        }
                    }
                } else {
                    // Buscar dados apenas da tabela selecionada
                    let page = 0;
                    const pageSize = 1000;
                    let hasMore = true;
                    while (hasMore) {
                        const { data, error } = await supabase
                            .from(selectedTable)
                            .select('*')
                            .order('DATA', { ascending: false })
                            .range(page * pageSize, (page + 1) * pageSize - 1);
                        if (error) {
                            console.error(`Erro ao carregar página ${page + 1}:`, error);
                            throw new Error(`Erro ao carregar dados: ${error.message}`);
                        }
                        if (data && data.length > 0) {
                            allData = allData.concat(data);
                            debugLog(`Página ${page + 1} carregada: ${data.length} registros`);
                            page++;
                            if (data.length < pageSize) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                }
                resultadosData = allData;
                debugLog(`Total de registros carregados: ${resultadosData.length}`);
                // Recalcula e exibe as métricas para a aba ativa
                if (currentMainTab === 'gestao') {
                    calculateAndDisplayGestaoMetrics();
                    desenharGraficoAtendimentosDia(getFilteredResults());
                } else if (currentMainTab === 'clientes') {
                    loadClientData();
                }
                renderResultsTable();
            } catch (error) {
                console.error('Error in loadResults:', error);
                showToast('Erro', `Falha ao carregar dados: ${error.message}`, 'error');
                resultadosData = [];
                updateAllGestaoMetrics(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                updateAllClientMetrics(0, 0, 0, 0);
            } finally {
                showLoading(false);
            }
        }

        function getSelectedMonthYear() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            // Retorna null se "Todos" (value="") for selecionado
            const month = monthFilter && monthFilter.value !== '' ? parseInt(monthFilter.value) : null;
            const year = yearFilter && yearFilter.value !== '' ? parseInt(yearFilter.value) : null;
            
            return { month, year };
        }

        function getFilteredResults() {
            const { month, year } = getSelectedMonthYear();
            debugLog(`Filtrando resultados para Mês: ${month}, Ano: ${year}`);
            
            return resultadosData.filter(item => {
                if (!item || !item.DATA) {
                    debugLog('Item sem data ou nulo:', item);
                    return false;
                }
                
                let d = parseDate(item.DATA); // Usar a função parseDate global
                if (!d || isNaN(d.getTime())) {
                    debugLog(`Data inválida para filtro: "${item.DATA}"`, item);
                    return false;
                }

                const itemMonth = d.getMonth() + 1; // Mês (1-12)
                const itemYear = d.getFullYear();

                // Se o filtro de mês é null (Todos), não filtra por mês
                const matchMonth = (month === null) || (itemMonth === month);
                // Se o filtro de ano é null (Todos), não filtra por ano
                const matchYear = (year === null) || (itemYear === year);

                return matchMonth && matchYear;
            });
        }

        function getPreviousYearData(targetMonth, targetYear) {
            const previousYear = targetYear - 1;
            debugLog(`Buscando dados do ano anterior para Mês: ${targetMonth}, Ano: ${previousYear}`);
            
            return resultadosData.filter(item => {
                if (!item || !item.DATA) return false;
                
                let d = parseDate(item.DATA); // Usar a função parseDate global
                if (!d || isNaN(d.getTime())) return false;

                const itemMonth = d.getMonth() + 1;
                const itemYear = d.getFullYear();

                return itemMonth === targetMonth && itemYear === previousYear;
            });
        }

        // --- Dashboard Tab Switching ---
        function switchDashboardTab(tabName, clickedButton) {
            currentMainTab = tabName;

            // REMOVIDO: Lógica para ativar/desativar itens da sidebar
            // document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
            // const navItem = document.querySelector(`.sidebar .nav-item[onclick*="switchDashboardTab('${tabName}'"]`);
            // if (navItem) {
            //     navItem.classList.add('active');
            // }

            document.querySelectorAll('.tab-navigation button[data-tab]').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            document.querySelectorAll('.tab-content-section').forEach(section => section.classList.add('hidden'));
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

            updateTabIndicator(clickedButton);

            if (tabName === 'gestao') {
                calculateAndDisplayGestaoMetrics();
                desenharGraficoAtendimentosDia(getFilteredResults());
            } else if (tabName === 'clientes') {
                loadClientData();
                // Ensure client sub-tabs are correctly initialized
                const firstClientSubTabButton = document.querySelector('#client-tabs .tab-filter.active');
                if (firstClientSubTabButton) {
                    switchClientSubTab('ativos-list', firstClientSubTabButton);
                } else {
                    // Default to 'ativos-list' if no active found
                    switchClientSubTab('ativos-list', document.querySelector('#client-tabs .tab-filter[data-tab="ativos-list"]'));
                }
            }
        }

        // --- Client Sub-Tab Switching ---
        function switchClientSubTab(tabName, clickedButton) {
            currentClientSubTab = tabName;

            document.querySelectorAll('#client-tabs .tab-filter').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            document.querySelectorAll('[id^="client-subtab-content-"]').forEach(section => section.classList.add('hidden'));
            document.getElementById(`client-subtab-content-${tabName}`).classList.remove('hidden');

            updateTabIndicator(clickedButton, '#client-tabs .tab-indicator');

            // Re-render specific client table if needed (data should already be loaded by loadClientData)
            if (tabName === 'ativos-list') {
                // Data already processed by loadClientData, just ensure table is rendered
            } else if (tabName === 'recorrentes-list') {
                //
            } else if (tabName === 'atencao-list') {
                //
            }
        }

        function updateTabIndicator(activeTab, indicatorSelector = '.tab-indicator') {
            const tabIndicator = document.querySelector(indicatorSelector);
            if (tabIndicator && activeTab) {
                const tabRect = activeTab.getBoundingClientRect();
                const containerRect = activeTab.parentElement.getBoundingClientRect();
                const left = tabRect.left - containerRect.left;
                const width = tabRect.width;

                tabIndicator.style.left = left + 'px';
                tabIndicator.style.width = width + 'px';
            }
        }

        // --- Gestão Metrics Calculation ---
        function calculateAndDisplayGestaoMetrics() {
            debugLog('Calculating Gestão metrics...');
            const dadosDoMes = getFilteredResults();
            const { month, year } = getSelectedMonthYear(); // Pega mês/ano (podem ser null)

            let dadosAnoAnterior = [];
            // Só calcula dados do ano anterior se um mês e ano específicos estiverem selecionados
            if (month !== null && year !== null) {
                dadosAnoAnterior = getPreviousYearData(month, year);
            } else {
                debugLog('Pulando comparação ano a ano, pois nenhum mês/ano específico foi selecionado.');
            }

            if (!dadosDoMes || dadosDoMes.length === 0) {
                debugLog('No data for current month/year. Resetting metrics.');
                updateAllGestaoMetrics(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                desenharGraficoAtendimentosDia([]); // Clear chart
                return;
            }

            // Atendimentos
            const atendimentosUnicos = dadosDoMes.filter(item => item.IS_DIVISAO !== 'SIM');
            const atendimentosNoMes = atendimentosUnicos.length;

            const atendimentosPorDia = {};
            atendimentosUnicos.forEach(item => {
                const dataItem = item.DATA;
                if (dataItem) {
                    atendimentosPorDia[dataItem] = (atendimentosPorDia[dataItem] || 0) + 1;
                }
            });
            const diasComAtendimentos = Object.keys(atendimentosPorDia).length;
            const mediaAtendimentosPorDia = diasComAtendimentos > 0 ? (atendimentosNoMes / diasComAtendimentos).toFixed(1) : 0;

            let atendimentosPreAgendados = 0;
            // Apenas calcula pré-agendados se um mês e ano específicos estiverem selecionados
            if (month !== null && year !== null) {
                const primeiroDiaMes = new Date(year, month - 1, 1);
                primeiroDiaMes.setHours(0, 0, 0, 0);
                atendimentosUnicos.forEach(item => {
                    if (item.CADASTRO && item.DATA) {
                        let dataCadastro = parseDate(item.CADASTRO);
                        const dataAtendimento = parseDate(item.DATA);
                        if (dataCadastro && dataAtendimento && dataCadastro < primeiroDiaMes && dataAtendimento >= primeiroDiaMes) {
                            atendimentosPreAgendados++;
                        }
                    }
                });
            }


            const atendimentosComerciais = atendimentosUnicos.filter(item => item.TIPO && item.TIPO.toUpperCase() === 'COMERCIAL').length;
            const atendimentosResidenciais = atendimentosUnicos.filter(item => item.TIPO && item.TIPO.toUpperCase() === 'RESIDENCIAL').length;
            const percentualComercial = atendimentosNoMes > 0 ? ((atendimentosComerciais / atendimentosNoMes) * 100).toFixed(1) : 0;
            const percentualResidencial = atendimentosNoMes > 0 ? ((atendimentosResidenciais / atendimentosNoMes) * 100).toFixed(1) : 0;

            // Faturamento
            const faturamentoMensal = dadosDoMes.reduce((sum, item) => sum + parseValueFromCurrency(item.VALOR), 0);
            const totalRepasses = dadosDoMes.reduce((sum, item) => sum + parseValueFromCurrency(item.REPASSE), 0);
            const valorMedioPorAtendimento = atendimentosNoMes > 0 ? faturamentoMensal / atendimentosNoMes : 0;
            const mediaValorRepasse = atendimentosNoMes > 0 ? totalRepasses / atendimentosNoMes : 0;
            const margem = faturamentoMensal - totalRepasses;
            const valorMedioAtendimentoMargem = atendimentosNoMes > 0 ? margem / atendimentosNoMes : 0;

            // Clientes
            const clientesUnicosSet = new Set(dadosDoMes.map(item => item.CLIENTE).filter(Boolean));
            const clientesUnicos = clientesUnicosSet.size;
            const atendimentoMedio = clientesUnicos > 0 ? (atendimentosNoMes / clientesUnicos).toFixed(1) : 0;

            // Clientes recorrentes e churn (requer dados do mês anterior)
            let clientesRecorrentes = 0;
            let churn = 0;
            if (month !== null && year !== null) { // Só calcula se um mês e ano específicos estiverem selecionados
                const mesAnterior = month === 1 ? 12 : month - 1;
                const anoMesAnterior = month === 1 ? year - 1 : year;
                const dadosMesAnterior = resultadosData.filter(item => {
                    if (!item || !item.DATA) return false;
                    let d = parseDate(item.DATA);
                    return d && d.getMonth() + 1 === mesAnterior && d.getFullYear() === anoMesAnterior;
                });
                const clientesMesAnteriorSet = new Set(dadosMesAnterior.map(item => item.CLIENTE).filter(Boolean));

                clientesUnicosSet.forEach(cliente => {
                    if (clientesMesAnteriorSet.has(cliente)) {
                        clientesRecorrentes++;
                    }
                });

                const clientesNaoRetornaram = Array.from(clientesMesAnteriorSet).filter(cliente => !clientesUnicosSet.has(cliente)).length;
                churn = clientesMesAnteriorSet.size > 0 ? (clientesNaoRetornaram / clientesMesAnteriorSet.size) * 100 : 0;
            }


            // Comparação com Ano Anterior
            // Inicializa com 0 para que os indicadores não mostrem NaN se não houver dados
            let atendimentosAnoAnteriorUnicos = 0;
            let faturamentoAnoAnterior = 0;
            let clientesAnoAnterior = 0;

            if (month !== null && year !== null) { // Só calcula se um mês e ano específicos estiverem selecionados
                atendimentosAnoAnteriorUnicos = dadosAnoAnterior.filter(item => item.IS_DIVISAO !== 'SIM').length;
                faturamentoAnoAnterior = dadosAnoAnterior.reduce((sum, item) => sum + parseValueFromCurrency(item.VALOR), 0);
                clientesAnoAnterior = new Set(dadosAnoAnterior.map(item => item.CLIENTE).filter(Boolean)).size;
            }

            updateAllGestaoMetrics(
                atendimentosNoMes, mediaAtendimentosPorDia, atendimentosPreAgendados,
                atendimentosComerciais, percentualComercial, atendimentosResidenciais, percentualResidencial,
                faturamentoMensal, valorMedioPorAtendimento, mediaValorRepasse, valorMedioAtendimentoMargem,
                clientesUnicos, atendimentoMedio, clientesRecorrentes, churn,
                atendimentosAnoAnteriorUnicos, faturamentoAnoAnterior, clientesAnoAnterior
            );

            // Atualizar indicadores de crescimento
            updateGrowthIndicators(
                { atendimentos: atendimentosNoMes, faturamento: faturamentoMensal, clientes: clientesUnicos },
                { atendimentos: atendimentosAnoAnteriorUnicos, faturamento: faturamentoAnoAnterior, clientes: clientesAnoAnterior }
            );

            // --- Cálculo dos atendimentos da semana ---
            atualizarSemanaDashboard();
        }

        function updateAllGestaoMetrics(
            atendimentos, mediaDia, preAgendados,
            comerciais, percentComercial, residenciais, percentResidencial,
            faturamento, valorMedio, mediaRepasse, valorMedioAtendimentoMargem,
            clientes, atendimentoMedio, clientesRecorrentes, churn,
            atendimentosAnoAnterior, faturamentoAnoAnterior, clientesAnoAnterior
        ) {
            const update = (id, value, isCurrency = false, isPercent = false) => {
                const el = document.getElementById(id);
                if (el) {
                    let formattedValue = value;
                    if (isCurrency) formattedValue = formatCurrencyDisplay(value);
                    if (isPercent) formattedValue = `${value}%`;
                    el.textContent = formattedValue;
                } else {
                    //console.warn(`Elemento com ID '${id}' não encontrado.`);
                }
            };

            update('metric-atendimentos-mes', atendimentos);
            update('metric-media-dia', mediaDia);
            update('metric-pre-agendados', preAgendados);
            update('metric-atendimentos-comercial', comerciais);
            update('percentual-comercial', percentComercial, false, true);
            update('metric-atendimentos-residencial', residenciais);
            update('percentual-residencial', percentResidencial, false, true);

            update('metric-faturamento-mes', faturamento, true);
            update('metric-valor-medio', valorMedio, true);
            update('metric-media-repasse', mediaRepasse, true);
            update('metric-valor-medio-atendimento-margem', valorMedioAtendimentoMargem, true);

            update('metric-clientes', clientes);
            update('metric-atendimento-medio', atendimentoMedio);
            update('metric-clientes-recorrentes-card', clientesRecorrentes);
            update('metric-clientes-outros', clientes - clientesRecorrentes);
            update('metric-churn', churn.toFixed(1), false, true);
        }

        function calculateYearOverYearGrowth(currentValue, previousValue) {
            if (!previousValue || previousValue === 0) {
                return currentValue > 0 ? '+100.0' : '0.0';
            }
            const growth = ((currentValue - previousValue) / previousValue) * 100;
            return growth >= 0 ? `+${growth.toFixed(1)}` : growth.toFixed(1);
        }

        function updateGrowthIndicators(currentMetrics, previousYearMetrics) {
            const updateIndicator = (elementId, current, previous) => {
                const element = document.getElementById(elementId);
                if (!element) return;

                const growthPercent = calculateYearOverYearGrowth(current, previous);
                const growth = parseFloat(growthPercent);
                const isPositive = growth > 0;
                const isNeutral = growth === 0;

                const iconClass = isNeutral ? 'fa-equals' : (isPositive ? 'fa-caret-up' : 'fa-caret-down');
                const colorClass = isNeutral ? 'text-text-secondary' : (isPositive ? 'text-success-color' : 'text-danger-color');

                element.innerHTML = `
                    <span>vs. Ano Anterior</span>
                    <span><i class="fas ${iconClass} ${colorClass}"></i> ${growthPercent}%</span>
                `;
            };

            updateIndicator('atendimento-crescimento', currentMetrics.atendimentos, previousYearMetrics.atendimentos);
            updateIndicator('faturamento-crescimento', currentMetrics.faturamento, previousYearMetrics.faturamento);
            updateIndicator('clientes-crescimento', currentMetrics.clientes, previousYearMetrics.clientes);
        }

        // --- Charts ---
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('-') && dateStr.length === 10) { //YYYY-MM-DD
                return new Date(dateStr + 'T00:00:00');
            } else if (dateStr.includes('/')) { // DD/MM/YYYY
                const [day, month, year] = dateStr.split('/');
                return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }
            return null;
        }

        function desenharGraficoAtendimentosDia(dados) {
            const ctx = document.getElementById('grafico-atendimentos-dia')?.getContext('2d');
            if (!ctx) return;

            if (chartAtendimentosDia) {
                chartAtendimentosDia.destroy();
            }

            // Helper para pegar cores do tema de forma segura
            const getThemeColor = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            
            const chartColors = {
                primaryText: getThemeColor('--text-primary'),
                secondaryText: getThemeColor('--text-secondary'),
                accent: getThemeColor('--accent-primary'),
                info: getThemeColor('--brand-cyan'),
                success: getThemeColor('--brand-green'),
                background: getThemeColor('--bg-secondary'),
                border: getThemeColor('--border-primary'),
            };

            const { month, year } = getSelectedMonthYear();
            let chartMonth = month !== null ? month : new Date().getMonth() + 1;
            let chartYear = year !== null ? year : new Date().getFullYear();

            if (dados.length > 0 && (month === null || year === null)) {
                const firstDate = parseDate(dados[0].DATA);
                if (firstDate) {
                    if (month === null) chartMonth = firstDate.getMonth() + 1;
                    if (year === null) chartYear = firstDate.getFullYear();
                }
            }

            const ultimoDiaMes = new Date(chartYear, chartMonth, 0).getDate();
            const labels = Array.from({ length: ultimoDiaMes }, (_, i) => `${(i + 1).toString().padStart(2, '0')}`);

            const atendimentosPorDia = {};
            dados.filter(item => item.IS_DIVISAO !== 'SIM').forEach(item => {
                const dataAtendimento = parseDate(item.DATA);
                if (!dataAtendimento || dataAtendimento.getMonth() + 1 !== chartMonth || dataAtendimento.getFullYear() !== chartYear) return;
                
                const day = dataAtendimento.getDate();
                if (!atendimentosPorDia[day]) {
                    atendimentosPorDia[day] = { total: 0, preAgendado: 0 };
                }
                atendimentosPorDia[day].total++;

                let dataCadastro = parseDate(item.CADASTRO);
                if (!dataCadastro && item.created_at) dataCadastro = new Date(item.created_at);
                const primeiroDiaMes = new Date(chartYear, chartMonth - 1, 1);
                primeiroDiaMes.setHours(0, 0, 0, 0);

                if (dataCadastro && dataCadastro < primeiroDiaMes) {
                    atendimentosPorDia[day].preAgendado++;
                }
            });

            const dataPre = [];
            const dataNovos = [];
            const dataTotais = [];

            for (let i = 1; i <= ultimoDiaMes; i++) {
                const diaData = atendimentosPorDia[i] || { total: 0, preAgendado: 0 };
                dataPre.push(diaData.preAgendado);
                dataNovos.push(diaData.total - diaData.preAgendado);
                dataTotais.push(diaData.total);
            }

            chartAtendimentosDia = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                         {
                            label: 'Pré-Agendados',
                            data: dataPre,
                            backgroundColor: chartColors.success,
                            borderColor: chartColors.success,
                            borderWidth: 1,
                            borderRadius: { topLeft: 4, topRight: 4 },
                            borderSkipped: false,
                        },
                        {
                            label: 'Novos',
                            data: dataNovos,
                            backgroundColor: chartColors.info,
                            borderColor: chartColors.info,
                            borderWidth: 1,
                            borderRadius: { topLeft: 4, topRight: 4 },
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false, // Desativa a legenda padrão
                        },
                        tooltip: {
                            backgroundColor: chartColors.background,
                            titleColor: chartColors.primaryText,
                            bodyColor: chartColors.secondaryText,
                            borderColor: chartColors.accent,
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { family: 'Inter', size: 13, weight: 'bold' },
                            bodyFont: { family: 'Inter', size: 12 },
                            interaction: { mode: 'index' },
                            callbacks: {
                                footer: (tooltipItems) => {
                                    if (tooltipItems.length < 2) return '';
                                    
                                    const preAgendadosItem = tooltipItems.find(item => item.dataset.label === 'Pré-Agendados');
                                    const novosItem = tooltipItems.find(item => item.dataset.label === 'Novos');

                                    if (!preAgendadosItem || !novosItem) return '';

                                    const preAgendados = preAgendadosItem.raw;
                                    const novos = novosItem.raw;
                                    
                                    if (preAgendados > 0) {
                                        const crescimento = (novos / preAgendados) * 100;
                                        return `Crescimento: ${crescimento.toFixed(1)}%`;
                                    }
                                    
                                    return ''; // Não mostra crescimento se não houver pré-agendados
                                },
                            },
                        },
                        datalabels: {
                            color: '#f88f0b',
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, context) => {
                                // Apenas exibe o rótulo na barra do topo ('Novos')
                                if (context.datasetIndex !== 1) {
                                    return '';
                                }

                                const preAgendados = dataPre[context.dataIndex];
                                const novos = dataNovos[context.dataIndex];
                                
                                if (preAgendados > 0 && (preAgendados + novos > 0)) {
                                    const crescimento = (novos / preAgendados) * 100;
                                    // Adiciona um ícone de seta para cima para crescimento positivo
                                    if (crescimento > 0) {
                                        return `▲ ${crescimento.toFixed(0)}%`;
                                    }
                                }
                                
                                // Se não houver crescimento ou pré-agendados, não mostra nada
                                return '';
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { color: chartColors.secondaryText, font: { family: 'Inter', size: 10 } },
                            border: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { 
                                display: true,
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false 
                            },
                            ticks: { color: 'rgba(255, 255, 255, 0.7)', font: { family: 'Inter', size: 11 }, stepSize: 3 },
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                },
                plugins: [ChartDataLabels]
            });

            // --- Geração de Legenda HTML Customizada ---
            const legendContainer = document.getElementById('grafico-atendimentos-dia-legend');
            if (legendContainer) {
                legendContainer.innerHTML = ''; // Limpa a legenda anterior
                const legendItems = chartAtendimentosDia.data.datasets.map((dataset, i) => {
                    const color = dataset.backgroundColor;
                    const label = dataset.label;
                    return `
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-sm" style="background-color: ${color}"></span>
                            <span class="text-xs font-medium" style="color: ${chartColors.secondaryText}">${label}</span>
                        </div>
                    `;
                });
                legendContainer.innerHTML = legendItems.join('');
            }
        }

        function desenharGraficoEvolucaoClientes(allData) {
            const ctx = document.getElementById('grafico-evolucao-clientes')?.getContext('2d');
            if (!ctx) return;

            if (chartEvolucaoClientes) {
                chartEvolucaoClientes.destroy();
            }

            const labels = [];
            const dataAtivos = [];
            const dataRecorrentes = [];
            const dataAtencao = [];

            const today = new Date();
            for (let i = 5; i >= 0; i--) { // Últimos 6 meses
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthLabel = date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                labels.push(monthLabel);

                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                const monthData = allData.filter(item => {
                    const itemDate = parseDate(item.DATA);
                    return itemDate && (itemDate.getMonth() + 1) === month && itemDate.getFullYear() === year;
                });
                const monthClients = processarDadosClientes(monthData, month, year);
                dataAtivos.push(monthClients.ativos.length);
                dataRecorrentes.push(monthClients.recorrentes.length);
                dataAtencao.push(monthClients.atencao.length);
            }

            chartEvolucaoClientes = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Clientes Ativos',
                            data: dataAtivos,
                            borderColor: 'var(--info-color)',
                            backgroundColor: 'rgba(0, 213, 255, 0.2)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Clientes Recorrentes',
                            data: dataRecorrentes,
                            borderColor: 'var(--success-color)',
                            backgroundColor: 'rgba(56, 217, 169, 0.2)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Requerem Atenção',
                            data: dataAtencao,
                            borderColor: 'var(--warning-color)',
                            backgroundColor: 'rgba(255, 209, 102, 0.2)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim(),
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() },
                            grid: { color: 'transparent' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() },
                            grid: { color: 'transparent' }
                        }
                    }
                }
            });
        }

        // --- Client Metrics Calculation and Display ---
        async function loadClientData() {
            debugLog('Loading client data...');
            const { month, year } = getSelectedMonthYear();
            let dadosParaClientes = [];
            let dadosMesAtual = [];
            if (month !== null && year !== null) {
                // Pega dados do mês atual e do mês anterior
                dadosMesAtual = resultadosData.filter(item => {
                    const d = parseDate(item.DATA);
                    return d && d.getMonth() + 1 === month && d.getFullYear() === year;
                });
                const mesAnterior = month === 1 ? 12 : month - 1;
                const anoMesAnterior = month === 1 ? year - 1 : year;
                const dadosMesAnterior = resultadosData.filter(item => {
                    const d = parseDate(item.DATA);
                    return d && d.getMonth() + 1 === mesAnterior && d.getFullYear() === anoMesAnterior;
                });
                dadosParaClientes = dadosMesAtual.concat(dadosMesAnterior);
            } else {
                // Se não houver filtro, usa todos os dados
                dadosMesAtual = resultadosData;
                dadosParaClientes = resultadosData;
            }
            const processedClients = processarDadosClientes(dadosParaClientes, month, year);
            // Calcular total de clientes únicos do mês atual
            const clientesUnicosMesAtual = new Set(dadosMesAtual.map(item => item.CLIENTE).filter(Boolean)).size;
            updateAllClientMetrics(
                clientesUnicosMesAtual,
                processedClients.ativos.length,
                processedClients.recorrentes.length,
                processedClients.atencao.length
            );
            preencherTabelaClientesAtivos(processedClients.ativos);
            preencherTabelaClientesRecorrentes(processedClients.recorrentes);
            preencherTabelaClientesAtencao(processedClients.atencao);
        }

        function updateAllClientMetrics(total, ativos, recorrentes, atencao) {
            const update = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            update('metric-total-clientes', total);
            update('metric-clientes-ativos', ativos);
            update('metric-clientes-recorrentes', recorrentes);
            update('metric-clientes-atencao', atencao);
            update('metric-clientes-outros-card', total - recorrentes); // Atualiza o card 'Outros'
        }

        function processarDadosClientes(dados, filtroMes, filtroAno) {
            // Se não vier filtro, usa mês/ano atual
            let hoje = new Date();
            let mesAtual = filtroMes != null ? filtroMes - 1 : hoje.getMonth();
            let anoAtual = filtroAno != null ? filtroAno : hoje.getFullYear();
            let mesAnterior = mesAtual === 0 ? 11 : mesAtual - 1;
            let anoMesAnterior = mesAtual === 0 ? anoAtual - 1 : anoAtual;

            const clientesPorMes = {};
            dados.forEach(item => {
                if (!item.CLIENTE || !item.DATA) return;
                const dataAtendimento = parseDate(item.DATA);
                if (!dataAtendimento) return;
                const mesData = dataAtendimento.getMonth();
                const anoData = dataAtendimento.getFullYear();
                const dataFormatada = dataAtendimento.toLocaleDateString('pt-BR');
                const chaveCliente = item.CLIENTE;
                const chaveMes = `${anoData}-${mesData}`;
                if (!clientesPorMes[chaveCliente]) {
                    clientesPorMes[chaveCliente] = {};
                }
                if (!clientesPorMes[chaveCliente][chaveMes]) {
                    clientesPorMes[chaveCliente][chaveMes] = {
                        atendimentos: 0,
                        valorTotal: 0,
                        ultimoAtendimento: dataFormatada
                    };
                }
                clientesPorMes[chaveCliente][chaveMes].atendimentos++;
                clientesPorMes[chaveCliente][chaveMes].valorTotal += parseValueFromCurrency(item.VALOR);
                const dataAtualArmazenada = parseDate(clientesPorMes[chaveCliente][chaveMes].ultimoAtendimento);
                if (dataAtendimento > dataAtualArmazenada) {
                    clientesPorMes[chaveCliente][chaveMes].ultimoAtendimento = dataFormatada;
                }
            });
            const chaveAtual = `${anoAtual}-${mesAtual}`;
            const chaveAnterior = `${anoMesAnterior}-${mesAnterior}`;
            const ativos = [];
            const recorrentes = [];
            const atencao = [];
            Object.keys(clientesPorMes).forEach(cliente => {
                const dadosCliente = clientesPorMes[cliente];
                const temAtualMes = dadosCliente[chaveAtual];
                const temMesAnterior = dadosCliente[chaveAnterior];
                if (temAtualMes) {
                    const clienteAtivo = {
                        nome: cliente,
                        atendimentos: temAtualMes.atendimentos,
                        ultimoAtendimento: temAtualMes.ultimoAtendimento,
                        valorTotal: temAtualMes.valorTotal,
                        valorMedio: temAtualMes.atendimentos > 0 ? temAtualMes.valorTotal / temAtualMes.atendimentos : 0,
                        status: 'Ativo'
                    };
                    ativos.push(clienteAtivo);
                    if (temMesAnterior) {
                        recorrentes.push({
                            nome: cliente,
                            atendimentosAnterior: temMesAnterior.atendimentos,
                            atendimentosAtual: temAtualMes.atendimentos,
                            frequencia: temAtualMes.atendimentos + temMesAnterior.atendimentos,
                            valorTotal: temAtualMes.valorTotal + temMesAnterior.valorTotal,
                            fidelidade: 'Alta'
                        });
                    }
                } else if (temMesAnterior) {
                    const ultimoAtendimentoDate = parseDate(temMesAnterior.ultimoAtendimento);
                    const diasSemRetorno = ultimoAtendimentoDate ? Math.floor((hoje - ultimoAtendimentoDate) / (1000 * 60 * 60 * 24)) : 0;
                    // Buscar o valor real de ACAO do banco de dados para o cliente no mês anterior
                    let acaoBanco = '';
                    let idBanco = null;
                    for (const item of dados) {
                        if (item.CLIENTE === cliente) {
                            const d = parseDate(item.DATA);
                            if (d && d.getMonth() === mesAnterior && d.getFullYear() === anoMesAnterior) {
                                if (item.ACAO && item.ACAO.trim() !== '') {
                                    acaoBanco = item.ACAO;
                                }
                                if (item.id) {
                                    idBanco = item.id;
                                }
                                break;
                            }
                        }
                    }
                    atencao.push({
                        nome: cliente,
                        ultimoAtendimento: temMesAnterior.ultimoAtendimento,
                        diasSemRetorno: diasSemRetorno,
                        valorPerdido: temMesAnterior.valorTotal,
                        historico: `${temMesAnterior.atendimentos} atendimentos no mês anterior`,
                        acao: diasSemRetorno > 45 ? 'Urgente' : 'Contatar', // Mantém para compatibilidade
                        acaoBanco: acaoBanco,
                        idBanco: idBanco
                    });
                }
            });
            return {
                total: Object.keys(clientesPorMes).length,
                ativos: ativos.sort((a, b) => b.valorTotal - a.valorTotal),
                recorrentes: recorrentes.sort((a, b) => b.frequencia - a.frequencia),
                atencao: atencao.sort((a, b) => b.diasSemRetorno - a.diasSemRetorno)
            };
        }

        // === PAGINAÇÃO DAS TABELAS DE CLIENTES ===
        const PAGINACAO_CLIENTES = {
            ativos: { pagina: 1 },
            recorrentes: { pagina: 1 },
            atencao: { pagina: 1 }
        };
        const LINHAS_POR_PAGINA = 20;

        function renderPaginacaoClientes(tipo, total, onPageChange) {
            const totalPaginas = Math.ceil(total / LINHAS_POR_PAGINA);
            const paginacaoId = `paginacao-clientes-${tipo}`;
            let html = '';
            if (totalPaginas > 1) {
                html += `<div class="flex justify-center items-center gap-2 mt-2" id="${paginacaoId}">`;
                html += `<button class="btn btn-sm btn-outline" ${PAGINACAO_CLIENTES[tipo].pagina === 1 ? 'disabled' : ''} onclick="mudarPaginaClientes('${tipo}', -1)">Anterior</button>`;
                html += `<span class="text-sm">Página ${PAGINACAO_CLIENTES[tipo].pagina} de ${totalPaginas}</span>`;
                html += `<button class="btn btn-sm btn-outline" ${PAGINACAO_CLIENTES[tipo].pagina === totalPaginas ? 'disabled' : ''} onclick="mudarPaginaClientes('${tipo}', 1)">Próxima</button>`;
                html += '</div>';
            }
            return html;
        }

        function mudarPaginaClientes(tipo, delta) {
            PAGINACAO_CLIENTES[tipo].pagina += delta;
            if (PAGINACAO_CLIENTES[tipo].pagina < 1) PAGINACAO_CLIENTES[tipo].pagina = 1;
            // Chama a função correta para re-renderizar a tabela
            if (tipo === 'ativos') preencherTabelaClientesAtivos(window._clientesAtivosCache || []);
            if (tipo === 'recorrentes') preencherTabelaClientesRecorrentes(window._clientesRecorrentesCache || []);
            if (tipo === 'atencao') preencherTabelaClientesAtencao(window._clientesAtencaoCache || []);
        }

        // === MAPA DE ATENDIMENTOS POR CLIENTE E MÊS ===
        function gerarMapaAtendimentosPorClienteMes(resultadosData) {
            // Estrutura: { cliente: { 'ano-mes': quantidade } }
            const mapa = {};
            resultadosData.forEach(item => {
                if (!item.CLIENTE || !item.DATA) return;
                const d = parseDate(item.DATA);
                if (!d) return;
                const chaveCliente = item.CLIENTE;
                const chaveMes = `${d.getFullYear()}-${d.getMonth()}`;
                if (!mapa[chaveCliente]) mapa[chaveCliente] = {};
                if (!mapa[chaveCliente][chaveMes]) mapa[chaveCliente][chaveMes] = 0;
                mapa[chaveCliente][chaveMes]++;
            });
            return mapa;
        }

        function preencherTabelaClientesAtivos(clientes) {
            window._clientesAtivosCache = clientes;
            const tbody = document.getElementById('tabela-clientes-ativos');
            const thead = document.getElementById('thead-clientes-ativos');
            const paginacaoDivId = 'paginacao-clientes-ativos-div';
            if (!tbody || !thead) return;
            // Calcular os 6 últimos meses com base no filtro
            const { month, year } = getSelectedMonthYear();
            let baseMonth, baseYear;
            if (month && year) {
                baseMonth = month - 1; // 0-based
                baseYear = year;
            } else {
                const hoje = new Date();
                baseMonth = hoje.getMonth();
                baseYear = hoje.getFullYear();
            }
            const meses = [];
            for (let i = 5; i >= 0; i--) {
                let d = new Date(baseYear, baseMonth - i, 1);
                meses.push({
                    label: d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }),
                    mes: d.getMonth(),
                    ano: d.getFullYear()
                });
            }
            // Gera o mapa de atendimentos
            const mapaAtend = gerarMapaAtendimentosPorClienteMes(resultadosData);
            // Montar cabeçalho
            thead.innerHTML = `<tr><th class=\"text-left\">Cliente</th>${meses.map(m => `<th class=\"text-center\">${m.label}</th>`).join('')}</tr>`;
            // Paginação
            const pagina = PAGINACAO_CLIENTES.ativos.pagina;
            const inicio = (pagina - 1) * LINHAS_POR_PAGINA;
            const fim = inicio + LINHAS_POR_PAGINA;
            const clientesPagina = clientes.slice(inicio, fim);
            if (clientes.length === 0) {
                tbody.innerHTML = `<tr><td colspan=\"${meses.length + 1}\" class=\"text-center text-text-secondary py-8\">Nenhum cliente ativo encontrado.</td></tr>`;
                document.getElementById(paginacaoDivId)?.remove();
                return;
            }
            tbody.innerHTML = clientesPagina.map(cliente => {
                const atendimentosPorMes = meses.map(m => {
                    return (mapaAtend[cliente.nome] && mapaAtend[cliente.nome][`${m.ano}-${m.mes}`]) || 0;
                });
                return `<tr class=\"table-row\">
                    <td class=\"px-4 py-2 font-medium\">${cliente.nome}</td>
                    ${atendimentosPorMes.map(q => `<td class=\"px-4 py-2 text-center\">${q}</td>`).join('')}
                </tr>`;
            }).join('');
            // Adiciona controles de paginação
            let paginacaoDiv = document.getElementById(paginacaoDivId);
            if (!paginacaoDiv) {
                paginacaoDiv = document.createElement('div');
                paginacaoDiv.id = paginacaoDivId;
                tbody.parentElement.parentElement.appendChild(paginacaoDiv);
            }
            paginacaoDiv.innerHTML = renderPaginacaoClientes('ativos', clientes.length);
            let paginacaoDivTop = document.getElementById('paginacao-clientes-ativos-div-top');
            if (paginacaoDivTop) {
                paginacaoDivTop.innerHTML = renderPaginacaoClientes('ativos', clientes.length);
            }
        }

        function preencherTabelaClientesRecorrentes(clientes) {
            window._clientesRecorrentesCache = clientes;
            const tbody = document.getElementById('tabela-clientes-recorrentes');
            const thead = document.getElementById('thead-clientes-recorrentes');
            const paginacaoDivId = 'paginacao-clientes-recorrentes-div';
            if (!tbody || !thead) return;
            // Calcular os 6 últimos meses com base no filtro
            const { month, year } = getSelectedMonthYear();
            let baseMonth, baseYear;
            if (month && year) {
                baseMonth = month - 1; // 0-based
                baseYear = year;
            } else {
                const hoje = new Date();
                baseMonth = hoje.getMonth();
                baseYear = hoje.getFullYear();
            }
            const meses = [];
            for (let i = 5; i >= 0; i--) {
                let d = new Date(baseYear, baseMonth - i, 1);
                meses.push({
                    label: d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }),
                    mes: d.getMonth(),
                    ano: d.getFullYear()
                });
            }
            // Gera o mapa de atendimentos
            const mapaAtend = gerarMapaAtendimentosPorClienteMes(resultadosData);
            // Montar cabeçalho
            thead.innerHTML = `<tr><th class=\"text-left\">Cliente</th>${meses.map(m => `<th class=\"text-center\">${m.label}</th>`).join('')}</tr>`;
            // Paginação
            const pagina = PAGINACAO_CLIENTES.recorrentes.pagina;
            const inicio = (pagina - 1) * LINHAS_POR_PAGINA;
            const fim = inicio + LINHAS_POR_PAGINA;
            const clientesPagina = clientes.slice(inicio, fim);
            if (clientes.length === 0) {
                tbody.innerHTML = `<tr><td colspan=\"${meses.length + 1}\" class=\"text-center text-text-secondary py-8\">Nenhum cliente recorrente encontrado.</td></tr>`;
                document.getElementById(paginacaoDivId)?.remove();
                return;
            }
            tbody.innerHTML = clientesPagina.map(cliente => {
                const atendimentosPorMes = meses.map(m => {
                    return (mapaAtend[cliente.nome] && mapaAtend[cliente.nome][`${m.ano}-${m.mes}`]) || 0;
                });
                return `<tr class=\"table-row\">
                    <td class=\"px-4 py-2 font-medium\">${cliente.nome}</td>
                    ${atendimentosPorMes.map(q => `<td class=\"px-4 py-2 text-center\">${q}</td>`).join('')}
                </tr>`;
            }).join('');
            // Adiciona controles de paginação
            let paginacaoDiv = document.getElementById(paginacaoDivId);
            if (!paginacaoDiv) {
                paginacaoDiv = document.createElement('div');
                paginacaoDiv.id = paginacaoDivId;
                tbody.parentElement.parentElement.appendChild(paginacaoDiv);
            }
            paginacaoDiv.innerHTML = renderPaginacaoClientes('recorrentes', clientes.length);
            let paginacaoDivTop = document.getElementById('paginacao-clientes-recorrentes-div-top');
            if (paginacaoDivTop) {
                paginacaoDivTop.innerHTML = renderPaginacaoClientes('recorrentes', clientes.length);
            }
        }

        function preencherTabelaClientesAtencao(clientes) {
            window._clientesAtencaoCache = clientes;
            const tbody = document.getElementById('tabela-clientes-atencao');
            const thead = document.getElementById('thead-clientes-atencao');
            const paginacaoDivId = 'paginacao-clientes-atencao-div';
            if (!tbody || !thead) return;
            // Calcular os 6 últimos meses com base no filtro
            const { month, year } = getSelectedMonthYear();
            let baseMonth, baseYear;
            if (month && year) {
                baseMonth = month - 1; // 0-based
                baseYear = year;
            } else {
                const hoje = new Date();
                baseMonth = hoje.getMonth();
                baseYear = hoje.getFullYear();
            }
            const meses = [];
            for (let i = 5; i >= 0; i--) {
                let d = new Date(baseYear, baseMonth - i, 1);
                meses.push({
                    label: d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }),
                    mes: d.getMonth(),
                    ano: d.getFullYear()
                });
            }
            // Gera o mapa de atendimentos
            const mapaAtend = gerarMapaAtendimentosPorClienteMes(resultadosData);
            // Montar cabeçalho
            thead.innerHTML = `<tr><th class=\"text-left\">Cliente</th>${meses.map(m => `<th class=\"text-center\">${m.label}</th>`).join('')}<th class=\"text-center\">Último</th><th class=\"text-center\" style=\"text-align:center;\">Ação</th></tr>`;
            // Paginação
            const pagina = PAGINACAO_CLIENTES.atencao.pagina;
            const inicio = (pagina - 1) * LINHAS_POR_PAGINA;
            const fim = inicio + LINHAS_POR_PAGINA;
            const clientesPagina = clientes.slice(inicio, fim);
            if (clientes.length === 0) {
                tbody.innerHTML = `<tr><td colspan=\"${meses.length + 2}\" class=\"text-center text-text-secondary py-8\">Nenhum cliente requer atenção.</td></tr>`;
                document.getElementById(paginacaoDivId)?.remove();
                return;
            }
            tbody.innerHTML = clientesPagina.map((cliente, idx) => {
                const atendimentosPorMes = meses.map(m => {
                    return (mapaAtend[cliente.nome] && mapaAtend[cliente.nome][`${m.ano}-${m.mes}`]) || 0;
                });
                let acaoHtml = '';
                if (!cliente.acaoBanco || cliente.acaoBanco.trim() === '') {
                    acaoHtml = `<button class=\"btn btn-primary btn-sm\" onclick=\"enviarWebhookAtencao('${cliente.nome.replace(/'/g, "\\'")}', '${cliente.idBanco || ''}', this)\">Enviar</button>`;
                } else {
                    acaoHtml = `<span class=\"font-semibold\">${cliente.acaoBanco}</span>`;
                }
                return `<tr class=\"table-row\">
                    <td class=\"px-4 py-2 font-medium\">${cliente.nome}</td>
                    ${atendimentosPorMes.map(q => `<td class=\"px-4 py-2 text-center\">${q}</td>`).join('')}
                    <td class=\"px-4 py-2 text-center\">${cliente.ultimoAtendimento || '-'}</td>
                    <td class=\"px-4 py-2 text-center\" style=\"text-align:center;\">${acaoHtml}</td>
                </tr>`;
            }).join('');
            // Adiciona controles de paginação
            let paginacaoDiv = document.getElementById(paginacaoDivId);
            if (!paginacaoDiv) {
                paginacaoDiv = document.createElement('div');
                paginacaoDiv.id = paginacaoDivId;
                tbody.parentElement.parentElement.appendChild(paginacaoDiv);
            }
            paginacaoDiv.innerHTML = renderPaginacaoClientes('atencao', clientes.length);
            let paginacaoDivTop = document.getElementById('paginacao-clientes-atencao-div-top');
            if (paginacaoDivTop) {
                paginacaoDivTop.innerHTML = renderPaginacaoClientes('atencao', clientes.length);
            }
        }

        // Função para enviar webhook e atualizar ACAO no banco
        async function enviarWebhookAtencao(cliente, id, btn) {
            if (!id) {
                showToast('Erro', 'ID do registro não encontrado.', 'error');
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            try {
                // Exemplo de payload do webhook
                const payload = {
                    cliente: cliente,
                    id: id,
                    tipo: 'atencao'
                };
                // Substitua pela URL real do seu webhook
                const webhookUrl = 'https://seu-webhook-url.com/endpoint';
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Falha ao enviar webhook');
                // Atualizar ACAO no banco de dados
                const tableName = getSelectedTableName();
                const { error } = await supabase
                    .from(tableName)
                    .update({ ACAO: 'Webhook enviado' })
                    .eq('id', id);
                if (error) throw new Error('Erro ao atualizar ACAO no banco: ' + error.message);
                btn.outerHTML = '<span class="font-semibold">Webhook enviado e ação registrada!</span>';
                showToast('Sucesso', 'Webhook enviado e ação registrada!', 'success');
            } catch (err) {
                btn.disabled = false;
                btn.textContent = 'Enviar Webhook';
                showToast('Erro', err.message, 'error');
            }
        }

        // --- XLSX Upload and Database Interaction ---
        function openUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('show');
        }

        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('show');
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('uploadStatus').classList.add('hidden');
            document.getElementById('xlsxInput').value = '';
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.xlsx')) {
                showFilePreview(file);
            } else {
                showToast('Erro', 'Por favor, selecione um arquivo XLSX válido.', 'error');
            }
        }

        function showFilePreview(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('uploadPreview').classList.remove('hidden');
            document.getElementById('processFile').disabled = false;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.xlsx')) {
                document.getElementById('xlsxInput').files = files;
                showFilePreview(files[0]);
            } else {
                showToast('Erro', 'Por favor, solte um arquivo XLSX válido.', 'error');
            }
        }

        async function processUploadedFile() {
            const file = document.getElementById('xlsxInput').files[0];
            if (!file) {
                showToast('Aviso', 'Nenhum arquivo selecionado para processar.', 'warning');
                return;
            }
            showUploadStatus('Processando arquivo...', 'info');
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        // A planilha tem headers na linha 2, e os dados começam na linha 3 (índice 2)
                        // json[0] seria a linha 1 (vazia), json[1] os headers, json[2] os dados
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                        if (json.length <= 2) { // Pelo menos 3 linhas: 1 vazia, 1 header, 1 dado
                            showUploadStatus('Dados insuficientes no arquivo.', 'error');
                            return;
                        }

                        const headers = json[1]; // A linha 2 da planilha (índice 1) contém os cabeçalhos
                        const dataRows = json.slice(2); // Os dados começam na linha 3 (índice 2)
                        
                        console.log('Cabeçalhos da planilha:', headers);

                        // Mapeamento de colunas da planilha para nomes do DB/código
                        // Os índices são baseados em 0
                        const colMapping = {
                            'Número': headers.indexOf('Número'), // Coluna B
                            'Data': headers.indexOf('Data'), // Coluna C
                            'Horário': headers.indexOf('Horário'), // Coluna D
                            'Período': headers.indexOf('Período'), // Coluna E
                            'Serviço': headers.indexOf('Serviço'), // Coluna F
                            'Tipo': headers.indexOf('Tipo'), // Coluna G
                            'Cliente': headers.indexOf('Cliente'), // Coluna I
                            'Profissionais': headers.indexOf('Profissionais'), // Coluna J
                            'Repasse (R$)': headers.indexOf('Repasse (R$)'), // Coluna K
                            'Local de Atendimento': headers.indexOf('Local de Atendimento'), // Coluna N
                            'Valor (R$)': headers.indexOf('Valor (R$)'), // Coluna O
                            'Cupom de Desconto': headers.indexOf('Cupom de Desconto'), // Coluna P
                            'Origem': headers.indexOf('Origem'), // Coluna Q
                            'Data de cadastro': headers.indexOf('Data de cadastro'), // Coluna R
                            'Dia da semana': headers.indexOf('Dia da semana') // Coluna S
                        };
                        
                        console.log('Mapeamento de colunas:', colMapping);
                        
                        // Verificar se alguma coluna obrigatória está faltando
                        const colunasObrigatorias = ['Data', 'Cliente', 'Valor (R$)', 'Serviço'];
                        const colunasFaltantes = colunasObrigatorias.filter(col => colMapping[col] === -1);
                        if (colunasFaltantes.length > 0) {
                            console.error('Colunas obrigatórias não encontradas:', colunasFaltantes);
                            showUploadStatus(`Erro: Colunas obrigatórias não encontradas: ${colunasFaltantes.join(', ')}`, 'error');
                            return;
                        }

                        let resultados = [];
                        dataRows.forEach(row => {
                            let base = {};
                            // Preencher 'base' com os valores do XLSX usando os cabeçalhos
                            base['DATA'] = (row[colMapping['Data']] || '').toString().trim();
                            base['HORARIO'] = (row[colMapping['Horário']] || '').toString().trim();
                            base['PERÍODO'] = (row[colMapping['Período']] || '').toString().trim();
                            base['SERVIÇO'] = (row[colMapping['Serviço']] || '').toString().trim();
                            base['TIPO'] = (row[colMapping['Tipo']] || '').toString().trim();
                            base['CLIENTE'] = (row[colMapping['Cliente']] || '').toString().trim();
                            // Remover barra vertical e espaços ao final do nome do cliente
                            base['CLIENTE'] = base['CLIENTE'].replace(/\|/g, '').trim();
                            base['PROFISSIONAL'] = (row[colMapping['Profissionais']] || '').toString().trim();
                            
                            // Valores numéricos - garante que são números válidos
                            const repasse = parseValueFromCurrency(row[colMapping['Repasse (R$)']] || '0');
                            const valor = parseValueFromCurrency(row[colMapping['Valor (R$)']] || '0');
                            base['REPASSE'] = isNaN(repasse) ? 0 : repasse; 
                            base['VALOR'] = isNaN(valor) ? 0 : valor;
                            
                            base['CUPOM'] = (row[colMapping['Cupom de Desconto']] || '').toString().trim();
                            base['ORIGEM'] = (row[colMapping['Origem']] || '').toString().trim();
                            base['ENDEREÇO'] = (row[colMapping['Local de Atendimento']] || '').toString().trim();
                            base['CADASTRO'] = (row[colMapping['Data de cadastro']] || '').toString().trim();
                            base['DIA'] = (row[colMapping['Dia da semana']] || '').toString().trim();
                            base['NÚMERO'] = (row[colMapping['Número']] || '').toString().trim(); // Pega o número para ATENDIMENTO_ID

                            // Conversão de formato de data para YYYY-MM-DD
                            if (base['DATA'] && base['DATA'].includes('/')) {
                                const [day, month, year] = base['DATA'].split('/');
                                base['DATA'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }
                            if (base['CADASTRO'] && base['CADASTRO'].includes('/')) {
                                const [day, month, year] = base['CADASTRO'].split('/');
                                base['CADASTRO'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }

                            // Processar cliente e telefone (se não vierem separados)
                            let cliente = base['CLIENTE'] || '';
                            let telefone = '';
                            const telMatch = cliente.match(/\(?\d{2}\)? ?\d{4,5}-?\d{4}/);
                            if (telMatch) {
                                telefone = telMatch[0].replace(/\D/g, '');
                                cliente = cliente.replace(telMatch[0], '').trim(); // Remove phone from client name
                            }
                            base['CLIENTE'] = cliente;
                            base['whatscliente'] = telefone ? `55${telefone}` : '';

                            // Handle multiple professionals and IS_DIVISAO
                            let profissionais = (base['PROFISSIONAL'] || '').split(';').map(p => p.trim()).filter(Boolean);
                            if (profissionais.length === 0) profissionais = ['SEM PROFISSIONAL'];

                            // Prioriza a coluna 'NÚMERO' para ATENDIMENTO_ID
                            const atendimentoId = base['NÚMERO'] || `${base['DATA']}_${base['CLIENTE']}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                            const repasseDividido = profissionais.length > 1 ? (base['REPASSE'] / profissionais.length) : base['REPASSE'];

                            profissionais.forEach((prof, index) => {
                                let newEntry = {
                                    ...base,
                                    PROFISSIONAL: prof,
                                    ATENDIMENTO_ID: atendimentoId, // Usa o ID processado
                                    IS_DIVISAO: profissionais.length > 1 ? (index > 0 ? 'SIM' : 'NAO') : 'NAO',
                                    REPASSE: repasseDividido // Já é numérico
                                };
                                resultados.push(newEntry);
                            });
                        });

                        if (resultados.length === 0) {
                            showUploadStatus('Nenhum dado válido encontrado para upload.', 'error');
                            return;
                        }

                        // Validação adicional dos resultados processados
                        console.log(`${resultados.length} registros processados. Amostra:`, resultados.slice(0, 3));
                        
                        // Verifica se há registro sem DATA, que é um campo essencial
                        const registrosSemData = resultados.filter(reg => !reg.DATA);
                        if (registrosSemData.length > 0) {
                            console.warn(`Atenção: ${registrosSemData.length} registros sem data encontrados!`, registrosSemData.slice(0, 3));
                        }
                        
                        showUploadStatus(`${resultados.length} registros processados.`, 'success');
                        await uploadToDatabase(resultados);

                    } catch (err) {
                        console.error('Error processing XLSX data:', err);
                        showUploadStatus('Erro ao processar arquivo: ' + err.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error in processUploadedFile:', error);
                showUploadStatus('Erro no upload: ' + error.message, 'error');
            }
        }

        async function uploadToDatabase(records) {
            showUploadStatus('Salvando no banco de dados...', 'info');
            try {
                // LOG de entrada - Para depuração
                console.log('Registros recebidos para upload:', records);
                
                // Filter records to only include VALID_FIELDS
                const cleanRecords = records.map(item => {
                    const filteredItem = {};
                    VALID_FIELDS.forEach(field => {
                        if (item.hasOwnProperty(field)) {
                            if (field === 'DATA' || field === 'CADASTRO') {
                                // Se o campo de data for uma string vazia, defina-o como null
                                filteredItem[field] = item[field] === '' ? null : item[field];
                            } else {
                                filteredItem[field] = item[field];
                            }
                        }
                    });
                    return filteredItem;
                });

                // LOG de saída - Para depuração
                console.log('Registros limpos para upload:', cleanRecords);

                // --- NOVO: Deletar registros do mesmo mês/ano antes de inserir ---
                if (cleanRecords.length > 0 && cleanRecords[0].DATA) {
                    // Extrai mês/ano do primeiro registro (assume que todos são do mesmo mês)
                    const dataStr = cleanRecords[0].DATA;
                    console.log('Data do primeiro registro:', dataStr);
                    
                    let ano, mes;
                    if (typeof dataStr === 'string' && dataStr.includes('-')) {
                        // Formato YYYY-MM-DD
                        [ano, mes] = dataStr.split('-');
                        console.log('Ano e mês extraídos:', ano, mes);
                    }
                    
                    if (ano && mes) {
                        // Deleta todos os registros do mesmo mês/ano
                        console.log('Tentando excluir registros anteriores...');
                        try {
                            const tableName = getSelectedTableName();
                            const { data, error } = await supabase
                                .from(tableName)
                                .delete()
                                .gte('DATA', `${ano}-${mes}-01`)
                                .lte('DATA', `${ano}-${mes}-31`);
                            
                            if (error) {
                                console.error(`Erro ao excluir registros anteriores da tabela ${tableName}:`, error);
                            } else {
                                console.log(`Registros anteriores excluídos com sucesso da tabela ${tableName}`);
                            }
                        } catch (err) {
                            console.error('Exceção ao excluir registros:', err);
                        }
                    }
                }
                // --- FIM NOVO ---

                const tableName = getSelectedTableName();
                console.log('Iniciando inserção no Supabase em:', tableName);
                console.log('Quantidade de registros para inserção:', cleanRecords.length);
                
                const { data, error } = await supabase
                    .from(tableName)
                    .insert(cleanRecords);

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw new Error(`Error saving data: ${error.message}`);
                }
                
                console.log('Dados inseridos com sucesso:', data);

                showToast('Sucesso', `${records.length} registros salvos com sucesso!`, 'success');
                loadResults(); // Reload dashboard data
                setTimeout(closeUploadModal, 2000);
            } catch (error) {
                console.error('Error uploading to database:', error);
                showToast('Erro', `Falha ao salvar: ${error.message}`, 'error');
            }
        }

        // --- Edit/Delete (Simplified for MVP) ---
        async function editResult(id) {
            try {
                const tableName = getSelectedTableName();
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw new Error(`Error loading record: ${error.message}`);
                if (!data) throw new Error('Record not found.');

                // Populate form
                document.getElementById('editData').value = formatDateForInput(data.DATA);
                document.getElementById('editCliente').value = data.CLIENTE || '';
                document.getElementById('editServico').value = data.SERVIÇO || '';
                // Exibe o valor numérico formatado para o usuário
                document.getElementById('editValor').value = formatCurrencyDisplay(parseValueFromCurrency(data.VALOR));
                document.getElementById('editRepasse').value = formatCurrencyDisplay(parseValueFromCurrency(data.REPASSE));
                document.getElementById('editProfissional').value = data.PROFISSIONAL || '';

                document.getElementById('editResultForm').dataset.editId = id;
                document.getElementById('editResultModal').classList.add('show');
            } catch (error) {
                showToast('Erro', `Falha ao abrir edição: ${error.message}`, 'error');
            }
        }

        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            const date = parseDate(dateStr);
            if (!date) return '';
            return date.toLocaleDateString('pt-BR');
        }

        function closeEditResultModal() {
            document.getElementById('editResultModal').classList.remove('show');
            document.getElementById('editResultForm').reset();
            delete document.getElementById('editResultForm').dataset.editId;
        }

        async function saveEditResult(e) {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.editId;
            if (!id) {
                showToast('Erro', 'ID do registro não encontrado para atualização.', 'error');
                return;
            }

            const formData = new FormData(form);
            const updatedData = Object.fromEntries(formData.entries());

            // Format data and currency fields for database insertion
            if (updatedData.DATA && updatedData.DATA.includes('/')) {
                const [day, month, year] = updatedData.DATA.split('/');
                updatedData.DATA = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            // Converte valores de moeda para número antes de enviar ao DB
            updatedData.VALOR = parseValueFromCurrency(updatedData.VALOR);
            updatedData.REPASSE = parseValueFromCurrency(updatedData.REPASSE);

            try {
                const tableName = getSelectedTableName();
                const { error } = await supabase
                    .from(tableName)
                    .update(updatedData)
                    .eq('id', id);

                if (error) throw new Error(`Error updating record: ${error.message}`);

                showToast('Sucesso', 'Registro atualizado com sucesso!', 'success');
                closeEditResultModal();
                loadResults(); // Reload data
            } catch (error) {
                showToast('Erro', `Falha ao salvar: ${error.message}`, 'error');
            }
        }

        async function deleteResult(id, clientName) {
            // Substituí o alert() por um modal de confirmação personalizado
            showCustomConfirm('Confirmar Exclusão', `Tem certeza que deseja excluir o registro de ${decodeURIComponent(clientName)}?`, async () => {
                try {
                    const tableName = getSelectedTableName();
                    const { error } = await supabase
                        .from(tableName)
                        .delete()
                        .eq('id', id);

                    if (error) throw new Error(`Error deleting record: ${error.message}`);

                    showToast('Sucesso', 'Registro excluído com sucesso!', 'success');
                    loadResults(); // Reload data
                } catch (error) {
                    showToast('Erro', `Falha ao excluir: ${error.message}`, 'error');
                }
            });
        }

        // --- Custom Confirmation Modal (Replacement for window.confirm) ---
        function showCustomConfirm(title, message, onConfirm) {
            const existingModal = document.getElementById('customConfirmModal');
            if (existingModal) existingModal.remove(); // Remove any existing modal to prevent duplicates

            const modalHtml = `
                <div id="customConfirmModal" class="modal-backdrop show">
                    <div class="modal-content-custom">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-text-primary">${title}</h2>
                            <button id="closeCustomConfirmModal" class="text-text-secondary hover:text-text-primary">
                                <i class="fas fa-times"></i>
                            </button>
          </div>
                        <p class="text-text-primary mb-6">${message}</p>
                        <div class="flex justify-end gap-3">
                            <button id="cancelCustomConfirm" class="btn btn-outline">Cancelar</button>
                            <button id="confirmCustomConfirm" class="btn btn-danger">Confirmar</button>
          </div>
      </div>
    </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('customConfirmModal');
            const closeBtn = document.getElementById('closeCustomConfirmModal');
            const cancelBtn = document.getElementById('cancelCustomConfirm');
            const confirmBtn = document.getElementById('confirmCustomConfirm');

            const closeModal = () => modal.classList.remove('show');

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            confirmBtn.addEventListener('click', () => {
                onConfirm();
                closeModal();
            });

            // Trigger animation
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // --- Utility Functions ---
        function showLoading(show) {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn?.querySelector('i');
            if (refreshBtn && icon) {
                if (show) {
                    icon.classList.add('icon-spin');
                    refreshBtn.disabled = true;
                } else {
                    icon.classList.remove('icon-spin');
                    refreshBtn.disabled = false;
                }
            }
        }

        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (!statusDiv) return;
            statusDiv.className = `mt-4 p-3 rounded-lg ${
                type === 'error' ? 'bg-danger-color text-on-accent' :
                type === 'success' ? 'bg-success-color text-on-accent' :
                'bg-info-color text-on-accent'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        function showToast(title, description, type = 'success') {
            const toastContainer = document.getElementById("toastContainer");
            if (!toastContainer) {
                console.error("Toast container not found.");
                return;
            }

            const toast = document.createElement("div");
            toast.className = `toast p-4 rounded-lg shadow-lg mb-2 transform translate-x-full transition-transform duration-300 ease-out ${
                type === 'success' ? 'bg-success-color' :
                type === 'error' ? 'bg-danger-color' :
                'bg-warning-color'
            } ${type === 'warning' ? 'text-primary' : 'text-on-accent'}`;
            toast.innerHTML = `<div class="font-bold">${title}</div><div>${description}</div>`;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                toast.style.opacity = '0'; // Fade out
                setTimeout(() => toast.remove(), 300); // Remove after transition
            }, 5000);
        }

        function renderResultsTable() {
            // This table is not part of the main dashboard view, but the original file had it.
            // Keeping it for completeness in case it's needed for debugging or future features.
            // For this specific request, the main dashboard doesn't display a large table of raw results.
            // If a table is needed, it should be added to one of the tabs.
        }

        // Helper function to format currency for storing in DB (text field)
        function formatCurrency(value) {
            if (typeof value === 'number') {
                return value.toFixed(2).replace('.', ',');
            }
            // If it's already a string, try to clean it up and format
            let str = String(value).replace(/[R$\s]/g, '');
            if (str.includes(',')) {
                str = str.replace(/\./g, '').replace(',', '.');
            }
            const num = parseFloat(str);
            return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',');
        }

        function atualizarSemanaDashboard() {
            // --- Cálculo dos atendimentos da semana ---
            const hoje = new Date();
            const diaSemana = hoje.getDay(); // 0=Domingo, 1=Segunda...
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - diaSemana + 1 + (semanaOffset * 7)); // Segunda-feira da semana com offset
            inicioSemana.setHours(0,0,0,0);
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            fimSemana.setHours(23,59,59,999);
            const dadosSemana = resultadosData.filter(item => {
                const d = parseDate(item.DATA);
                return d && d >= inicioSemana && d <= fimSemana && item.IS_DIVISAO !== 'SIM';
            });
            const totalSemana = dadosSemana.length;
            const faturamentoSemana = dadosSemana.reduce((sum, item) => sum + parseValueFromCurrency(item.VALOR), 0);
            // Novo cálculo: clientes únicos atendidos na semana
            const clientesSemanaSet = new Set(dadosSemana.map(item => item.CLIENTE).filter(Boolean));
            const clientesSemana = clientesSemanaSet.size;
            // Comercial/Residencial
            const semanaComercial = dadosSemana.filter(item => item.TIPO && item.TIPO.toUpperCase() === 'COMERCIAL').length;
            const semanaResidencial = dadosSemana.filter(item => item.TIPO && item.TIPO.toUpperCase() === 'RESIDENCIAL').length;
            const percentualComercial = totalSemana > 0 ? ((semanaComercial / totalSemana) * 100).toFixed(1) : 0;
            const percentualResidencial = totalSemana > 0 ? ((semanaResidencial / totalSemana) * 100).toFixed(1) : 0;
            // Semana anterior para comparação
            const inicioSemanaAnt = new Date(inicioSemana);
            inicioSemanaAnt.setDate(inicioSemana.getDate() - 7);
            const fimSemanaAnt = new Date(fimSemana);
            fimSemanaAnt.setDate(fimSemana.getDate() - 7);
            const dadosSemanaAnt = resultadosData.filter(item => {
                const d = parseDate(item.DATA);
                return d && d >= inicioSemanaAnt && d <= fimSemanaAnt && item.IS_DIVISAO !== 'SIM';
            });
            const totalSemanaAnt = dadosSemanaAnt.length;
            const crescimentoSemana = totalSemanaAnt > 0 ? ((totalSemana - totalSemanaAnt) / totalSemanaAnt) * 100 : (totalSemana > 0 ? 100 : 0);
            // Atualizar os elementos do card
            const updateSemana = (id, value, isCurrency = false, isPercent = false) => {
                const el = document.getElementById(id);
                if (el) {
                    let formattedValue = value;
                    if (isCurrency) formattedValue = formatCurrencyDisplay(value);
                    if (isPercent) formattedValue = `${value.toFixed ? value.toFixed(1) : value}%`;
                    el.textContent = formattedValue;
                }
            };
            updateSemana('metric-atendimentos-semana', totalSemana);
            updateSemana('metric-clientes-semana', clientesSemana);
            updateSemana('metric-faturamento-semana', faturamentoSemana, true);
            updateSemana('metric-atendimentos-semana-comercial', semanaComercial);
            updateSemana('percentual-semana-comercial', percentualComercial, false, true);
            updateSemana('metric-atendimentos-semana-residencial', semanaResidencial);
            updateSemana('percentual-semana-residencial', percentualResidencial, false, true);
            // Atualizar indicador de crescimento
            const elCrescimento = document.getElementById('atendimento-semana-crescimento');
            if (elCrescimento) {
                const growth = crescimentoSemana;
                const isPositive = growth > 0;
                const isNeutral = growth === 0;
                const iconClass = isNeutral ? 'fa-equals' : (isPositive ? 'fa-caret-up' : 'fa-caret-down');
                const colorClass = isNeutral ? 'text-text-secondary' : (isPositive ? 'text-success-color' : 'text-danger-color');
                elCrescimento.innerHTML = `
                    <span>vs. Semana Anterior</span>
                    <span><i class="fas ${iconClass} ${colorClass}"></i> ${growth.toFixed(1)}%</span>
                `;
            }
            // Atualizar intervalo de datas da semana
            const elIntervalo = document.getElementById('semana-intervalo');
            if (elIntervalo) {
                const pad = n => n.toString().padStart(2, '0');
                const inicioStr = `${pad(inicioSemana.getDate())}/${pad(inicioSemana.getMonth() + 1)}/${inicioSemana.getFullYear()}`;
                const fimStr = `${pad(fimSemana.getDate())}/${pad(fimSemana.getMonth() + 1)}/${fimSemana.getFullYear()}`;
                elIntervalo.textContent = `${inicioStr} - ${fimStr}`;
            }
        }

        document.getElementById('btn-semana-anterior').addEventListener('click', function() {
            semanaOffset--;
            atualizarSemanaDashboard();
        });
        document.getElementById('btn-semana-proxima').addEventListener('click', function() {
            semanaOffset++;
            atualizarSemanaDashboard();
        });

        // Chame a função ao carregar a página e sempre que necessário
        atualizarSemanaDashboard();

        // Lógica para alternar tabelas ao clicar nos cards
        function ativarTabelaClientes(tipo) {
            // Esconde todas as seções de tabela e remove a classe active
            document.querySelectorAll('.clientes-tabela-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('active');
            });
            
            // Remove a classe 'active' de todos os botões de filtro
            document.querySelectorAll('#client-filter-cards .client-filter-card').forEach(btn => btn.classList.remove('active'));

            let secaoParaAtivarId = '';
            let botaoParaAtivar = null;

            if (tipo === 'total') {
                secaoParaAtivarId = 'tabela-clientes-ativos-wrapper';
                botaoParaAtivar = document.getElementById('btn-clientes-total');
            } else if (tipo === 'recorrentes') {
                secaoParaAtivarId = 'tabela-clientes-recorrentes-wrapper';
                botaoParaAtivar = document.getElementById('btn-clientes-recorrentes');
            } else if (tipo === 'atencao') {
                secaoParaAtivarId = 'tabela-clientes-atencao-wrapper';
                botaoParaAtivar = document.getElementById('btn-clientes-atencao');
            } else if (tipo === 'outros') {
                secaoParaAtivarId = 'tabela-clientes-outros-wrapper'; // Mostra a nova seção para 'outros'
                botaoParaAtivar = document.getElementById('btn-clientes-outros');
            }

            // Mostra a seção correta e ativa a seção e o botão
            if (secaoParaAtivarId) {
                const secao = document.getElementById(secaoParaAtivarId);
                if (secao) {
                    secao.classList.remove('hidden');
                    secao.classList.add('active');
                }
            }
            if (botaoParaAtivar) {
                botaoParaAtivar.classList.add('active');
            }
        }
        
        // Configura os event listeners para os botões
        document.querySelectorAll('#client-filter-cards .client-filter-card[data-filter]').forEach(button => {
            button.addEventListener('click', () => {
                const filterType = button.dataset.filter;
                ativarTabelaClientes(filterType);
            });
        });

        // Ativa a tabela de clientes ativos por padrão ao carregar
        ativarTabelaClientes('total');


        // --- INÍCIO: Inicialização do menu de seleção de banco de dados ---
        function initDbSelectMenu() {
            const headerMain = document.querySelector('.header-main');
            if (!headerMain) return;
            // Remove qualquer select ou label anterior
            const oldSelect = headerMain.querySelector('#dbSelect');
            if (oldSelect) oldSelect.remove();
            const oldLabel = headerMain.querySelector('.db-title-label');
            if (oldLabel) oldLabel.remove();
            if (TABLES_AVAILABLE.length > 1) {
                // Cria o select normalmente
                const dbSelect = document.createElement('select');
                dbSelect.id = 'dbSelect';
                dbSelect.className = 'db-title-select ml-2 focus:outline-none';
                // Opção "Todos"
                const optTodos = document.createElement('option');
                optTodos.value = 'ALL';
                optTodos.textContent = 'Todos';
                dbSelect.appendChild(optTodos);
                // Opções das tabelas
                TABLES_AVAILABLE.forEach(tbl => {
                    const opt = document.createElement('option');
                    opt.value = tbl.value;
                    opt.textContent = tbl.label;
                    dbSelect.appendChild(opt);
                });
                dbSelect.value = selectedTable === 'ALL' ? 'ALL' : selectedTable;
                dbSelect.addEventListener('change', function() {
                    selectedTable = dbSelect.value;
                    localStorage.setItem('selectedTable', selectedTable);
                    loadResults();
                });
                headerMain.appendChild(dbSelect);
            } else if (TABLES_AVAILABLE.length === 1) {
                // Cria apenas o label
                const label = document.createElement('span');
                label.className = 'db-title-label';
                label.textContent = TABLES_AVAILABLE[0].label;
                headerMain.appendChild(label);
                // Garante que selectedTable esteja correto
                selectedTable = TABLES_AVAILABLE[0].value;
                localStorage.setItem('selectedTable', selectedTable);
            }
        }
        // --- FIM: Inicialização do menu de seleção de banco de dados ---

        // --- LOGIN LOGIC ---
        // Removido duplicidade das variáveis SUPABASE_URL, SUPABASE_KEY e supabase
        async function autenticarUsuario(email, senha) {
          // Em produção, use hash de senha!
          const { data, error } = await supabase
            .from('usuarios')
            .select('*')
            .eq('email', email)
            .eq('senha', senha)
            .single();
          if (error || !data) return null;
          return data;
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const senha = document.getElementById('loginPassword').value;
          const errorDiv = document.getElementById('loginErrorMessage');
          const loginButton = document.getElementById('loginButton');
          errorDiv.style.display = 'none';
          loginButton.disabled = true;
          loginButton.textContent = 'Entrando...';
          try {
            const usuario = await autenticarUsuario(email, senha);
            if (!usuario) {
              errorDiv.textContent = 'E-mail ou senha inválidos.';
              errorDiv.style.display = 'block';
              loginButton.disabled = false;
              loginButton.textContent = 'Entrar';
              return;
            }
            // Salva dados do usuário na sessão/localStorage
            localStorage.setItem('usuarioLogado', JSON.stringify(usuario));
            // Configura as tabelas/unidades do usuário
            configurarTabelasUsuario(usuario);
            // Esconde login, mostra dashboard
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            // Inicializa o dashboard agora que TABLES_AVAILABLE está preenchido
            initTheme();
            initDbSelectMenu();
            initEventListeners();
            setupCurrencyInputs();
            // Sempre inicia com o mês e ano atual
            const now = new Date();
            document.getElementById('monthFilter').value = (now.getMonth() + 1).toString();
            document.getElementById('yearFilter').value = now.getFullYear().toString();
            loadResults();
          } catch (err) {
            errorDiv.textContent = 'Erro ao conectar. Tente novamente.';
            errorDiv.style.display = 'block';
          } finally {
            loginButton.disabled = false;
            loginButton.textContent = 'Entrar';
          }
        });

        function configurarTabelasUsuario(usuario) {
          // Monta array de unidades/tabelas do usuário
          const unidades = [];
          if (usuario.unidade && usuario.tabela) unidades.push({ label: usuario.unidade, value: usuario.tabela });
          if (usuario["unidade 2"] && usuario["tabela_unidade 2"]) unidades.push({ label: usuario["unidade 2"], value: usuario["tabela_unidade 2"] });
          if (usuario["unidade 3"] && usuario["tabela_unidade 3"]) unidades.push({ label: usuario["unidade 3"], value: usuario["tabela_unidade 3"] });
          if (usuario["unidade 4"] && usuario["tabela_unidade 4"]) unidades.push({ label: usuario["unidade 4"], value: usuario["tabela_unidade 4"] });
          if (usuario["unidade 5"] && usuario["tabela_unidade 5"]) unidades.push({ label: usuario["unidade 5"], value: usuario["tabela_unidade 5"] });
          if (usuario["unidade 6"] && usuario["tabela_unidade 6"]) unidades.push({ label: usuario["unidade 6"], value: usuario["tabela_unidade 6"] });
          if (usuario["unidade 7"] && usuario["tabela_unidade 7"]) unidades.push({ label: usuario["unidade 7"], value: usuario["tabela_unidade 7"] });
          if (usuario["unidade 8"] && usuario["tabela_unidade 8"]) unidades.push({ label: usuario["unidade 8"], value: usuario["tabela_unidade 8"] });
          if (usuario["unidade 9"] && usuario["tabela_unidade 9"]) unidades.push({ label: usuario["unidade 9"], value: usuario["tabela_unidade 9"] });
          if (usuario["unidade 10"] && usuario["tabela_unidade 10"]) unidades.push({ label: usuario["unidade 10"], value: usuario["tabela_unidade 10"] });
          // Atualiza TABLES_AVAILABLE e selectedTable
          window.TABLES_AVAILABLE = unidades.length > 0 ? unidades : [];
          window.selectedTable = unidades.length === 1 ? unidades[0].value : (unidades.length > 1 ? unidades[0].value : null);
          localStorage.setItem('selectedTable', window.selectedTable);
        }

        // Ao carregar a página, verifica se já está logado
        window.addEventListener('DOMContentLoaded', function() {
          const usuario = localStorage.getItem('usuarioLogado');
          if (usuario) {
            const userObj = JSON.parse(usuario);
            configurarTabelasUsuario(userObj);
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            // Inicializa o dashboard para usuário já logado
            initTheme();
            initDbSelectMenu();
            initEventListeners();
            setupCurrencyInputs();
            // Sempre inicia com o mês e ano atual
            const now = new Date();
            document.getElementById('monthFilter').value = (now.getMonth() + 1).toString();
            document.getElementById('yearFilter').value = now.getFullYear().toString();
            loadResults();
          } else {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('dashboard-container').style.display = 'none';
          }
        });

        // Lógica do modal de configuração de usuário
        const formConfigUsuario = document.getElementById('formConfigUsuario');
        if (formConfigUsuario) {
          formConfigUsuario.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('configEmail').value;
            const senha = document.getElementById('configSenha').value;
            const confirmarSenha = document.getElementById('configConfirmarSenha').value;
            const erroDiv = document.getElementById('erroConfigUsuario');
            erroDiv.style.display = 'none';
            if (senha && senha.length > 0 && senha.length < 6) {
              erroDiv.textContent = 'A senha deve ter pelo menos 6 caracteres.';
              erroDiv.style.display = 'block';
              return;
            }
            if (senha && senha !== confirmarSenha) {
              erroDiv.textContent = 'As senhas não coincidem.';
              erroDiv.style.display = 'block';
              return;
            }
            // Pega usuário logado do localStorage
            let usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuario || !usuario.id) {
              erroDiv.textContent = 'Usuário não encontrado.';
              erroDiv.style.display = 'block';
              return;
            }
            // Monta objeto de update
            const updateObj = { email };
            if (senha) updateObj.senha = senha;
            // Atualiza o email e/ou senha no Supabase
            const { error } = await supabase
              .from('usuarios')
              .update(updateObj)
              .eq('id', usuario.id);
            if (error) {
              erroDiv.textContent = 'Erro ao atualizar informações. Tente novamente.';
              erroDiv.style.display = 'block';
              return;
            }
            // Atualiza localStorage
            usuario.email = email;
            if (senha) usuario.senha = senha;
            localStorage.setItem('usuarioLogado', JSON.stringify(usuario));
            // Fecha modal
            document.getElementById('configModal').classList.remove('show');
            showToast('Sucesso', 'Informações atualizadas com sucesso!', 'success');
          });
        }


    </script>
</body>
</html>
