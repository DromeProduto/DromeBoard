<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DromeFlow - Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- SheetJS for XLSX parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Dashboard Components CSS -->
    <link rel="stylesheet" href="dashboard/styles/dashboard-components.css">
    <link rel="stylesheet" href="dashboard/styles/dashboard-charts.css">
    <link rel="stylesheet" href="dashboard/styles/dashboard-responsive.css">
    
    <!-- Dashboard Components JS -->
    <script src="dashboard/components/metrics-cards.js" onload="console.log('✅ metrics-cards.js carregado')" onerror="console.error('❌ Erro ao carregar metrics-cards.js')"></script>
    <script src="dashboard/components/charts.js" onload="console.log('✅ charts.js carregado')" onerror="console.error('❌ Erro ao carregar charts.js')"></script>
    <script src="dashboard/components/recent-activities.js" onload="console.log('✅ recent-activities.js carregado')" onerror="console.error('❌ Erro ao carregar recent-activities.js')"></script>
    <script src="dashboard/components/alerts-panel.js" onload="console.log('✅ alerts-panel.js carregado')" onerror="console.error('❌ Erro ao carregar alerts-panel.js')"></script>
    
    <style>
        /* --- Variáveis de Tema --- */
        :root {
            /* Cores de Acento e Ação (Tema Claro) */
            --accent-primary: #ac009e;   /* Magenta (Nova paleta) */
            --accent-secondary: #fd24a0; /* Pink (Nova paleta) */
            
            /* Cores Semânticas */
            --success-color: #70e000;    /* Verde (Nova paleta) */
            --warning-color: #f88f0b;    /* Laranja (Nova paleta) */
            --danger-color: #ef476f;     /* Vermelho (Mantido) */
            --info-color: #00d5ff;       /* Ciano (Nova paleta) */

            /* Paleta de Cores Adicional (para gráficos, etc.) */
            --brand-magenta: #ccff33;
            --brand-pink: #fd24a0;
            --brand-lime: #ccff33;
            --brand-green: #70e000;
            --brand-cyan: #00d5ff;
            --brand-orange: #f88f0b;
            --brand-dark-blue: #010d32;
            --brand-snow-white: #fffafa;
            
            /* Tema Claro (Padrão) - Melhorado */
            --bg-primary: #f8fafc;        /* Fundo principal - azul-cinza muito claro */
            --bg-secondary: #ffffff;      /* Fundo de cards, modais (branco puro) */
            --bg-tertiary: #f1f5f9;       /* Fundo de elementos aninhados - azul-cinza claro */
            
            --text-primary: #1e293b;      /* Texto principal - azul-cinza escuro moderno */
            --text-secondary: #64748b;    /* Texto secundário - cinza-azul médio */
            --text-accent: var(--accent-primary);
            --text-on-accent: #ffffff;    /* Texto sobre fundos de acento */
            
            --border-primary: #e2e8f0;      /* Bordas principais - azul-cinza suave */
            --border-secondary: #cbd5e1;    /* Bordas de inputs - azul-cinza médio */
            --border-accent: var(--accent-primary);
            
            /* Estados de hover e foco - Light Mode */
            --hover-overlay: rgba(148, 163, 184, 0.05);
            --focus-ring: rgba(172, 0, 158, 0.15);

            /* Sombras - Melhoradas */
            --shadow-color-rgb: 30, 41, 59;
            --shadow-sm: 0 1px 3px rgba(var(--shadow-color-rgb), 0.05);
            --shadow-md: 0 2px 8px rgba(var(--shadow-color-rgb), 0.08);
            --shadow-lg: 0 4px 16px rgba(var(--shadow-color-rgb), 0.12);

            /* Outras variáveis de layout */
            --border-radius: 10px;
            --border-radius-lg: 16px;
            --transition-fast: 0.13s cubic-bezier(0.4,0,0.2,1);
            --transition-normal: 0.22s cubic-bezier(0.4,0,0.2,1);
            --transition-slow: 0.33s cubic-bezier(0.4,0,0.2,1);
            --spacing-xs: 0.375rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1.25rem;
            --spacing-lg: 2rem;
            --spacing-xl: 2.5rem;

            /* Adicionado para usar em rgba() */
            --brand-cyan-rgb: 0, 213, 255;
            --success-color-rgb: 112, 224, 0;
            --warning-color-rgb: 248, 143, 11;
            --accent-secondary-rgb: 253, 36, 160;
            --brand-magenta-rgb: 172, 0, 158;
            --brand-green-rgb: 112, 224, 0;
            --brand-orange-rgb: 248, 143, 11;
        }

        /* Tema Escuro - Para modo dark */
        body.dark {
            /* Cores de Acento e Ação */
            --accent-primary: #fd24a0;   /* Pink (Nova paleta) */
            --accent-secondary: #ac009e; /* Magenta (Nova paleta) */

            /* Tema Escuro */
            --bg-primary: #010d32;      /* Fundo principal (Novo azul da marca) */
            --bg-secondary: #0b1a4c;    /* Fundo de cards (tom mais claro do novo azul) */
            --bg-tertiary: #11225a;     /* Fundo de elementos aninhados, hovers */
            
            --text-primary: #fffafa;     /* Texto principal (Novo branco 'snow') */
            --text-secondary: #a3aed0;   /* Mantido para bom contraste */
            
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-secondary: rgba(255, 255, 255, 0.18);
            
            /* Sombras */
            --shadow-color-rgb: 0, 0, 0;
            --shadow-sm: 0 1px 4px rgba(var(--shadow-color-rgb), 0.18);
            --shadow-md: 0 3px 10px rgba(var(--shadow-color-rgb), 0.22);
            --shadow-lg: 0 6px 20px rgba(var(--shadow-color-rgb), 0.25);
        }

        /* Estilos globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            font-size: 1.05rem;
            line-height: 1.7;
            letter-spacing: 0.01em;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            overflow-x: hidden;
        }

        /* --- Layout Geral --- */
        .app-container { 
            display: flex; 
            height: 100vh; 
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-normal), background-color var(--transition-normal), opacity var(--transition-fast);
            flex-shrink: 0;
            z-index: 40;
            position: fixed;
            top: 80px; /* Altura do header */
            left: 0;
            height: calc(100vh - 80px); /* Altura total menos a altura do header */
            /* **OTIMIZAÇÃO:** Prevenir FOUC no carregamento */
            opacity: 1;
        }

        /* **CORREÇÃO:** CSS para forçar visibilidade dos Menus de Gestão para super_admin */
        .nav-item.show-for-super-admin {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Manter regras existentes de visibilidade */
        #menu-gestao-unidades,
        #menu-gestao-usuarios {
            display: none; /* Ocultar por padrão */
        }

        /* **NOVO:** Estado de carregamento para prevenir flickering */
        .sidebar.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .sidebar.collapsed {
            width: 72px;
        }

        /* **NOVO:** Shimmer effect para loading */
        .sidebar-loading {
            background: linear-gradient(90deg, 
                var(--bg-tertiary) 25%, 
                var(--border-primary) 50%, 
                var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* --- Conteúdo Principal --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-primary);
            margin-left: 72px; /* Iniciar com margem para sidebar collapsed */
            padding-top: 80px; /* Espaço para o header fixo */
            transition: margin-left 0.3s ease;
        }

        /* Ajuste para quando sidebar está expandido */
        .sidebar:not(.collapsed) + .main-content {
            margin-left: 280px;
        }

        /* Menu de Navegação */
        .sidebar-nav {
            flex: 1;
            padding: var(--spacing-md) 0;
            overflow-y: auto;
        }

        .nav-item {
            margin: 0 var(--spacing-md) var(--spacing-xs) var(--spacing-md);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .nav-link.active {
            color: var(--accent-primary);
            background-color: rgba(var(--brand-magenta-rgb), 0.1);
        }

        .nav-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            transition: width var(--transition-normal);
        }

        /* Centralizar ícones quando sidebar collapsed */
        .sidebar.collapsed .nav-icon {
            width: 100%;
            text-align: center;
        }

        /* Ajustar padding dos links quando collapsed */
        .sidebar.collapsed .nav-link {
            padding: var(--spacing-sm);
            justify-content: center;
        }

        .nav-text {
            white-space: nowrap;
            transition: opacity var(--transition-normal);
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .nav-arrow {
            margin-left: auto;
            font-size: 0.8rem;
            transition: transform var(--transition-fast);
        }

        .nav-link.expanded .nav-arrow {
            transform: rotate(90deg);
        }

        .sidebar.collapsed .nav-arrow {
            display: none;
        }

        /* Submenus */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
            margin-left: calc(var(--spacing-md) + 20px + var(--spacing-sm));
        }

        .submenu.expanded {
            max-height: 200px;
        }

        .sidebar.collapsed .submenu {
            display: none;
        }

        .submenu-item {
            margin: var(--spacing-xs) 0;
        }

        .submenu-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-md);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 400;
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }

        .submenu-link:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .submenu-link.active {
            color: var(--accent-primary);
            background-color: rgba(var(--brand-magenta-rgb), 0.08);
        }

        /* Footer da Sidebar */
        .sidebar-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            transition: background-color var(--transition-fast);
        }

        /* Centralizar user-info quando sidebar collapsed */
        .sidebar.collapsed .user-info {
            justify-content: center;
            padding: var(--spacing-sm);
        }

        .user-info:hover {
            background-color: var(--hover-overlay);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-on-accent);
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            min-width: 0;
            transition: opacity var(--transition-normal);
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Conteúdo Principal --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-primary);
        }

        /* Cabeçalho Principal */
        .main-header {
            padding: 0 var(--spacing-md); /* Diminuído de var(--spacing-lg) para var(--spacing-md) */
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 80px;
            background-color: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .header-left .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            white-space: nowrap;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .bg-tertiary {
            background-color: var(--bg-tertiary);
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .font-semibold {
            font-weight: 600;
        }

        .text-text-secondary {
            color: var(--text-secondary);
        }

        .ml-2 {
            margin-left: 0.5rem;
        }

        .ml-3 {
            margin-left: 0.75rem;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .shadow-sm {
            box-shadow: var(--shadow-sm);
        }

        .border {
            border-width: 1px;
        }

        .border-border-primary {
            border-color: var(--border-primary);
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .focus\:outline-none:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }

        .theme-toggle:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }

        .refresh-btn:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
            color: var(--accent-primary);
        }

        /* Debug button styling */
        .debug-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
            opacity: 0.7;
        }

        .debug-btn:hover {
            color: #17a2b8;
            background-color: var(--hover-overlay);
            opacity: 1;
        }

        .debug-btn:active {
            transform: scale(0.95);
        }

        .upload-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }

        .upload-btn:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .upload-btn:active {
            transform: scale(0.95);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Estilo do botão de alertas - Padronizado com outros ícones do header */
        .alerts-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }

        .alerts-btn:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        .alerts-btn:active {
            transform: scale(0.95);
        }

        /* Painel de Alertas - REMOVIDO */
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Cards de Métricas Principais --- */
        .metrics-grid {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 1.5rem !important;
            margin-bottom: 2rem !important;
            min-width: 0 !important;
        }

        .metric-card {
            min-width: 0 !important;
            overflow: hidden !important;
        }

        .metric-card h3 {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* Responsividade para telas menores - manter sempre 4 colunas */
        @media (max-width: 1200px) {
            .metrics-grid {
                gap: 1rem !important;
            }
            .metric-card {
                padding: 1rem !important;
            }
        }

        @media (max-width: 900px) {
            .metrics-grid {
                gap: 0.75rem !important;
            }
            .metric-card {
                padding: 0.75rem !important;
                height: 140px !important;
            }
            .metric-card h3 {
                font-size: 0.8rem !important;
            }
            .metric-value {
                font-size: 1.75rem !important;
            }
        }

        @media (max-width: 700px) {
            .metrics-grid {
                gap: 0.5rem !important;
            }
            .metric-card {
                padding: 0.5rem !important;
                height: 120px !important;
            }
            .metric-card h3 {
                font-size: 0.75rem !important;
            }
            .metric-value {
                font-size: 1.5rem !important;
            }
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Área de Conteúdo */
        .content-area {
            flex: 1;
            padding: var(--spacing-sm); /* Diminuído de var(--spacing-lg) para var(--spacing-sm) */
            overflow-y: auto;
        }

        /* Iframe Styles */
        .content-area iframe {
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .modal-backdrop.show {
            opacity: 1;
            display: flex;
        }

        .modal-content-custom {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            opacity: 0;
            transition: all var(--transition-normal);
        }

        .modal-backdrop.show .modal-content-custom {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            color: var(--text-primary);
            background-color: var(--hover-overlay);
        }

        /* Drop Zone Styles */
        .drop-zone {
            border: 2px dashed var(--border-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            text-align: center;
            background-color: var(--bg-tertiary);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--accent-primary);
            background-color: rgba(var(--brand-magenta-rgb), 0.1);
        }

        .drop-zone i {
            font-size: 3rem;
            color: var(--accent-primary);
            margin-bottom: var(--spacing-md);
        }

        .drop-zone p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .file-input {
            display: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-outline:hover {
            background-color: var(--hover-overlay);
            border-color: var(--accent-primary);
        }

        .upload-status {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            display: none;
        }

        .upload-status.success {
            background-color: rgba(var(--success-color-rgb), 0.1);
            color: var(--success-color);
            border: 1px solid rgba(var(--success-color-rgb), 0.3);
        }

        .upload-status.error {
            background-color: rgba(239, 71, 111, 0.1);
            color: #ef476f;
            border: 1px solid rgba(239, 71, 111, 0.3);
        }

        .upload-status.info {
            background-color: rgba(var(--brand-cyan-rgb), 0.1);
            color: var(--info-color);
            border: 1px solid rgba(var(--brand-cyan-rgb), 0.3);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 50;
                height: calc(100vh - 80px);
                top: 80px;
                transition: left var(--transition-normal);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .page-title {
                font-size: 1rem;
            }

            .content-area {
                padding: var(--spacing-xs); /* Ainda menor em mobile */
            }

            .main-header {
                padding: 0 var(--spacing-sm); /* Menor padding em mobile */
                flex-wrap: wrap;
            }

            .header-left {
                flex-wrap: wrap;
                gap: var(--spacing-sm);
            }

            .header-center {
                width: 100%;
                order: 3;
                margin-top: var(--spacing-sm);
            }

            .header-center .flex {
                justify-content: center;
                flex-wrap: wrap;
                gap: var(--spacing-xs);
            }

            .db-title-select {
                font-size: 0.9rem;
            }
        }

        /* --- Prevenção de FOUC (Flash of Unstyled Content) --- */
        /* Prevenir piscar do sidebar - iniciar collapsed por padrão */
        #sidebar {
            opacity: 0;
            transition: opacity 0.3s ease, width 0.3s ease;
        }
        
        /* Aplicar largura collapsed apenas quando tem a classe */
        #sidebar.collapsed {
            width: 72px;
        }
        
        /* Esconder textos e detalhes quando collapsed por padrão */
        #sidebar.collapsed .nav-text,
        #sidebar.collapsed .user-details,
        #sidebar.collapsed .submenu {
            opacity: 0;
            display: none;
        }

        #sidebar.loaded {
            opacity: 1;
        }

        /* Loading state para métricas */
        .metrics-loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .metrics-loading .metric-value {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* --- NOVO: Estilo do select de unidade para parecer parte do título --- */
        .db-title-select {
            background: transparent;
            color: #ccff33;
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            outline: none;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: none;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            white-space: nowrap;
        }

        .db-title-select:focus, .db-title-select:hover {
            background: var(--bg-tertiary);
        }

        .db-title-select option {
            color: var(--text-primary);
            background: var(--bg-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .db-title-select {
                font-size: 1rem;
                padding: 0 0.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Cabeçalho Principal -->
        <header class="main-header">
            <div class="header-left">
                <div class="logo-text">DromeFlow</div>
                <select id="unitSelect" class="db-title-select" onchange="handleUnitChange()">
                    <!-- Opções serão preenchidas via JS -->
                </select>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="header-center flex-grow">
                <div class="flex items-center gap-2 bg-tertiary rounded-md px-3 py-1 shadow-sm border border-border-primary">
                    <label class="text-xs font-semibold text-text-secondary">Mês</label>
                    <select id="monthFilter" class="db-title-select ml-2 focus:outline-none">
                        <option value="">Todos</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                    <label class="text-xs font-semibold text-text-secondary ml-3">Ano</label>
                    <select id="yearFilter" class="db-title-select ml-2 focus:outline-none">
                        <option value="">Todos</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
            </div>
            <div class="header-right">
                <button class="upload-btn" id="uploadBtn" onclick="openUploadModal()" title="Upload de arquivo XLSX">
                    <i class="fas fa-upload"></i>
                </button>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshCurrentModule()" title="Atualizar dados do módulo">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="debug-btn" id="debugBtn" onclick="debugDatabaseData()" title="Debug: Verificar dados disponíveis">
                    <i class="fas fa-search"></i>
                </button>
                <button class="alerts-btn" id="alertsBtn" onclick="toggleAlertsPanel()" title="Alertas e Notificações">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar collapsed" id="sidebar">
            <!-- Navegação -->
            <nav class="sidebar-nav">

                <div class="nav-item">
                    <a href="#" class="nav-link active" data-module="dashboard">
                        <i class="nav-icon fas fa-chart-pie"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </div>

                <!-- Agenda -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-module="agenda">
                        <i class="nav-icon fas fa-calendar-alt"></i>
                        <span class="nav-text">Agenda</span>
                    </a>
                </div>

                <!-- Pós-Venda -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-module="pos-venda">
                        <i class="nav-icon fas fa-handshake"></i>
                        <span class="nav-text">Pós-Venda</span>
                    </a>
                </div>

                <!-- Recrutamento -->
                <div class="nav-item">
                    <a href="#" class="nav-link" data-module="recrutamento">
                        <i class="nav-icon fas fa-users"></i>
                        <span class="nav-text">Recrutamento</span>
                    </a>
                </div>
            </nav>

            <!-- Footer da Sidebar -->
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        U
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Usuário</div>
                        <div class="user-role" id="userRole">user</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <!-- Área de Conteúdo -->
            <div class="content-area" id="contentArea">
                <!-- Conteúdo será carregado dinamicamente aqui -->
            </div>
        </main>
    </div>

    <!-- Modal Upload XLSX -->
    <div id="uploadModal" class="modal-backdrop">
        <div class="modal-content-custom">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Arquivo XLSX</h3>
                <button class="modal-close" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p><strong>Clique aqui ou arraste seu arquivo XLSX</strong></p>
                <p>Formatos aceitos: .xlsx</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx" onchange="handleFileSelect(event)">
            </div>
            
            <div id="filePreview" style="margin-top: 1rem; display: none;">
                <div style="padding: 1rem; background-color: var(--bg-tertiary); border-radius: var(--border-radius); margin-bottom: 1rem;">
                    <p><strong>Arquivo selecionado:</strong> <span id="fileName"></span></p>
                    <p><strong>Tamanho:</strong> <span id="fileSize"></span></p>
                </div>
            </div>
            
            <div class="upload-status" id="uploadStatus"></div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn-outline" onclick="closeUploadModal()">Cancelar</button>
                <button class="btn-primary" id="uploadBtn2" onclick="processUploadedFile()" disabled>
                    <i class="fas fa-upload"></i>
                    Enviar Arquivo
                </button>
            </div>
        </div>
    </div>

    <script>
        // Gerenciamento de tema
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        // Carregar tema salvo ou definir dark como padrão
        const savedTheme = localStorage.getItem('theme') || 'dark';
        body.classList.toggle('dark', savedTheme === 'dark');
        document.documentElement.setAttribute('data-theme', savedTheme === 'dark' ? 'dark' : 'light');
        updateThemeIcon();
        
        // Salvar o tema padrão se não existir
        if (!localStorage.getItem('theme')) {
            localStorage.setItem('theme', 'dark');
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const theme = body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
            
            // Sincronizar tema com iframe se existir
            syncThemeWithIframe();
        });

        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('dark')) {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        // Gerenciamento da sidebar
        const sidebar = document.getElementById('sidebar');

        // Adicionar funcionalidade de clique no sidebar para recolher
        sidebar.addEventListener('click', (e) => {
            // Verificar se o clique foi em uma área vazia (não em menus)
            if (e.target === sidebar || e.target.classList.contains('sidebar-nav')) {
                sidebar.classList.toggle('collapsed');
            }
        });

        // Gerenciamento dos menus - REMOVIDO para usar event listeners dinâmicos
        // Os event listeners agora são criados dinamicamente em reassignEventListeners()
        const pageTitle = document.getElementById('pageTitle');

        function loadModuleContent(module) {
            console.log('📁 loadModuleContent chamada para módulo:', module);
            
            const contentArea = document.getElementById('contentArea');
            const pageTitle = document.getElementById('pageTitle');
            
            // Módulos que têm páginas separadas - carregam em iframe para manter o sidebar
            // **CORREÇÃO:** Aceitar tanto 'unidade' quanto 'unidades'
            if (module === 'unidade' || module === 'unidades') {
                console.log('🏢 Carregando iframe gestao-unidades.html...');
                pageTitle.textContent = 'Gestão de Unidades';
                contentArea.innerHTML = `
                    <iframe 
                        src="gestao-unidades.html" 
                        style="width: 100%; height: 85vh; border: none; border-radius: var(--border-radius); margin: 0;"
                        frameborder="0"
                        onload="syncThemeWithIframe()">
                    </iframe>
                `;
                console.log('✅ Iframe gestao-unidades.html carregado');
                return;
            }

            if (module === 'usuarios') {
                pageTitle.textContent = 'Gestão de Usuários';
                contentArea.innerHTML = `
                    <iframe 
                        src="gestao-usuarios.html" 
                        style="width: 100%; height: 85vh; border: none; border-radius: var(--border-radius); margin: 0;"
                        frameborder="0"
                        onload="syncThemeWithIframe()">
                    </iframe>
                `;
                return;
            }
            
            // Para outros módulos, resetar o título para simples
            if (module === 'dashboard') {
                pageTitle.textContent = 'Dashboard';
                loadDashboardContent();
                return;
            } else {
                const moduleNames = {
                    'usuarios': 'Gestão de Usuários',
                    'agenda': 'Agenda',
                    'pos-venda': 'Pós-Venda',
                    'recrutamento': 'Recrutamento'
                };
                pageTitle.textContent = moduleNames[module] || 'Dashboard';
            }
            
            // Placeholder para demonstração
            const content = {
                'usuarios': `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-users-cog" style="font-size: 4rem; color: var(--accent-primary); margin-bottom: 2rem;"></i>
                        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Gestão de Usuários</h2>
                        <p style="font-size: 1.1rem; color: var(--text-secondary);">Cadastro e gerenciamento de usuários do sistema.</p>
                    </div>
                `,
                'agenda': `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-calendar-alt" style="font-size: 4rem; color: var(--accent-primary); margin-bottom: 2rem;"></i>
                        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Agenda</h2>
                        <p style="font-size: 1.1rem; color: var(--text-secondary);">Gerenciamento de compromissos e agendamentos.</p>
                    </div>
                `,
                'pos-venda': `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-handshake" style="font-size: 4rem; color: var(--accent-primary); margin-bottom: 2rem;"></i>
                        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Pós-Venda</h2>
                        <p style="font-size: 1.1rem; color: var(--text-secondary);">Acompanhamento e suporte pós-venda.</p>
                    </div>
                `,
                'recrutamento': `
                    <div style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-user-plus" style="font-size: 4rem; color: var(--accent-primary); margin-bottom: 2rem;"></i>
                        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Recrutamento</h2>
                        <p style="font-size: 1.1rem; color: var(--text-secondary);">Processo de recrutamento e seleção.</p>
                    </div>
                `
            };
            
            contentArea.innerHTML = content[module] || '<div style="text-align: center; padding: 4rem 2rem;"><p>Módulo não encontrado</p></div>';
        }

        // Função para atualizar o módulo atual
        function refreshCurrentModule() {
            const refreshBtn = document.querySelector('.refresh-btn');
            
            if (refreshBtn.disabled) return;
            
            // Adicionar estado de loading
            refreshBtn.disabled = true;
            refreshBtn.classList.add('loading');
            
            const contentArea = document.getElementById('contentArea');
            
            if (contentArea && contentArea.innerHTML.includes('dashboard-container')) {
                console.log('🔄 Atualizando dashboard com todos os dados...');
                
                // **OTIMIZAÇÃO:** Forçar recarregamento completo das métricas
                loadDashboardMetrics().finally(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('loading');
                    showRefreshFeedback();
                });
                
            } else {
                // Para outros módulos com iframe
                const iframe = document.querySelector('#contentArea iframe');
                if (iframe) {
                    console.log('🔄 Recarregando iframe...');
                    iframe.src = iframe.src;
                    
                    iframe.onload = () => {
                        refreshBtn.disabled = false;
                        refreshBtn.classList.remove('loading');
                        showRefreshFeedback();
                    };
                    
                    // Fallback se onload não disparar
                    setTimeout(() => {
                        refreshBtn.disabled = false;
                        refreshBtn.classList.remove('loading');
                    }, 3000);
                } else {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('loading');
                }
            }
        }

        // Função para mostrar feedback visual de atualização
        function showRefreshFeedback() {
            const pageTitle = document.getElementById('pageTitle');
            
            // Feedback temporário no título
            const originalTitle = pageTitle.textContent;
            pageTitle.innerHTML = `<i class="fas fa-check" style="color: var(--success-color); margin-right: 0.5rem;"></i>${originalTitle}`;
            
            // Remover feedback após 2 segundos
            setTimeout(() => {
                pageTitle.textContent = originalTitle;
            }, 2000);
        }

        // Função de logout CORRIGIDA
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                // Mostrar loading
                const logoutBtn = document.querySelector('.logout-btn');
                const originalText = logoutBtn.innerHTML;
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saindo...';
                logoutBtn.disabled = true;
                
                fetch('./auth/logout.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Erro no logout');
                })
                .then(data => {
                    if (data.success) {
                        // Limpar dados locais
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // Redirecionar
                        window.location.href = data.redirect || 'login.html';
                    } else {
                        throw new Error(data.message || 'Erro no logout');
                    }
                })
                .catch(error => {
                    console.error('Erro no logout:', error);
                    // Mesmo com erro, forçar logout
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                })
                .finally(() => {
                    // Restaurar botão em caso de erro
                    if (logoutBtn) {
                        logoutBtn.innerHTML = originalText;
                        logoutBtn.disabled = false;
                    }
                });
            }
        }

        // Carregar dados do usuário da sessão
        function loadUserData() {
            try {
                console.log('👤 Carregando dados do usuário...');
                
                const userSession = localStorage.getItem('userSession');
                
                if (!userSession) {
                    console.error('❌ Sessão não encontrada');
                    return; // NÃO redirecionar aqui
                }

                const user = JSON.parse(userSession);
                console.log('📋 Dados da sessão:', user);
                
                // **CORREÇÃO:** Verificação mais robusta
                if (!user || !user.id) {
                    console.error('❌ Dados de usuário inválidos:', user);
                    return;
                }
                
                // **CORREÇÃO:** Mostrar sidebar imediatamente
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.opacity = '1';
                    sidebar.style.display = 'flex';
                    console.log('✅ Sidebar exibido');
                }
                
                // Atualizar interface
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && user.name) {
                    userAvatar.textContent = user.name.charAt(0).toUpperCase();
                    console.log('✅ Avatar atualizado');
                }
                
                const userName = document.getElementById('userName');
                if (userName && user.name) {
                    userName.textContent = user.name;
                    console.log('✅ Nome atualizado');
                }
                
                const userRole = document.getElementById('userRole');
                if (userRole && user.role_name) {
                    userRole.textContent = user.role_display || user.role_name;
                    console.log('✅ Role atualizada');
                }
                
                // **CORREÇÃO:** Controle dos Menus de Gestão - CORRIGIDO
                const menuGestaoUnidades = document.getElementById('menu-gestao-unidades');
                const menuGestaoUsuarios = document.getElementById('menu-gestao-usuarios');
                
                if (user.role_name === 'super_admin') {
                    if (menuGestaoUnidades) {
                        menuGestaoUnidades.style.display = 'block';
                        menuGestaoUnidades.classList.add('show-for-super-admin');
                    }
                    if (menuGestaoUsuarios) {
                        menuGestaoUsuarios.style.display = 'block';
                        menuGestaoUsuarios.classList.add('show-for-super-admin');
                    }
                    console.log('✅ Menus de Gestão liberados para:', user.name);
                } else {
                    if (menuGestaoUnidades) {
                        menuGestaoUnidades.style.display = 'none';
                        menuGestaoUnidades.classList.remove('show-for-super-admin');
                    }
                    if (menuGestaoUsuarios) {
                        menuGestaoUsuarios.style.display = 'none';
                        menuGestaoUsuarios.classList.remove('show-for-super-admin');
                    }
                    console.log('ℹ️ Menus de Gestão ocultos para role:', user.role_name);
                }
                
                // **CORREÇÃO:** Carregar unidades de forma assíncrona
                setTimeout(() => {
                    loadUserUnits(user);
                }, 100);
                
                // **CORREÇÃO:** Carregar módulos depois das unidades
                setTimeout(() => {
                    if (user.unit_id) {
                        loadUserModules(user.unit_id);
                    } else {
                        console.warn('⚠️ Usuário sem unidade, carregando módulos padrão');
                        loadDefaultModules();
                    }
                }, 300);
                
                // **CORREÇÃO:** Garantir que event listeners sejam aplicados após carregamento
                setTimeout(() => {
                    reassignEventListeners();
                }, 500);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados do usuário:', error);
                // **CORREÇÃO:** Mostrar sidebar mesmo com erro
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.opacity = '1';
                    sidebar.style.display = 'flex';
                }
                // **CORREÇÃO:** Não forçar logout, apenas log do erro
                alert('Erro ao carregar dados do usuário. Alguns recursos podem não funcionar.');
            }
        }

        // Carregar unidades conectadas ao usuário
        async function loadUserUnits(user) {
            try {
                const unitSelect = document.getElementById('unitSelect');
                if (!unitSelect) return;

                console.log('🔄 Carregando unidades conectadas ao usuário:', user.name);
                
                // **OTIMIZAÇÃO:** Verificar cache primeiro
                let unitsData = null;
                const cachedUnits = localStorage.getItem('unitsCache');
                
                if (cachedUnits && isCacheValid()) {
                    unitsData = JSON.parse(cachedUnits);
                    console.log('✅ Usando unidades do cache');
                } else {
                    // Buscar do servidor se não há cache válido
                    const response = await fetch(`./api/units.php?action=list`);
                    const data = await response.json();
                    
                    if (data.success && data.units) {
                        unitsData = data.units;
                        // **CACHE:** Salvar para próximas cargas
                        localStorage.setItem('unitsCache', JSON.stringify(unitsData));
                        localStorage.setItem('cacheTimestamp', Date.now().toString());
                        console.log('✅ Unidades carregadas e salvas no cache');
                    }
                }
                
                if (unitsData) {
                    // Limpar select
                    unitSelect.innerHTML = '';
                    
                    // Se o usuário for super_admin, mostrar todas as unidades
                    if (user.role_name === 'super_admin') {
                        unitsData.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit.id;
                            option.textContent = unit.name;
                            if (unit.id == user.unit_id) {
                                option.selected = true;
                            }
                            unitSelect.appendChild(option);
                        });
                    } else {
                        // Para outros usuários, mostrar apenas sua unidade
                        const userUnit = unitsData.find(unit => unit.id == user.unit_id);
                        if (userUnit) {
                            const option = document.createElement('option');
                            option.value = userUnit.id;
                            option.textContent = userUnit.name;
                            option.selected = true;
                            unitSelect.appendChild(option);
                        }
                    }
                    
                    // **OTIMIZAÇÃO:** Definir unidade selecionada no localStorage
                    const selectedUnit = unitSelect.value;
                    if (selectedUnit) {
                        localStorage.setItem('selectedUnit', selectedUnit);
                    }
                } else {
                    console.error('❌ Erro ao carregar unidades');
                    // Fallback: mostrar apenas a unidade do usuário
                    unitSelect.innerHTML = `<option value="${user.unit_id}">Unidade ${user.unit_id}</option>`;
                    localStorage.setItem('selectedUnit', user.unit_id);
                }
            } catch (error) {
                console.error('❌ Erro na requisição de unidades:', error);
                // Fallback em caso de erro
                const unitSelect = document.getElementById('unitSelect');
                if (unitSelect && user.unit_id) {
                    unitSelect.innerHTML = `<option value="${user.unit_id}">Unidade ${user.unit_id}</option>`;
                    localStorage.setItem('selectedUnit', user.unit_id);
                }
            }
        }

        // Gerenciar mudança de unidade
        function handleUnitChange() {
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnitId = unitSelect.value;
            
            console.log('🔄 Mudança de unidade selecionada:', selectedUnitId);
            
            // **OTIMIZAÇÃO:** Salvar seleção no localStorage
            localStorage.setItem('selectedUnit', selectedUnitId);
            
            // Atualizar dados baseados na unidade selecionada
            if (selectedUnitId) {
                // Recarregar módulos para a nova unidade
                loadUserModules(selectedUnitId);
                
                // Atualizar conteúdo se necessário
                const activeModule = localStorage.getItem('activeModule') || 'dashboard';
                loadModuleContent(activeModule);
                
                console.log('✅ Interface atualizada para unidade:', selectedUnitId);
            }
        }

        // Carregar módulos específicos da unidade do usuário
async function loadUserModules(unitId) {
    try {
        console.log('🔄 Carregando módulos para unidade:', unitId);
        
        // **OTIMIZAÇÃO:** Verificar cache de módulos primeiro
        const cacheKey = `modules_${unitId}`;
        let modulesData = null;
        const cachedModules = localStorage.getItem(cacheKey);
        
        if (cachedModules && isCacheValid()) {
            modulesData = JSON.parse(cachedModules);
            console.log('✅ Usando módulos do cache para unidade:', unitId);
        } else {
            // **CORREÇÃO:** URL da API deve incluir ordenação
            const response = await fetch(`./api/modules.php?action=by_unit&unit_id=${unitId}&order_by=order_index`);
            const data = await response.json();
            
            if (data.success) {
                // **CORREÇÃO:** Dupla ordenação (backend + frontend) para garantia
                modulesData = data.modules.sort((a, b) => {
                    const orderA = parseInt(a.order_index) || 999;
                    const orderB = parseInt(b.order_index) || 999;
                    return orderA - orderB;
                });
                
                // **CACHE:** Salvar módulos ordenados para próximas cargas
                localStorage.setItem(cacheKey, JSON.stringify(modulesData));
                localStorage.setItem('cacheTimestamp', Date.now().toString());
                console.log('✅ Módulos carregados e ordenados:', modulesData.map(m => ({
                    name: m.name,
                    display_name: m.display_name,
                    order_index: m.order_index
                })));
            }
        }
        
        if (modulesData) {
            renderDynamicSidebar(modulesData);
        } else {
            console.error('❌ Erro ao carregar módulos');
            loadDefaultModules();
        }
    } catch (error) {
        console.error('❌ Erro na requisição de módulos:', error);
        loadDefaultModules();
    }
}

        // Carregar módulos padrão em caso de erro
function loadDefaultModules() {
    const defaultModules = [
        {
            name: 'dashboard',
            display_name: 'Dashboard',
            icon: 'fas fa-chart-pie',
            order_index: 1
        },
        {
            name: 'agenda',
            display_name: 'Agenda', 
            icon: 'fas fa-calendar-alt',
            order_index: 2
        },
        {
            name: 'pos-venda',
            display_name: 'Pós-Venda',
            icon: 'fas fa-handshake', 
            order_index: 3
        },
        {
            name: 'recrutamento',
            display_name: 'Recrutamento',
            icon: 'fas fa-users',
            order_index: 4
        }
    ];
    
    console.log('⚠️ Carregando módulos padrão com order_index');
    renderDynamicSidebar(defaultModules);
}

        // **CORREÇÃO 3:** Debug de Inicialização
        function debugModuleInitialization() {
            console.log('🔍 DEBUG COMPLETO DE INICIALIZAÇÃO:');
            
            // 1. Verificar elementos DOM
            const elements = {
                sidebar: document.getElementById('sidebar'),
                sidebarNav: document.querySelector('.sidebar-nav'),
                contentArea: document.getElementById('contentArea'),
                unitSelect: document.getElementById('unitSelect'),
                metricsContainer: document.querySelector('.metrics-container')
            };
            
            console.log('📋 Elementos DOM:', Object.keys(elements).map(key => ({
                [key]: !!elements[key]
            })));
            
            // 2. Verificar sessão
            const userSession = localStorage.getItem('userSession');
            console.log('👤 Sessão:', !!userSession);
            if (userSession) {
                try {
                    const user = JSON.parse(userSession);
                    console.log('👤 Dados válidos:', {
                        id: !!user.id,
                        name: !!user.name,
                        role: user.role_name,
                        unit_id: user.unit_id
                    });
                } catch (e) {
                    console.error('❌ Sessão corrompida:', e);
                }
            }
            
            // 3. Verificar classes disponíveis
            console.log('📚 Classes:', {
                MetricsCards: typeof MetricsCards !== 'undefined',
                Charts: typeof Charts !== 'undefined',
                supabase: typeof supabase !== 'undefined'
            });
            
            // 4. Verificar conexão Supabase
            testSupabaseConnection().then(connected => {
                console.log('🔌 Supabase:', connected ? '✅ Conectado' : '❌ Falha');
            });
        }

        // **CORREÇÃO 5:** Verificação de Unit ID
        function getValidUnitId() {
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const unitSelect = document.getElementById('unitSelect');
            
            let unitId = unitSelect?.value || 
                         userSession.unit_id || 
                         localStorage.getItem('selectedUnit') ||
                         '53a19414-8331-4b31-a337-e8b43872e2a1'; // Fallback
            
            console.log('🏢 Unit ID resolvido:', unitId);
            
            // Salvar para próximas consultas
            localStorage.setItem('selectedUnit', unitId);
            
            return unitId;
        }
        function ensureSidebarElements() {
            let sidebarNav = document.querySelector('.sidebar-nav');
            
            if (!sidebarNav) {
                console.warn('⚠️ .sidebar-nav não encontrado, criando...');
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebarNav = document.createElement('nav');
                    sidebarNav.className = 'sidebar-nav';
                    sidebar.appendChild(sidebarNav);
                } else {
                    console.error('❌ Sidebar principal não encontrado!');
                    return null;
                }
            }
            
            return sidebarNav;
        }

        // Renderizar sidebar dinamicamente baseado nos módulos
function renderDynamicSidebar(modules) {
    const sidebarNav = ensureSidebarElements();
    if (!sidebarNav) {
        console.error('❌ Não foi possível criar/encontrar sidebar-nav');
        return;
    }
    
    // **CORREÇÃO:** Ordenar módulos por order_index PRIMEIRO
    const sortedModules = [...modules].sort((a, b) => {
        const orderA = parseInt(a.order_index) || 999;
        const orderB = parseInt(b.order_index) || 999;
        return orderA - orderB;
    });
    
    console.log('📋 Módulos ordenados por order_index:', sortedModules.map(m => ({
        name: m.name || m.display_name,
        display_name: m.display_name,
        order_index: m.order_index
    })));
    
    const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
    const isSuperAdmin = userSession.role_name === 'super_admin';
    
    // Limpar navegação completamente
    sidebarNav.innerHTML = '';
    
    // **CORREÇÃO:** Processar TODOS os módulos ordenados, incluindo gestão
    sortedModules.forEach(module => {
        // **CORREÇÃO:** Tratar módulos de gestão especialmente para super_admin
        // Aceitar tanto 'unidade' quanto 'unidades' para compatibilidade
        if ((module.name === 'unidade' || module.name === 'unidades') && isSuperAdmin) {
            const gestaoUnidadesItem = document.createElement('div');
            gestaoUnidadesItem.className = 'nav-item show-for-super-admin';
            gestaoUnidadesItem.id = 'menu-gestao-unidades';
            gestaoUnidadesItem.innerHTML = `
                <a href="#" class="nav-link" data-module="unidades">
                    <i class="nav-icon fas fa-building"></i>
                    <span class="nav-text">Gestão de Unidades</span>
                </a>
            `;
            sidebarNav.appendChild(gestaoUnidadesItem);
        } else if (module.name === 'usuarios' && isSuperAdmin) {
            const gestaoUsuariosItem = document.createElement('div');
            gestaoUsuariosItem.className = 'nav-item show-for-super-admin';
            gestaoUsuariosItem.id = 'menu-gestao-usuarios';
            gestaoUsuariosItem.innerHTML = `
                <a href="#" class="nav-link" data-module="usuarios">
                    <i class="nav-icon fas fa-users-cog"></i>
                    <span class="nav-text">Gestão de Usuários</span>
                </a>
            `;
            sidebarNav.appendChild(gestaoUsuariosItem);
        } else if (module.name !== 'unidade' && module.name !== 'unidades' && module.name !== 'usuarios') {
            // **CORREÇÃO:** Adicionar módulos normais (não de gestão)
            const moduleItem = createModuleNavItem(module);
            sidebarNav.appendChild(moduleItem);
        }
        // **NOTA:** Se não é super_admin, módulos de gestão são ignorados
    });
    
    // Reassociar event listeners após renderização
    reassignEventListeners();
    
    const totalVisible = sidebarNav.children.length;
    console.log('✅ Sidebar renderizado com', totalVisible, 'itens na ordem correta');
}

        // Criar item de navegação para um módulo
        function createModuleNavItem(module) {
            const navItem = document.createElement('div');
            navItem.className = 'nav-item';
            
            const iconClass = module.icon || 'fas fa-cube';
            const isActive = module.name === 'dashboard' ? 'active' : '';
            
            navItem.innerHTML = `
                <a href="#" class="nav-link ${isActive}" data-module="${module.name}">
                    <i class="nav-icon ${iconClass}"></i>
                    <span class="nav-text">${module.display_name}</span>
                </a>
            `;
            
            return navItem;
        }

        // Reassociar event listeners após renderização dinâmica
        function reassignEventListeners() {
            // Event listeners para links de módulos
            const moduleLinks = document.querySelectorAll('[data-module]');
            moduleLinks.forEach(link => {
                // Remover event listeners existentes para evitar duplicação
                link.replaceWith(link.cloneNode(true));
            });
            
            // Reagregar os event listeners nos elementos clonados
            const newModuleLinks = document.querySelectorAll('[data-module]');
            newModuleLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const module = link.dataset.module;
                    
                    console.log('🔗 Clique no módulo:', module);
                    
                    // **DEBUG:** Log específico para módulo unidade/unidades
                    if (module === 'unidade' || module === 'unidades') {
                        console.log('🏢 Carregando Gestão de Unidades...');
                    }
                    
                    // Remover active de todos os links
                    document.querySelectorAll('.nav-link, .submenu-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Adicionar active ao link clicado
                    link.classList.add('active');
                    
                    // Salvar o módulo ativo no localStorage
                    localStorage.setItem('activeModule', module);
                    
                    // Atualizar título da página
                    const moduleNames = {
                        'dashboard': 'Dashboard',
                        'unidade': 'Gestão de Unidades',
                        'unidades': 'Gestão de Unidades',
                        'usuarios': 'Gestão de Usuários',
                        'agenda': 'Agenda',
                        'pos-venda': 'Pós-Venda',
                        'recrutamento': 'Recrutamento'
                    };
                    
                    pageTitle.textContent = moduleNames[module] || module.charAt(0).toUpperCase() + module.slice(1);
                    
                    // Carregar conteúdo do módulo
                    loadModuleContent(module);
                });
            });
        }

        // **CORREÇÃO 5:** Função de debug para verificar ordem dos módulos
        window.debugModulesOrder = async function() {
            try {
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const unitId = userSession.unit_id || localStorage.getItem('selectedUnit');
                
                console.log('🔍 DEBUG: Verificando ordem dos módulos...');
                console.log('🏢 Unit ID:', unitId);
                console.log('👤 Role:', userSession.role_name);
                
                if (unitId) {
                    const response = await fetch(`./api/modules.php?action=by_unit&unit_id=${unitId}`);
                    const data = await response.json();
                    
                    if (data.success && data.modules) {
                        console.log('📋 Módulos retornados pela API (ordem original):');
                        data.modules.forEach((module, index) => {
                            console.log(`   ${index + 1}. ${module.display_name} (${module.name}) - order_index: ${module.order_index}`);
                        });
                        
                        // Mostrar como ficaria após ordenação
                        const sorted = [...data.modules].sort((a, b) => {
                            const orderA = parseInt(a.order_index) || 999;
                            const orderB = parseInt(b.order_index) || 999;
                            return orderA - orderB;
                        });
                        
                        console.log('📋 Módulos após ordenação por order_index:');
                        sorted.forEach((module, index) => {
                            console.log(`   ${index + 1}. ${module.display_name} (${module.name}) - order_index: ${module.order_index}`);
                        });
                    }
                }
                
                // Verificar ordem atual no sidebar
                const sidebarLinks = document.querySelectorAll('.sidebar-nav .nav-link[data-module]');
                console.log('📋 Ordem atual no sidebar:');
                sidebarLinks.forEach((link, index) => {
                    const moduleName = link.dataset.module;
                    const displayName = link.querySelector('.nav-text')?.textContent;
                    console.log(`   ${index + 1}. ${displayName} (${moduleName})`);
                });
                
            } catch (error) {
                console.error('❌ Erro no debug de módulos:', error);
            }
        };

        // **NOVA FUNÇÃO:** Limpar cache e recarregar módulos
        window.reloadModulesCache = function() {
            console.log('🔄 Limpando cache de módulos e recarregando...');
            
            // Limpar cache
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('modules_')) {
                    localStorage.removeItem(key);
                    console.log('🗑️ Cache removido:', key);
                }
            });
            
            // Recarregar módulos
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const unitId = userSession.unit_id || localStorage.getItem('selectedUnit');
            
            if (unitId) {
                loadUserModules(unitId);
                console.log('✅ Módulos recarregados para unidade:', unitId);
            }
        };

        // Verificar autenticação na inicialização
        function checkAuthentication() {
            console.log('🔐 Verificando autenticação...');
            
            const userSession = localStorage.getItem('userSession');
            console.log('📋 Sessão encontrada:', !!userSession);
            
            if (!userSession) {
                console.warn('❌ Sessão não encontrada, redirecionando...');
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const user = JSON.parse(userSession);
                console.log('👤 Dados do usuário:', { id: user.id, email: user.email, role: user.role_name });
                
                if (!user.id || !user.email) {
                    console.error('❌ Dados de usuário inválidos');
                    localStorage.removeItem('userSession');
                    window.location.href = 'login.html';
                    return false;
                }
                
                console.log('✅ Autenticação válida');
                return true;
            } catch (error) {
                console.error('❌ Erro ao verificar sessão:', error);
                localStorage.removeItem('userSession');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Função para restaurar o módulo ativo
        function restoreActiveModule() {
            // **CORREÇÃO:** Sempre abrir no Dashboard
            // Forçar dashboard como módulo ativo
            localStorage.setItem('activeModule', 'dashboard');
            
            // Remover active de todos os links
            document.querySelectorAll('.nav-link, .submenu-link').forEach(l => {
                l.classList.remove('active');
            });
            
            // Encontrar e ativar o link do dashboard
            const dashboardLink = document.querySelector(`[data-module="dashboard"]`);
            if (dashboardLink) {
                dashboardLink.classList.add('active');
            }
            
            // Carregar conteúdo do dashboard
            loadModuleContent('dashboard');
        }

        // **CORREÇÃO:** Monitorar erros de carregamento
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes('metrics-cards.js')) {
                console.error('❌ ERRO NO METRICS-CARDS.JS:', {
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error
                });
                
                // Tentar recarregar o script após erro
                setTimeout(() => {
                    const script = document.createElement('script');
                    script.src = 'dashboard/components/metrics-cards.js';
                    script.onload = () => console.log('✅ metrics-cards.js recarregado após erro');
                    document.head.appendChild(script);
                }, 1000);
            }
        });

        // **CORREÇÃO PRINCIPAL:** Inicialização automática ao carregar dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 DOM carregado, aguardando inicialização completa...');
            
            // Aguardar scripts carregarem
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Verificar se é dashboard ativo
            const activeModule = localStorage.getItem('activeModule');
            if (activeModule === 'dashboard') {
                console.log('📊 Dashboard é módulo ativo, carregando automaticamente...');
                
                // Aguardar um pouco mais e carregar
                setTimeout(async () => {
                    try {
                        await loadDashboardContent();
                    } catch (error) {
                        console.error('❌ Erro na inicialização automática:', error);
                    }
                }, 500);
            }
        });

        // **NOVO:** Event listener para mudanças de filtro
        function initializeAutoRefresh() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            const unitSelect = document.getElementById('unitSelect');
            
            [monthFilter, yearFilter, unitSelect].forEach(element => {
                if (element) {
                    element.addEventListener('change', () => {
                        console.log('🔄 Filtro alterado, recarregando métricas...');
                        
                        // Debounce para evitar múltiplas chamadas
                        clearTimeout(window.filterTimeout);
                        window.filterTimeout = setTimeout(() => {
                            const contentArea = document.getElementById('contentArea');
                            if (contentArea && contentArea.innerHTML.includes('dashboard-container')) {
                                loadDashboardMetrics();
                            }
                        }, 300);
                    });
                }
            });
        }

        // Chamar após inicialização
        setTimeout(() => {
            initializeAutoRefresh();
        }, 2000);

        // **CORREÇÃO 4:** Inicialização Sequencial Robusta
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Iniciando dashboard...');
            
            try {
                // Passo 1: Verificar conectividade
                const connected = await testSupabaseConnection();
                if (!connected) {
                    throw new Error('Falha na conexão com banco de dados');
                }
                console.log('✅ Conectividade verificada');
                
                // Passo 2: Verificar autenticação
                if (!checkAuthentication()) {
                    console.error('❌ Falha na autenticação');
                    return;
                }
                console.log('✅ Autenticação verificada');
                
                // Passo 3: Garantir sidebar visível
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.opacity = '1';
                    sidebar.style.display = 'flex';
                    sidebar.classList.add('loaded');
                }
                console.log('✅ Sidebar configurado');
                
                // Passo 4: Carregar dados do usuário
                await new Promise(resolve => {
                    loadUserData();
                    setTimeout(resolve, 1000); // Aguardar carregamento
                });
                console.log('✅ Dados do usuário carregados');
                
                // Passo 5: Inicializar módulo dashboard
                await new Promise(resolve => {
                    restoreActiveModule();
                    setTimeout(resolve, 500);
                });
                console.log('✅ Módulo ativo restaurado');
                
                // Passo 6: Inicializar filtros
                initializeDateFilter();
                console.log('✅ Filtros inicializados');
                
                // Passo 7: Executar debug final
                setTimeout(() => {
                    debugModuleInitialization();
                }, 3000); // Aumentado para 3 segundos
                
                console.log('🎉 Dashboard inicializado com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro crítico na inicialização:', error);
                alert('Erro ao carregar dashboard: ' + error.message);
                
                // Debug de emergência
                setTimeout(() => {
                    debugModuleInitialization();
                }, 1000);
            }
        });

        // Listener para mensagens do iframe
        window.addEventListener('message', function(event) {
            if (event.data === 'redirect-dashboard') {
                // Voltar para o dashboard
                loadModuleContent('dashboard');
            } else if (event.data === 'request-theme') {
                // Enviar tema atual para os iframes
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const iframes = document.querySelectorAll('iframe[src="gestao-unidades.html"], iframe[src="gestao-usuarios.html"]');
                iframes.forEach(iframe => {
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({
                            type: 'theme-update',
                            theme: currentTheme
                        }, '*');
                    }
                });
            }
        });

        // Função para sincronizar tema com iframes
        function syncThemeWithIframe() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const iframes = document.querySelectorAll('iframe[src="gestao-unidades.html"], iframe[src="gestao-usuarios.html"]');
            iframes.forEach(iframe => {
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'theme-update',
                        theme: currentTheme
                    }, '*');
                }
            });
        }

        // Filtro de Data - Funcionalidade
        function initializeDateFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            // Definir mês e ano atual como padrão
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() returns 0-11
            const currentYear = currentDate.getFullYear();
            
            // Definir valores padrão
            monthFilter.value = currentMonth.toString();
            yearFilter.value = currentYear.toString();
            
            // Event listeners para filtros
            monthFilter.addEventListener('change', handleDateFilterChange);
            yearFilter.addEventListener('change', handleDateFilterChange);
        }

        function handleDateFilterChange() {
            const { month, year } = getDateFilterValues();
            const activeModule = getCurrentActiveModule() || 'dashboard';
            
            // ✅ MELHORADO: Logs mais detalhados
            console.log('📅 Filtro alterado:', { 
                month: month || 'Todos', 
                year: year || 'Todos', 
                activeModule,
                filterType: month && year ? 'Específico' : month ? 'Apenas Mês' : year ? 'Apenas Ano' : 'Todos'
            });
            
            // ✅ NOVO: Atualizar cards do MetricsCards quando filtros mudam
            if (window.dashboard && window.dashboard.metricsCards) {
                window.dashboard.metricsCards.updateCardsFromFilters();
            }
            
            if (activeModule === 'dashboard') {
                showMetricsLoading();
                setTimeout(() => {
                    applyDateFilterToModule(activeModule, month, year);
                }, 100);
            } else {
                applyDateFilterToModule(activeModule, month, year);
            }
        }

        function applyDateFilterToModule(module, month, year) {
            console.log(`Aplicando filtro de data ao módulo ${module}:`, { month, year });
            
            // **CORREÇÃO:** Se for o dashboard, recarregar as métricas SEMPRE
            if (module === 'dashboard') {
                const contentArea = document.getElementById('contentArea');
                const isDashboard = contentArea && contentArea.innerHTML.includes('dashboard-container');
                
                if (isDashboard) {
                    console.log('Recarregando métricas do dashboard com novos filtros');
                    loadDashboardMetrics(); // Recarrega com os novos filtros
                }
                return;
            }
            
            // Para outros módulos com iframe
            const iframe = document.querySelector('#contentArea iframe');
            if (iframe && iframe.src) {
                const url = new URL(iframe.src, window.location.origin);
                
                // Remover parâmetros de data existentes
                url.searchParams.delete('month');
                url.searchParams.delete('year');
                
                // Adicionar novos parâmetros se selecionados
                if (month) url.searchParams.set('month', month);
                if (year) url.searchParams.set('year', year);
                
                // Recarregar iframe com novos parâmetros
                iframe.src = url.toString();
            }
        }

        function getDateFilterValues() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            const month = monthFilter?.value;
            const year = yearFilter?.value;
            
            return {
                month: month && month !== '' ? parseInt(month) : null,
                year: year && year !== '' ? parseInt(year) : null
            };
        }

        // **CORREÇÃO 4:** Adicionar função getCurrentActiveModule que estava faltando
        function getCurrentActiveModule() {
            const contentArea = document.getElementById('contentArea');
            
            if (!contentArea) return 'dashboard';
            
            // Verificar se está no dashboard
            if (contentArea.innerHTML.includes('dashboard-container')) {
                return 'dashboard';
            }
            
            // Verificar se há iframe ativo
            const iframe = contentArea.querySelector('iframe');
            if (iframe && iframe.src) {
                const url = new URL(iframe.src, window.location.origin);
                const pathname = url.pathname;
                
                if (pathname.includes('Resultados')) return 'resultados';
                if (pathname.includes('Agenda')) return 'agenda';
                if (pathname.includes('Clientes')) return 'clientes';
                if (pathname.includes('Servicos')) return 'servicos';
                if (pathname.includes('Profissionais')) return 'profissionais';
            }
            
            return 'dashboard';
        }

        // Inicializar filtro de data quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeDateFilter();
        });

        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = "https://etztlxlfgoqbgwyaozwf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0enRseGxmZ29xYmd3eWFvendmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzE2NDAsImV4cCI6MjA2ODkwNzY0MH0.gGDCHoMv3J3La2h7QCItNS56Xs-UrhaNa6M_jFZ9w9I";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // **CORREÇÃO:** Função para exibir estado de erro
        function displayErrorState(message = 'Erro ao carregar dados') {
            const cards = ['atendimentos', 'faturamento', 'clientes', 'semana'];
            cards.forEach(cardType => {
                const valueElement = document.getElementById(`metric-${cardType}`);
                const compElement = document.getElementById(`metric-${cardType}-comp`);
                if (valueElement) {
                    valueElement.innerHTML = '❌';
                    valueElement.style.color = 'var(--danger-color)';
                }
                if (compElement) {
                    compElement.innerHTML = message;
                    compElement.style.color = 'var(--danger-color)';
                }
            });
            
            console.error('❌ Estado de erro ativado:', message);
        }

        // **CORREÇÃO:** Chamar debug após inicialização completa
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                debugModuleInitialization();
            }, 2000);
        });

        // **NOVA FUNÇÃO:** Testar conectividade com Supabase
        async function testSupabaseConnection() {
            try {
                console.log('🔌 Testando conectividade com Supabase...');
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    console.error('❌ Erro de conectividade Supabase:', error);
                    return false;
                }
                
                console.log('✅ Supabase conectado com sucesso');
                return true;
            } catch (error) {
                console.error('❌ Falha total na conexão Supabase:', error);
                return false;
            }
        }

        // Cache de dados para evitar consultas desnecessárias
        let metricsCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

        function getCacheKey(unitId, month, year) {
            return `${unitId}_${month}_${year}`;
        }

        function getCachedData(unitId, month, year) {
            const key = getCacheKey(unitId, month, year);
            const cached = metricsCache.get(key);
            
            if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
                console.log('📦 Usando dados do cache');
                return cached.data;
            }
            
            return null;
        }

        function setCachedData(unitId, month, year, data) {
            const key = getCacheKey(unitId, month, year);
            metricsCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }

        // Função para obter nome da tabela baseado na unidade selecionada
        function getSelectedTableName() {
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const unitSelect = document.getElementById('unitSelect');
            const unitId = unitSelect ? unitSelect.value : userSession.unit_id;
            
            // Mapear unit_id para nome da tabela (ajustar conforme suas tabelas)
            const tableMapping = {
                '53a19414-8331-4b31-a337-e8b43872e2a1': 'resultados', // Unidade padrão
                // Adicionar outras unidades conforme necessário
                '1': 'resultados',
                '2': 'resultados_unidade2',
                '3': 'resultados_unidade3'
            };
            
            return tableMapping[unitId] || 'resultados'; // fallback para tabela padrão
        }

        // --- UPLOAD FUNCTIONS ---
        
        // Configuração para upload - Headers esperados da planilha (AJUSTADO PARA TABELA RESULTADOS)
        const EXPECTED_HEADERS = [
            'Número', 'Data', 'Horário', 'Período', 'Serviço', 'Tipo', 'Cliente', 
            'Profissionais', 'Repasse (R$)', 'Local de Atendimento', 'Valor (R$)', 
            'Cupom de Desconto', 'Origem', 'Data de cadastro', 'Dia da semana',
            'Horas', 'Status', 'Motivo', 'Ação', 'Observação'
        ];

        // Campos válidos para inserção no banco - TABELA RESULTADOS (SEM ACENTOS)
        const VALID_FIELDS = [
            'id', 'data', 'horario', 'valor', 'servico', 'tipo', 'periodo',
            'cliente', 'profissional', 'endereco', 'dia', 'repasse', 
            'whatscliente', 'cupom', 'origem', 'atendimento_id', 'is_divisao',
            'cadastro', 'acao', 'horas', 'motivo', 'acomp', 'status', 'pos', 
            'observacao', 'user_id', 'unit_id', 'created_at'
        ];

        // Variáveis globais para upload
        let selectedFile = null;

        // Modal functions
        function openUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('show');
            resetUploadForm();
        }

        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('show');
            resetUploadForm();
        }

        function resetUploadForm() {
            selectedFile = null;
            
            const fileInput = document.getElementById('fileInput');
            const filePreview = document.getElementById('filePreview');
            const uploadBtn = document.getElementById('uploadBtn2');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (fileInput) fileInput.value = '';
            if (filePreview) filePreview.style.display = 'none';
            if (uploadBtn) uploadBtn.disabled = true;
            if (uploadStatus) hideUploadStatus();
        }

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');
        
        if (dropZone) {
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        }

        function handleFileSelection(file) {
            console.log('📁 Arquivo selecionado:', file.name, 'Tamanho:', formatFileSize(file.size));
            
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showUploadStatus('Erro: Apenas arquivos .xlsx são aceitos.', 'error');
                return;
            }

            // Verificar tamanho do arquivo (máximo 20MB)
            if (file.size > 20 * 1024 * 1024) {
                showUploadStatus('Erro: Arquivo muito grande. Máximo 20MB aceito.', 'error');
                return;
            }

            selectedFile = file;
            showFilePreview(file);
            
            const uploadBtn = document.getElementById('uploadBtn2');
            if (uploadBtn) uploadBtn.disabled = false;
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = formatFileSize(file.size);
            if (preview) preview.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Processar arquivo XLSX - SEGUINDO PADRÃO RESULTADOS.HTML
        async function processUploadedFile() {
            const file = selectedFile;
            if (!file) {
                showUploadStatus('Nenhum arquivo selecionado para processar.', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn2');
            if (uploadBtn) {
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                uploadBtn.disabled = true;
            }

            try {
                showUploadStatus('Processando arquivo...', 'info');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // SEGUINDO EXATAMENTE O PADRÃO DO RESULTADOS.HTML
                        // A planilha tem headers na linha 2, e os dados começam na linha 3 (índice 2)
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                        if (json.length <= 2) { // Pelo menos 3 linhas: 1 vazia, 1 header, 1 dado
                            showUploadStatus('Dados insuficientes no arquivo.', 'error');
                            return;
                        }

                        const headers = json[1]; // A linha 2 da planilha (índice 1) contém os cabeçalhos
                        const dataRows = json.slice(2); // Os dados começam na linha 3 (índice 2)
                        
                        console.log('Cabeçalhos da planilha:', headers);

                        // Mapeamento de colunas da planilha para campos do banco (TABELA RESULTADOS)
                        const colMapping = {
                            'Número': headers.indexOf('Número'),
                            'Data': headers.indexOf('Data'),
                            'Horário': headers.indexOf('Horário'),
                            'Período': headers.indexOf('Período'),
                            'Serviço': headers.indexOf('Serviço'),
                            'Tipo': headers.indexOf('Tipo'),
                            'Cliente': headers.indexOf('Cliente'),
                            'Profissionais': headers.indexOf('Profissionais'),
                            'Repasse (R$)': headers.indexOf('Repasse (R$)'),
                            'Local de Atendimento': headers.indexOf('Local de Atendimento'),
                            'Valor (R$)': headers.indexOf('Valor (R$)'),
                            'Cupom de Desconto': headers.indexOf('Cupom de Desconto'),
                            'Origem': headers.indexOf('Origem'),
                            'Data de cadastro': headers.indexOf('Data de cadastro'),
                            'Dia da semana': headers.indexOf('Dia da semana'),
                            'Horas': headers.indexOf('Horas'),
                            'Status': headers.indexOf('Status'),
                            'Motivo': headers.indexOf('Motivo'),
                            'Ação': headers.indexOf('Ação'),
                            'Observação': headers.indexOf('Observação')
                        };
                        
                        console.log('Mapeamento de colunas:', colMapping);
                        
                        // Verificar se alguma coluna obrigatória está faltando
                        const colunasObrigatorias = ['Data', 'Cliente', 'Valor (R$)'];
                        const colunasFaltantes = colunasObrigatorias.filter(col => colMapping[col] === -1);
                        if (colunasFaltantes.length > 0) {
                            console.error('Colunas obrigatórias não encontradas:', colunasFaltantes);
                            showUploadStatus(`Erro: Colunas obrigatórias não encontradas: ${colunasFaltantes.join(', ')}`, 'error');
                            return;
                        }

                        let resultados = [];
                        dataRows.forEach(row => {
                            let base = {};
                            
                            // Preencher 'base' com os valores do XLSX usando campos da tabela resultados
                            base['data'] = (row[colMapping['Data']] || '').toString().trim();
                            base['horario'] = (row[colMapping['Horário']] || '').toString().trim();
                            base['periodo'] = (row[colMapping['Período']] || '').toString().trim();
                            base['servico'] = (row[colMapping['Serviço']] || '').toString().trim();
                            base['tipo'] = (row[colMapping['Tipo']] || '').toString().trim();
                            base['cliente'] = (row[colMapping['Cliente']] || '').toString().trim();
                            base['horas'] = (row[colMapping['Horas']] || '').toString().trim();
                            base['status'] = (row[colMapping['Status']] || '').toString().trim();
                            base['motivo'] = (row[colMapping['Motivo']] || '').toString().trim();
                            base['acao'] = (row[colMapping['Ação']] || '').toString().trim();
                            base['observacao'] = (row[colMapping['Observação']] || '').toString().trim();
                            
                            // Remover barra vertical e espaços ao final do nome do cliente
                            base['cliente'] = base['cliente'].replace(/\|/g, '').trim();
                            base['profissional'] = (row[colMapping['Profissionais']] || '').toString().trim();
                            
                            // Valores numéricos - garante que são números válidos
                            const repasse = parseValueFromCurrency(row[colMapping['Repasse (R$)']] || '0');
                            const valor = parseValueFromCurrency(row[colMapping['Valor (R$)']] || '0');
                            base['repasse'] = isNaN(repasse) ? 0 : repasse; 
                            base['valor'] = isNaN(valor) ? 0 : valor;
                            
                            base['cupom'] = (row[colMapping['Cupom de Desconto']] || '').toString().trim();
                            base['origem'] = (row[colMapping['Origem']] || '').toString().trim();
                            base['endereco'] = (row[colMapping['Local de Atendimento']] || '').toString().trim();
                            base['cadastro'] = (row[colMapping['Data de cadastro']] || '').toString().trim();
                            base['dia'] = (row[colMapping['Dia da semana']] || '').toString().trim();
                            base['atendimento_id'] = (row[colMapping['Número']] || '').toString().trim();

                            // Conversão de formato de data para YYYY-MM-DD
                            if (base['data'] && base['data'].includes('/')) {
                                const [day, month, year] = base['data'].split('/');
                                base['data'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }
                            if (base['cadastro'] && base['cadastro'].includes('/')) {
                                const [day, month, year] = base['cadastro'].split('/');
                                base['cadastro'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }

                            // Processar cliente e telefone (se não vierem separados)
                            let cliente = base['cliente'] || '';
                            let telefone = '';
                            const telMatch = cliente.match(/\(?\d{2}\)? ?\d{4,5}-?\d{4}/);
                            if (telMatch) {
                                telefone = telMatch[0].replace(/\D/g, '');
                                cliente = cliente.replace(telMatch[0], '').trim();
                            }
                            base['cliente'] = cliente;
                            base['whatscliente'] = telefone ? `55${telefone}` : '';

                            // Handle multiple professionals and is_divisao
                            let profissionais = (base['profissional'] || '').split(';').map(p => p.trim()).filter(Boolean);
                            if (profissionais.length === 0) profissionais = ['SEM PROFISSIONAL'];

                            // Gerar atendimento_id se não informado
                            const atendimentoId = base['atendimento_id'] || `${base['data']}_${base['cliente']}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                            const repasseDividido = profissionais.length > 1 ? (base['repasse'] / profissionais.length) : base['repasse'];

                            // Obter user_id e unit_id da sessão
                            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                            const unitSelect = document.getElementById('unitSelect');
                            const userId = userSession.id;
                            const unitId = unitSelect ? unitSelect.value : userSession.unit_id;

                            profissionais.forEach((prof, index) => {
                                let newEntry = {
                                    ...base,
                                    profissional: prof,
                                    atendimento_id: atendimentoId,
                                    is_divisao: profissionais.length > 1 ? (index > 0 ? 'SIM' : 'NAO') : 'NAO',
                                    repasse: repasseDividido,
                                    user_id: userId,
                                    unit_id: unitId
                                };
                                resultados.push(newEntry);
                            });
                        });

                        if (resultados.length === 0) {
                            showUploadStatus('Nenhum dado válido encontrado para upload.', 'error');
                            return;
                        }

                        // Validação adicional dos resultados processados
                        console.log(`${resultados.length} registros processados. Amostra:`, resultados.slice(0, 3));
                        
                        // Verifica se há registro sem data, que é um campo essencial
                        const registrosSemData = resultados.filter(reg => !reg.data);
                        if (registrosSemData.length > 0) {
                            console.warn(`Atenção: ${registrosSemData.length} registros sem data encontrados!`, registrosSemData.slice(0, 3));
                        }
                        
                        showUploadStatus(`${resultados.length} registros processados. Enviando para o banco...`, 'info');
                        await uploadToDatabase(resultados);

                    } catch (err) {
                        console.error('Error processing XLSX data:', err);
                        showUploadStatus('Erro ao processar arquivo: ' + err.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error in processUploadedFile:', error);
                showUploadStatus('Erro no upload: ' + error.message, 'error');
            } finally {
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Enviar Arquivo';
                    uploadBtn.disabled = false;
                }
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(new Error('Erro ao ler arquivo Excel'));
                    }
                };
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function processExcelData(jsonData) {
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const userId = userSession.id;
            
            // Obter unidade ativa do select ao invés da sessão
            const unitSelect = document.getElementById('unitSelect');
            const unitId = unitSelect ? unitSelect.value : userSession.unit_id;

            if (!userId || !unitId) {
                throw new Error('Sessão de usuário inválida ou unidade não selecionada. Verifique e tente novamente.');
            }

            console.log('📋 Processando dados do Excel:', jsonData.length, 'registros');
            console.log('👤 User ID:', userId, 'Unit ID:', unitId);

            const records = [];

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                try {
                    const record = {};
                    let hasValidData = false;
                    
                    // Log da linha sendo processada
                    console.log(`📝 Processando linha ${i + 1}:`, row);
                    
                    // Mapear campos do Excel para o banco
                    Object.keys(row).forEach(excelHeader => {
                        const originalHeader = excelHeader.trim();
                        const upperHeader = originalHeader.toUpperCase();
                        const dbField = mapExcelHeaderToDbField(upperHeader);
                        
                        console.log(`🔗 Mapeando: "${originalHeader}" -> "${upperHeader}" -> "${dbField}"`);
                        
                        if (dbField && VALID_FIELDS.includes(dbField)) {
                            let value = row[excelHeader];
                            
                            // Pular valores vazios/nulos
                            if (value === null || value === undefined || value === '') {
                                return;
                            }
                            
                            // Processar valores especiais
                            if (dbField === 'data' || dbField === 'cadastro' || dbField === 'acomp') {
                                value = parseExcelDate(value);
                                if (value) hasValidData = true;
                            } else if (dbField === 'valor' || dbField === 'repasse') {
                                value = parseExcelCurrency(value);
                                if (value !== null && value !== 0) hasValidData = true;
                            } else if (typeof value === 'string') {
                                value = value.trim();
                                if (value) hasValidData = true;
                            } else {
                                hasValidData = true;
                            }
                            
                            record[dbField] = value;
                            console.log(`✅ Campo mapeado: ${dbField} = ${value}`);
                        } else {
                            console.log(`❌ Campo ignorado: "${originalHeader}" (não mapeado ou inválido)`);
                        }
                    });

                    // Adicionar campos obrigatórios
                    record.user_id = userId;
                    record.unit_id = unitId;

                    // Verificar se tem dados válidos além dos campos obrigatórios
                    if (hasValidData && Object.keys(record).length > 2) {
                        records.push(record);
                        console.log(`✅ Registro ${i + 1} adicionado:`, record);
                    } else {
                        console.log(`⚠️ Registro ${i + 1} ignorado - sem dados válidos`);
                    }

                } catch (error) {
                    console.error(`❌ Erro ao processar linha ${i + 1}:`, error, row);
                }
            }

            console.log(`📊 Total de registros processados: ${records.length} de ${jsonData.length}`);
            
            if (records.length === 0) {
                console.error('❌ Headers encontrados no Excel:', Object.keys(jsonData[0] || {}));
                console.error('❌ Headers esperados:', EXPECTED_HEADERS);
                console.error('❌ Campos válidos do banco:', VALID_FIELDS);
                throw new Error(`Nenhum registro válido encontrado. Verifique se o arquivo contém os campos esperados: ${EXPECTED_HEADERS.slice(0, 5).join(', ')}...`);
            }

            return records;
        }

        // Map Excel headers to database field names (CORRIGIDO E EXPANDIDO)
        function mapExcelHeaderToDbField(header) {
            const mapping = {
                // Campos principais
                'DATA': 'data',
                'HORARIO': 'horario',
                'HORÁRIO': 'horario',
                'VALOR': 'valor',
                'SERVICO': 'servico',
                'SERVIÇO': 'servico',
                'TIPO': 'tipo',
                'PERIODO': 'periodo',
                'PERÍODO': 'periodo',
                'CLIENTE': 'cliente',
                'PROFISSIONAL': 'profissional',
                'PROFISSIONAIS': 'profissional',
                'ENDERECO': 'endereco',
                'ENDEREÇO': 'endereco',
                'LOCAL DE ATENDIMENTO': 'endereco',
                'DIA': 'dia',
                'DIA DA SEMANA': 'dia',
                'REPASSE': 'repasse',
                'REPASSE (R$)': 'repasse',
                
                // Campos extras
                'WHATSCLIENTE': 'whatscliente',
                'WHATS CLIENTE': 'whatscliente',
                'CUPOM': 'cupom',
                'CUPOM DE DESCONTO': 'cupom',
                'ORIGEM': 'origem',
                'ATENDIMENTO_ID': 'atendimento_id',
                'NÚMERO': 'atendimento_id',
                'NUMERO': 'atendimento_id',
                'ID': 'atendimento_id',
                
                // Campos de controle
                'IS_DIVISAO': 'is_divisao',
                'CADASTRO': 'cadastro',
                'DATA DE CADASTRO': 'cadastro',
                'ACAO': 'acao',
                'AÇÃO': 'acao',
                'HORAS': 'horas',
                'MOTIVO': 'motivo',
                'ACOMP': 'acomp',
                'ACOMPANHAMENTO': 'acomp',
                'STATUS': 'status',
                'SITUACAO': 'status',
                'SITUAÇÃO': 'status',
                'POS': 'pos',
                'PÓS': 'pos',
                'OBSERVACAO': 'observacao',
                'OBSERVAÇÃO': 'observacao',
                'OBS': 'observacao'
            };
            
            const result = mapping[header];
            return result;
        }

        // Parse Excel date (MELHORADO)
        function parseExcelDate(value) {
            if (!value) return null;

            if (typeof value === 'number') {
                // Excel date serial number
                const date = new Date((value - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }

            if (typeof value === 'string') {
                const dateStr = value.trim();
                // DD/MM/YYYY format
                if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    const [day, month, year] = dateStr.split('/');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                // YYYY-MM-DD format
                else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                    const [year, month, day] = dateStr.split('-');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                // DD/MM/YY format
                else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{2}$/)) {
                    const [day, month, year] = dateStr.split('/');
                    const fullYear = parseInt(year) > 50 ? `19${year}` : `20${year}`;
                    return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            }

            return null;
        }

        // Parse Excel currency (MELHORADO)
        function parseExcelCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Remove R$, espaços e símbolos, converte vírgula para ponto
                let cleanValue = value.replace(/[R$\s]/g, '');
                cleanValue = cleanValue.replace(/\./g, ''); // Remove pontos de milhares
                cleanValue = cleanValue.replace(',', '.'); // Converte vírgula decimal para ponto
                
                const numValue = parseFloat(cleanValue);
                return isNaN(numValue) ? null : numValue;
            }
            return null;
        }

        // Função para converter valores monetários
        function parseValueFromCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Remove R$, espaços e símbolos, converte vírgula para ponto
                let cleanValue = value.replace(/[R$\s]/g, '');
                cleanValue = cleanValue.replace(/\./g, ''); // Remove pontos de milhares
                cleanValue = cleanValue.replace(',', '.'); // Converte vírgula decimal para ponto
                
                const numValue = parseFloat(cleanValue);
                return isNaN(numValue) ? 0 : numValue;
            }
            return 0;
        }

        // Upload to database with monthly replacement logic (CORRIGIDO PARA SUPABASE)
        async function uploadToDatabase(records) {
            showUploadStatus('Iniciando upload...', 'info');
            
            try {
                console.log('📤 Iniciando upload para Supabase...');
                console.log('📊 Total de registros:', records.length);
                
                // Obter user_id e unit_id da sessão
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const userId = userSession.id;

                if (!userId) {
                    throw new Error('User ID não encontrado na sessão');
                }
                
                // Priorizar unit_id do select, depois da sessão
                const unitSelect = document.getElementById('unitSelect');
                const unitId = unitSelect?.value || userSession.unit_id;

                console.log('👤 User ID:', userId);
                console.log('🏢 Unit ID:', unitId);

                if (!unitId) {
                    throw new Error('Unit ID não encontrado. Selecione uma unidade.');
                }

                // Determinar tabela de destino baseada na unidade
                const targetTable = getSelectedTableName(unitId);
                console.log('🎯 Tabela de destino:', targetTable);

                // ETAPA 1: Detectar períodos únicos nos dados
                showUploadStatus('Analisando períodos dos dados...', 'info');
                
                const periodsInData = new Set();
                records.forEach(record => {
                    // Verificar múltiplos campos de data
                    const dateField = record['data'] || record['Data'] || record['DATA'];
                    if (dateField && dateField.trim()) {
                        let dateValue;
                        
                        // Tentar diferentes formatos de data
                        if (typeof dateField === 'string') {
                            // Formato brasileiro DD/MM/YYYY
                            if (dateField.includes('/')) {
                                const parts = dateField.split('/');
                                if (parts.length === 3) {
                                    dateValue = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            }
                            // Formato ISO ou outros
                            else {
                                dateValue = new Date(dateField);
                            }
                        } else {
                            dateValue = new Date(dateField);
                        }

                        if (!isNaN(dateValue.getTime())) {
                            const period = `${dateValue.getFullYear()}-${String(dateValue.getMonth() + 1).padStart(2, '0')}`;
                            periodsInData.add(period);
                        }
                    }
                });

                const uniquePeriods = Array.from(periodsInData).sort();
                console.log('📅 Períodos detectados nos dados:', uniquePeriods);

                if (uniquePeriods.length === 0) {
                    throw new Error('Nenhuma data válida encontrada nos dados');
                }

                // ETAPA 2: Confirmação com o usuário sobre múltiplos períodos
                if (uniquePeriods.length > 1) {
                    const periodsText = uniquePeriods.map(p => {
                        const [year, month] = p.split('-');
                        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                                          'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                        return `${monthNames[parseInt(month) - 1]}/${year}`;
                    }).join(', ');
                    
                    const confirmed = confirm(
                        `Os dados contêm múltiplos períodos: ${periodsText}\n\n` +
                        'Os dados existentes destes períodos serão SUBSTITUÍDOS.\n\n' +
                        'Deseja continuar?'
                    );
                    
                    if (!confirmed) {
                        showUploadStatus('Upload cancelado pelo usuário', 'warning');
                        return { success: false, message: 'Cancelado pelo usuário' };
                    }
                }

                // ETAPA 3: Exclusão dos dados existentes dos períodos
                for (const period of uniquePeriods) {
                    showUploadStatus(`Removendo dados existentes do período ${period}...`, 'info');
                    
                    const [year, month] = period.split('-');
                    const startDate = `${year}-${month}-01`;
                    const endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
                    
                    console.log(`🗑️ Removendo dados do período: ${startDate} a ${endDate}`);
                    
                    try {
                        const { data: deletedData, error: deleteError } = await supabase
                            .from(targetTable)
                            .delete()
                            .eq('unit_id', unitId)
                            .gte('data', startDate)
                            .lte('data', endDate);
                        
                        if (deleteError) {
                            console.warn(`⚠️ Aviso na limpeza do período ${period}:`, deleteError.message);
                        } else {
                            console.log(`✅ Período ${period} limpo com sucesso`);
                        }
                    } catch (deleteError) {
                        console.warn(`⚠️ Erro na limpeza do período ${period}:`, deleteError);
                        // Continuar mesmo com erro na exclusão
                    }
                }

                // ETAPA 4: Inserção dos novos dados em chunks
                showUploadStatus('Inserindo novos dados...', 'info');
                
                // Verificar tamanho do payload
                const payloadSize = JSON.stringify(records).length;
                console.log('📦 Tamanho do payload:', (payloadSize / 1024 / 1024).toFixed(2), 'MB');
                
                if (payloadSize > 50 * 1024 * 1024) { // 50MB
                    throw new Error('Arquivo muito grande. Tente dividir em arquivos menores.');
                }

                // Dividir em chunks para processamento
                const chunkSize = 100; // 100 registros por chunk
                const chunks = [];
                for (let i = 0; i < records.length; i += chunkSize) {
                    chunks.push(records.slice(i, i + chunkSize));
                }

                console.log(`📦 Dividindo em ${chunks.length} chunks de ${chunkSize} registros`);

                let totalInserted = 0;
                
                // Processar cada chunk separadamente
                for (let i = 0; i < chunks.length; i++) {
                    showUploadStatus(`Enviando chunk ${i + 1}/${chunks.length} para ${targetTable}...`, 'info');
                    
                    const chunk = chunks[i];
                    
                    // Preparar registros com IDs necessários
                    const recordsWithIds = chunk.map(record => ({
                        ...record,
                        user_id: userId,
                        unit_id: unitId,
                        created_at: new Date().toISOString()
                    }));

                    console.log(`📝 Chunk ${i + 1}: ${recordsWithIds.length} registros para tabela ${targetTable}`);

                    try {
                        // Inserir diretamente no Supabase
                        const { data, error } = await supabase
                            .from(targetTable)
                            .insert(recordsWithIds)
                            .select('id');

                        if (error) {
                            console.error(`❌ Erro Supabase no chunk ${i + 1}:`, error);
                            throw new Error(`Erro ao inserir chunk ${i + 1}: ${error.message}`);
                        }

                        const insertedCount = data ? data.length : recordsWithIds.length;
                        totalInserted += insertedCount;
                        console.log(`✅ Chunk ${i + 1} processado: ${insertedCount} registros inseridos`);
                    } catch (chunkError) {
                        console.error(`❌ Erro no chunk ${i + 1}:`, chunkError);
                        throw new Error(`Erro ao processar chunk ${i + 1}: ${chunkError.message}`);
                    }
                    
                    // Pequena pausa entre chunks para não sobrecarregar
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                console.log('✅ Upload concluído:', totalInserted, 'registros inseridos na tabela', targetTable);
                
                // Mensagem de sucesso detalhada
                const periodsText = uniquePeriods.map(p => {
                    const [year, month] = p.split('-');
                    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                                      'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    return `${monthNames[parseInt(month) - 1]}/${year}`;
                }).join(', ');
                
                showUploadStatus(
                    `✅ Upload concluído! ${totalInserted} registros inseridos.\nPeríodos atualizados: ${periodsText}`, 
                    'success'
                );
                
                // Recarregar dashboard se estiver ativo
                if (window.currentModule === 'dashboard') {
                    loadDashboardMetrics();
                }
                
                // Auto close e refresh após sucesso
                setTimeout(() => {
                    closeUploadModal();
                    refreshCurrentModule();
                }, 3000);

                return { 
                    success: true, 
                    inserted_count: totalInserted, 
                    table: targetTable,
                    periods_updated: uniquePeriods
                };

            } catch (error) {
                console.error('❌ Erro no upload:', error);
                showUploadStatus(`❌ Erro ao salvar: ${error.message}`, 'error');
                throw error;
            }
        }

        // Show upload status
        function showUploadStatus(message, type = 'info') {
            const status = document.getElementById('uploadStatus');
            status.textContent = message;
            status.className = `upload-status ${type}`;
            status.style.display = 'block';
        }

        // Hide upload status
        function hideUploadStatus() {
            const status = document.getElementById('uploadStatus');
            status.style.display = 'none';
        }

        // Close modal when clicking backdrop
        document.getElementById('uploadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUploadModal();
            }
        });

        // === DASHBOARD CONTENT AND METRICS ===
        
        // **CORREÇÃO 1:** Funções para calcular datas corretamente
        function getLastDayOfMonth(year, month) {
            // Criar data do primeiro dia do próximo mês e subtrair 1 dia
            return new Date(year, month, 0).getDate();
        }

        function formatDateRange(year, month) {
            const startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
            const lastDay = getLastDayOfMonth(year, month);
            const endDate = `${year}-${month.toString().padStart(2, '0')}-${lastDay.toString().padStart(2, '0')}`;
            
            return { startDate, endDate };
        }
        
        // **FUNÇÃO DEBUG:** Verificar dados disponíveis no banco
        async function debugDatabaseData() {
            try {
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const unitSelect = document.getElementById('unitSelect');
                const unitId = unitSelect ? unitSelect.value : userSession.unit_id;
                
                if (!unitId) {
                    console.error('❌ Unit ID não encontrado');
                    return;
                }
                
                const targetTable = getSelectedTableName(unitId);
                console.log('🔍 DEBUG: Verificando dados na tabela:', targetTable);
                
                // **CORREÇÃO:** Buscar com tratamento de erro robusto
                const { data: allData, error } = await supabase
                    .from(targetTable)
                    .select('data, valor, cliente')
                    .eq('unit_id', unitId)
                    .order('data', { ascending: false })
                    .limit(1000);
                    
                if (error) {
                    console.error('❌ Erro na consulta de debug:', error);
                    alert('Erro ao buscar dados: ' + error.message);
                    return;
                }
                
                if (!allData || allData.length === 0) {
                    console.warn('⚠️ Nenhum dado encontrado na tabela:', targetTable);
                    alert('Nenhum dado encontrado na unidade selecionada');
                    return;
                }
                
                console.log('📊 Total de registros no banco:', allData.length);
                
                // Agrupar por mês/ano com validação de data
                const dadosPorMes = {};
                allData.forEach(item => {
                    if (item.data) {
                        try {
                            const data = new Date(item.data);
                            if (isNaN(data.getTime())) {
                                console.warn('⚠️ Data inválida encontrada:', item.data);
                                return;
                            }
                            const chave = `${data.getFullYear()}-${(data.getMonth() + 1).toString().padStart(2, '0')}`;
                            if (!dadosPorMes[chave]) dadosPorMes[chave] = 0;
                            dadosPorMes[chave]++;
                        } catch (e) {
                            console.warn('⚠️ Erro ao processar data:', item.data, e);
                        }
                    }
                });
                
                console.log('� DADOS DISPONÍVEIS POR MÊS:');
                Object.keys(dadosPorMes)
                    .sort()
                    .forEach(chave => {
                        console.log(`   ${chave}: ${dadosPorMes[chave]} registros`);
                    });
                    
                const datasValidas = allData.filter(item => item.data && !isNaN(new Date(item.data).getTime()));
                if (datasValidas.length > 0) {
                    console.log('�️ Período disponível:', {
                        primeiro: datasValidas[datasValidas.length - 1]?.data,
                        ultimo: datasValidas[0]?.data
                    });
                }
                
            } catch (error) {
                console.error('❌ Erro crítico no debug:', error);
                alert('Erro crítico: ' + error.message);
            }
        }
        
        // Tornar função global para acesso de fallbacks
        window.loadDashboardContent = async function loadDashboardContent() {
            console.log('🚀 loadDashboardContent iniciada');
            
            const contentArea = document.getElementById('contentArea');
            
            // Criar estrutura principal do dashboard
            contentArea.innerHTML = getDashboardHTML();
            
            try {
                // **CORREÇÃO:** Aguardar componentes estarem prontos
                console.log('🔄 Aguardando componentes...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Inicializar componentes modulares
                await initDashboardComponents();
                
                // **NOVO:** Aguardar mais um pouco para garantir inicialização
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // **CORREÇÃO:** Carregar dados automaticamente
                console.log('📊 Carregando dados das métricas automaticamente...');
                await loadDashboardMetrics();
                
                console.log('✅ Dashboard carregado completamente');
                
            } catch (error) {
                console.error('❌ Erro ao carregar dashboard:', error);
                // **FALLBACK:** Tentar carregar dados básicos
                setTimeout(() => {
                    loadDashboardMetrics();
                }, 2000);
            }
        }

        async function initDashboardComponents() {
            try {
                console.log('🔄 Inicializando componentes do dashboard...');
                
                // **CORREÇÃO:** Aguardar carregamento de scripts
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Inicializar componentes em ordem
                console.log('📊 Inicializando MetricsCards...');
                initMetricsCards();
                
                console.log('📈 Inicializando Charts...');
                initChartsComponents();
                
                console.log('📋 Inicializando Activities...');
                initRecentActivities();
                
                console.log('🚨 Inicializando Alerts...');
                initAlertsPanel();
                
                console.log('✅ Componentes do dashboard inicializados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao inicializar componentes do dashboard:', error);
            }
        }

        function initMetricsCards() {
            console.log('🎯 initMetricsCards chamada');
            
            // **CORREÇÃO:** Aguardar carregamento do script com retry
            const attemptInit = async (attempt = 1) => {
                console.log(`📊 Tentativa ${attempt} de inicializar MetricsCards...`);
                
                // Aguardar elementos DOM estarem prontos
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const metricsContainer = document.querySelector('.metrics-container');
                console.log('📊 Metrics container found:', !!metricsContainer);
                
                // Verificar múltiplas formas de acesso à classe
                const MetricsCardsClass = window.MetricsCards || (typeof MetricsCards !== 'undefined' ? MetricsCards : null);
                console.log('� MetricsCards class available:', !!MetricsCardsClass);
                
                if (!metricsContainer) {
                    console.error('❌ Container .metrics-container não encontrado');
                    if (attempt < 3) {
                        setTimeout(() => attemptInit(attempt + 1), 1000);
                    }
                    return;
                }
                
                if (!MetricsCardsClass) {
                    console.error('❌ Classe MetricsCards não disponível');
                    if (attempt < 5) {
                        setTimeout(() => attemptInit(attempt + 1), 1000);
                    }
                    return;
                }
                
                try {
                    // **CORREÇÃO:** Inicializar e carregar dados imediatamente
                    window.dashboardMetricsCards = new MetricsCardsClass();
                    window.dashboard = window.dashboard || {};
                    window.dashboard.metricsCards = window.dashboardMetricsCards;
                    
                    await window.dashboardMetricsCards.init(metricsContainer);
                    
                    // **NOVO:** Carregar dados automaticamente após inicialização
                    const unitId = getValidUnitId();
                    if (unitId) {
                        await window.dashboardMetricsCards.updateCardsFromFilters();
                    }
                    
                    console.log('✅ MetricsCards inicializado e dados carregados');
                    
                    // REMOVIDO: inicialização automática de métricas detalhadas descontinuada
                    console.log('ℹ️ Métricas detalhadas foram removidas - apenas cards principais estão ativos');
                } catch (error) {
                    console.error('❌ Erro ao criar instância MetricsCards:', error);
                    
                    // Retry se for o primeiro erro
                    if (attempt < 3) {
                        setTimeout(() => attemptInit(attempt + 1), 1000);
                    }
                }
            };
            
            // Iniciar primeira tentativa com delay
            setTimeout(() => attemptInit(1), 100);
        }

        function initChartsComponents() {
            const chartsContainer = document.querySelector('.charts-container');
            if (chartsContainer && typeof Charts !== 'undefined') {
                window.dashboardCharts = new Charts();
                window.dashboardCharts.init(chartsContainer);
            }
        }

        function initRecentActivities() {
            const activitiesContainer = document.querySelector('.activities-container');
            if (activitiesContainer && typeof RecentActivities !== 'undefined') {
                window.recentActivities = new RecentActivities();
                window.recentActivities.init(activitiesContainer);
            }
        }

        function initAlertsPanel() {
            // Painel de alertas removido - função mantida para evitar erros
            console.log('Painel de alertas foi removido do sistema');
        }

        function getDashboardHTML() {
            return `
                <div class="dashboard-container" style="padding: 1.5rem;">
                    <!-- Cards de Métricas -->
                    <div class="metrics-container"></div>

                    <!-- Gráficos e Análises -->
                    <div class="charts-container"></div>

                    <!-- Atividades Recentes -->
                    <div class="activities-container"></div>
                </div>
            `;
        }
        

        async function loadDashboardMetrics() {
            try {
                console.log('📊 Carregando métricas do dashboard...');
                
                // **CORREÇÃO:** Usar função de validação de Unit ID
                const unitId = getValidUnitId();
                console.log('🏢 Usando Unit ID:', unitId);

                // Mostrar loading
                showMetricsLoading();

                const { month, year } = getDateFilterValues();
                
                console.log('🔄 Filtros recebidos:', { month, year });
                
                const targetTable = getSelectedTableName(unitId);
                console.log('🎯 Buscando dados na tabela:', targetTable);
                
                // **CORREÇÃO:** Declarar variáveis fora do try-catch
                let currentDataResult = null;
                
                // **CORREÇÃO:** Query base corrigida
                try {
                    console.log('📊 Construindo query para:', { targetTable, unitId });
                    
                    // Construir query base
                    const baseQuery = supabase
                        .from(targetTable)
                        .select('data, valor, cliente, servico, profissional, is_divisao, cadastro')
                        .eq('unit_id', unitId);
                    
                    // Aplicar filtros se necessário
                    let finalQuery = baseQuery.order('data', { ascending: false });

                    if ((month && month !== '') || (year && year !== '')) {
                        console.log('📅 Aplicando filtros:', { month, year });
                        
                        // Se apenas mês está selecionado
                        if (month && month !== '' && (!year || year === '')) {
                            const currentMonth = parseInt(month);
                            const currentYear = new Date().getFullYear(); // Usar ano atual como padrão
                            const { startDate, endDate } = formatDateRange(currentYear, currentMonth);
                            
                            finalQuery = baseQuery
                                .gte('data', startDate)
                                .lte('data', endDate)
                                .order('data', { ascending: false });
                                
                            console.log('📅 Filtro apenas por mês:', { currentMonth, currentYear, startDate, endDate });
                        }
                        // Se apenas ano está selecionado
                        else if (year && year !== '' && (!month || month === '')) {
                            const currentYear = parseInt(year);
                            
                            finalQuery = baseQuery
                                .gte('data', `${currentYear}-01-01`)
                                .lte('data', `${currentYear}-12-31`)
                                .order('data', { ascending: false });
                                
                            console.log('📅 Filtro apenas por ano:', { currentYear });
                        }
                        // Se ambos estão selecionados
                        else if (month && month !== '' && year && year !== '') {
                            const currentMonth = parseInt(month);
                            const currentYear = parseInt(year);
                            const { startDate, endDate } = formatDateRange(currentYear, currentMonth);
                            
                            finalQuery = baseQuery
                                .gte('data', startDate)
                                .lte('data', endDate)
                                .order('data', { ascending: false });
                                
                            console.log('📅 Filtro por mês E ano:', { currentMonth, currentYear, startDate, endDate });
                        }
                    } else {
                        console.log('📅 Sem filtros aplicados - mostrando todos os dados');
                    }
                    
                    // Executar query
                    const { data: queryResult, error: currentError } = await finalQuery;
                    
                    if (currentError) {
                        console.error('❌ Erro na query:', currentError);
                        throw new Error(`Erro ao buscar dados: ${currentError.message}`);
                    }
                    
                    currentDataResult = queryResult;
                    console.log('✅ Query executada com sucesso:', currentDataResult?.length || 0, 'registros');
                    
                } catch (error) {
                    console.error('❌ Erro crítico na query:', error);
                    displayErrorState();
                    return;
                }

                // **CORREÇÃO:** Query para dados anteriores - SOMENTE quando filtro específico for aplicado
                let prevDataResult = [];
                if (month && year && month !== '' && year !== '') { 
                    const currentMonth = parseInt(month);
                    const currentYear = parseInt(year);
                    
                    // Mês anterior
                    let prevMonth = currentMonth - 1;
                    let prevYear = currentYear;
                    if (prevMonth < 1) {
                        prevMonth = 12;
                        prevYear = currentYear - 1;
                    }
                    
                    const { startDate: prevStartDate, endDate: prevEndDate } = formatDateRange(prevYear, prevMonth);
                    
                    let prevQuery = supabase
                        .from(targetTable)
                        .select('data, valor, cliente, servico, profissional, is_divisao, cadastro')
                        .eq('unit_id', unitId)
                        .gte('data', prevStartDate)
                        .lte('data', prevEndDate)
                        .order('data', { ascending: false });
                        
                    console.log('📅 Filtro período anterior:', { prevStartDate, prevEndDate, prevMonth, prevYear });
                    
                    const { data: prevResult, error: prevError } = await prevQuery;
                    
                    if (prevError) {
                        console.warn('⚠️ Erro ao buscar dados do mês anterior:', prevError);
                        prevDataResult = [];
                    } else {
                        prevDataResult = prevResult || [];
                        console.log('✅ Dados mês anterior carregados:', prevDataResult.length, 'registros');
                    }
                } else {
                    console.log('📅 Modo "Todos" - sem comparação com mês anterior');
                }

                // Calcular e exibir métricas
                if (currentDataResult) {
                    await calculateAndDisplayMetrics(currentDataResult || [], prevDataResult || []);
                    hideMetricsLoading();
                } else {
                    console.error('❌ Nenhum dado recebido do Supabase');
                    displayErrorState();
                }

            } catch (error) {
                console.error('❌ Erro ao carregar métricas:', error);
                // **CORREÇÃO:** Não fazer logout, apenas mostrar erro
                displayErrorState('Erro ao carregar dados: ' + error.message);
                hideMetricsLoading();
            }
        }

        function showMetricsLoading() {
            const cards = ['atendimentos', 'faturamento', 'clientes', 'semana'];
            cards.forEach(cardType => {
                const valueElement = document.getElementById(`metric-${cardType}`);
                const compElement = document.getElementById(`metric-${cardType}-comp`);
                if (valueElement) {
                    valueElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    valueElement.style.color = '#6c757d';
                }
                if (compElement) {
                    compElement.innerHTML = 'Carregando...';
                    compElement.style.color = '#6c757d';
                }
            });
        }

        function hideMetricsLoading() {
            // Loading será removido automaticamente quando updateMetricCard for chamado
        }

        function calculateWeeklyAttendance(data) {
            // Usar a nova função com offset 0 (semana atual)
            return calculateWeekAttendanceWithOffset(data, currentWeekOffset);
        }

        function calculatePreviousWeekAttendance(data) {
            // Usar a nova função com offset -1 (semana anterior)
            return calculateWeekAttendanceWithOffset(data, currentWeekOffset - 1);
        }

        function getCurrentWeekPeriod() {
            // Usar a nova função getWeekPeriod com offset 0 (semana atual)
            return getWeekPeriod(0).period;
        }

        // Tornar a função disponível globalmente
        window.getCurrentWeekPeriod = getCurrentWeekPeriod;

        // Variável global para controlar a semana sendo visualizada
        let currentWeekOffset = 0; // 0 = semana atual, -1 = semana anterior, 1 = próxima semana

        function getWeekPeriod(weekOffset = 0) {
            // Obter período da semana com offset (Domingo a Sábado)
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
            
            // Calcular início da semana atual (domingo)
            const startOfCurrentWeek = new Date(now);
            startOfCurrentWeek.setDate(now.getDate() - currentDay); // Voltar para o domingo
            
            // Aplicar offset (semanas)
            const startOfWeek = new Date(startOfCurrentWeek);
            startOfWeek.setDate(startOfCurrentWeek.getDate() + (weekOffset * 7));
            
            // Calcular fim da semana (sábado)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Domingo + 6 dias = Sábado
            
            // Formatar datas
            const formatOptions = { day: '2-digit', month: '2-digit' };
            const startFormatted = startOfWeek.toLocaleDateString('pt-BR', formatOptions);
            const endFormatted = endOfWeek.toLocaleDateString('pt-BR', formatOptions);
            
            return {
                period: `${startFormatted} - ${endFormatted}`,
                startDate: startOfWeek,
                endDate: endOfWeek
            };
        }

        function calculateWeekAttendanceWithOffset(data, weekOffset = 0) {
            // Obter dados da semana com offset
            const { startDate, endDate } = getWeekPeriod(weekOffset);
            
            // Ajustar horários
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            console.log(`📅 Calculando semana (offset ${weekOffset}):`, {
                inicio: startDate.toLocaleDateString('pt-BR'),
                fim: endDate.toLocaleDateString('pt-BR')
            });
            
            // Filtrar atendimentos da semana especificada
            const weeklyData = data.filter(item => {
                if (!item.data) return false;
                
                const itemDate = new Date(item.data);
                return itemDate >= startDate && itemDate <= endDate;
            });
            
            console.log(`📊 Atendimentos da semana (offset ${weekOffset}):`, {
                total: weeklyData.length,
                periodo: `${startDate.toLocaleDateString('pt-BR')} - ${endDate.toLocaleDateString('pt-BR')}`
            });
            
            return weeklyData.length;
        }

        function navigateWeek(direction) {
            console.log(`🔄 Navegando semana: ${direction > 0 ? 'próxima' : 'anterior'}`);
            
            // Limitar navegação (não permitir ir mais de 8 semanas para frente ou trás)
            const newOffset = currentWeekOffset + direction;
            if (newOffset < -8 || newOffset > 4) {
                console.warn('⚠️ Limite de navegação atingido');
                return;
            }
            
            currentWeekOffset = newOffset;
            
            // Atualizar período exibido
            const { period } = getWeekPeriod(currentWeekOffset);
            const periodElement = document.getElementById('week-period-semana');
            if (periodElement) {
                periodElement.textContent = period;
            }
            
            // Recarregar dados da semana
            updateWeekCard();
        }

        async function updateWeekCard() {
            // Usar a nova função de comparação
            await updateWeekCardWithComparison();
        }

        // Tornar funções disponíveis globalmente
        window.navigateWeek = navigateWeek;

        /**
         * Atualiza o card da semana com comparação correta
         * Busca dados suficientes para calcular semana atual vs anterior
         */
        async function updateWeekCardWithComparison() {
            try {
                console.log('📊 Atualizando card da semana com comparação...');
                
                // Mostrar loading no card da semana
                const valueElement = document.getElementById('metric-semana');
                const compElement = document.getElementById('metric-semana-comp');
                
                if (valueElement) {
                    valueElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    valueElement.style.color = '#6c757d';
                }
                if (compElement) {
                    compElement.innerHTML = 'Carregando...';
                }
                
                // Obter configurações
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const unitSelect = document.getElementById('unitSelect');
                const unitId = unitSelect ? unitSelect.value : userSession.unit_id;
                
                if (!unitId) {
                    console.error('❌ Unit ID não encontrado para atualização da semana');
                    return;
                }
                
                const targetTable = getSelectedTableName(unitId);
                
                // Buscar dados dos últimos 3 meses para ter dados suficientes para comparação
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const startDate = threeMonthsAgo.toISOString().split('T')[0];
                
                const { data: allData, error } = await supabase
                    .from(targetTable)
                    .select('data, valor, cliente, is_divisao')
                    .eq('unit_id', unitId)
                    .gte('data', startDate)
                    .order('data', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao buscar dados para semana:', error);
                    // Em caso de erro, mostrar valores zerados
                    updateWeekCardDisplay(0, 0);
                    return;
                }
                
                // Filtrar dados válidos
                const validData = allData ? allData.filter(item => item.is_divisao !== 'SIM') : [];
                
                // Calcular atendimentos da semana atual (com offset) e anterior
                const currentWeekCount = calculateWeekAttendanceWithOffset(validData, currentWeekOffset);
                const previousWeekCount = calculateWeekAttendanceWithOffset(validData, currentWeekOffset - 1);
                
                console.log('📊 Comparação de semanas:', {
                    semanaAtual: currentWeekCount,
                    semanaAnterior: previousWeekCount,
                    offset: currentWeekOffset
                });
                
                // Atualizar display
                updateWeekCardDisplay(currentWeekCount, previousWeekCount);
                
            } catch (error) {
                console.error('❌ Erro ao atualizar card da semana:', error);
                // Em caso de erro, mostrar valores zerados
                updateWeekCardDisplay(0, 0);
            }
        }

        /**
         * ✅ FUNÇÃO OTIMIZADA: Buscar dados de métricas
         */
        async function fetchMetricsDataOptimized(unitId) {
            const { month, year } = getDateFilterValues();
            const targetTable = getSelectedTableName(unitId);
            
            console.log('🔍 Buscando dados otimizados:', { unitId, month, year, table: targetTable });
            
            let query = supabase
                .from(targetTable)
                .select('data, valor, cliente, servico, is_divisao, cadastro')
                .eq('unit_id', unitId);
            
            // Aplicar filtros se especificados
            if (month && year && month !== '' && year !== '') {
                const currentMonth = parseInt(month);
                const currentYear = parseInt(year);
                const { startDate, endDate } = formatDateRange(currentYear, currentMonth);
                
                query = query
                    .gte('data', startDate)
                    .lte('data', endDate);
                    
                console.log('📅 Filtros aplicados:', { startDate, endDate });
            }
            
            const { data, error } = await query.order('data', { ascending: false });
            
            if (error) {
                console.error('❌ Erro na consulta:', error);
                throw error;
            }
            
            console.log('📊 Dados recebidos:', data?.length || 0, 'registros');
            return data || [];
        }

        /**
         * ✅ FUNÇÃO: Atualizar todos os cards de uma vez
         */
        async function updateAllCards(rawData) {
            const validData = rawData.filter(item => item.is_divisao !== 'SIM');
            
            // Calcular todas as métricas
            const metrics = {
                atendimentos: validData.length,
                faturamento: validData.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0),
                clientes: new Set(validData.map(item => item.cliente).filter(Boolean)).size,
                inicioMes: calculateInicioMesFromData(validData)
            };
            
            console.log('📊 Métricas calculadas:', metrics);
            
            // Atualizar cards principais
            updateSimpleCard('atendimentos', metrics.atendimentos);
            updateSimpleCard('faturamento', metrics.faturamento, true);
            updateSimpleCard('clientes', metrics.clientes);
            
            // **ESPECÍFICO:** Atualizar card semana com comparação
            await updateWeekCardWithComparison();
            
            // **NOVO:** Se MetricsCards estiver disponível, atualizar também
            if (window.dashboardMetricsCards && window.dashboardMetricsCards.updateCardValue) {
                window.dashboardMetricsCards.updateCardValue('inicio-mes', metrics.inicioMes);
            }
        }

        /**
         * ✅ FUNÇÃO SIMPLIFICADA: Atualizar card básico
         */
        function updateSimpleCard(type, value, isCurrency = false) {
            const element = document.getElementById(`metric-${type}`);
            if (element) {
                if (isCurrency) {
                    element.textContent = new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                } else {
                    element.textContent = value.toLocaleString('pt-BR');
                }
                element.style.color = 'var(--text-primary)';
            }
        }

        /**
         * ✅ FUNÇÃO: Calcular início mês dos dados
         */
        function calculateInicioMesFromData(data) {
            // Implementação básica - pode ser expandida conforme necessário
            return data.filter(item => {
                if (!item.cadastro || !item.data) return false;
                const cadastroDate = new Date(item.cadastro);
                const dataDate = new Date(item.data);
                return cadastroDate.getMonth() !== dataDate.getMonth() || 
                       cadastroDate.getFullYear() !== dataDate.getFullYear();
            }).length;
        }

        /**
         * ✅ FUNÇÃO: Obter Unit ID válido
         */
        function getValidUnitId() {
            const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
            const unitSelect = document.getElementById('unitSelect');
            const unitId = unitSelect ? unitSelect.value : userSession.unit_id;
            
            if (!unitId) {
                console.error('❌ Unit ID não encontrado');
                return null;
            }
            
            return unitId;
        }

        /**
         * ✅ FUNÇÃO AUXILIAR: Acesso seguro ao DOM
         */
        function safeDOMAccess(elementId, context = '') {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`⚠️ DOM: Elemento '${elementId}' não encontrado${context ? ` em ${context}` : ''}`);
            }
            return element;
        }

        /**
         * ✅ FUNÇÃO CORRIGIDA: updateWeekCardDisplay
         */
        function updateWeekCardDisplay(current, previous) {
            console.log('📊 updateWeekCardDisplay chamada:', { current, previous });
            
            const valueElement = safeDOMAccess('metric-semana', 'updateWeekCardDisplay');
            const compElement = safeDOMAccess('metric-semana-comp', 'updateWeekCardDisplay');
            
            if (!valueElement || !compElement) {
                console.error('❌ Elementos do card semana não encontrados');
                return;
            }
            
            // Formatar valor atual
            const formattedValue = current.toLocaleString('pt-BR');
            valueElement.textContent = formattedValue;
            valueElement.style.color = ''; // Reset color
            
            // Calcular variação percentual
            let variation = 0;
            if (previous > 0) {
                variation = ((current - previous) / previous) * 100;
            } else if (current > 0) {
                variation = 100; // 100% de crescimento se não havia dados na semana anterior
            }
            
            // Formatar comparação
            const isPositive = variation >= 0;
            const arrow = isPositive ? '↗' : '↘';
            const color = isPositive ? 'var(--success-color)' : 'var(--danger-color)';
            
            compElement.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: ${color}; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                        <small style="font-size: 0.7rem; opacity: 0.8;">Semana Anterior</small>
                        ${arrow} ${Math.abs(variation).toFixed(1)}%
                    </span>
                </div>
            `;
            
            console.log('✅ Card da semana atualizado:', {
                atual: current,
                anterior: previous,
                variacao: variation.toFixed(1) + '%'
            });
        }

        async function calculateAndDisplayMetrics(currentData, prevData) {
            // Filtrar dados válidos (excluir divisões)
            const current = currentData.filter(item => item.is_divisao !== 'SIM');
            const previous = prevData.filter(item => item.is_divisao !== 'SIM');

            // Calcular métricas atuais
            const currentMetrics = {
                atendimentos: current.length,
                faturamento: current.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0),
                clientes: new Set(current.map(item => item.cliente).filter(Boolean)).size,
                semana: calculateWeeklyAttendance(current)
            };

            // Calcular métricas anteriores
            const prevMetrics = {
                atendimentos: previous.length,
                faturamento: previous.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0),
                clientes: new Set(previous.map(item => item.cliente).filter(Boolean)).size,
                semana: 0 // Será calculado separadamente
            };

            // Atualizar interface (agora de forma assíncrona)
            try {
                await Promise.all([
                    updateMetricCard('atendimentos', currentMetrics.atendimentos, prevMetrics.atendimentos),
                    updateMetricCard('faturamento', currentMetrics.faturamento, prevMetrics.faturamento, true),
                    updateMetricCard('clientes', currentMetrics.clientes, prevMetrics.clientes),
                    updateWeekCardWithComparison() // Usar função específica para semana
                ]);
                
                console.log('✅ Todos os cards atualizados com sucesso');
            } catch (error) {
                console.error('❌ Erro ao atualizar cards:', error);
            }

            // **NOVA FUNCIONALIDADE:** Atualizar métricas detalhadas se estão visíveis
            if (window.dashboardMetricsCards && window.dashboardMetricsCards.detailsVisible) {
                console.log('🔄 Atualizando métricas detalhadas devido a mudança de filtros...');
                setTimeout(() => {
                    window.dashboardMetricsCards.updateActiveDetails();
                }, 500); // Pequeno delay para garantir que os cards principais foram atualizados
            }

            // **CORREÇÃO:** Componentes de gráficos foram removidos
            // loadResumoPeriodo(current); - Removido
            // loadTopServicos(current); - Removido  
            // loadUltimosAtendimentos(current); - Removido
            // loadChartData(current); - Removido (gráficos removidos)
        }

        async function updateMetricCard(type, current, previous, isCurrency = false) {
            console.log(`🔍 updateMetricCard chamada para ${type}:`, { current, previous, isCurrency });
            
            const valueElement = document.getElementById(`metric-${type}`);
            const compElement = document.getElementById(`metric-${type}-comp`);
            const yearCompElement = document.getElementById(`metric-${type}-year-comp`);
            
            console.log(`📊 Elementos encontrados para ${type}:`, {
                value: !!valueElement,
                comp: !!compElement,
                yearComp: !!yearCompElement
            });
            
            if (!valueElement || !compElement) {
                console.error(`❌ Elementos não encontrados para métrica ${type}`);
                return;
            }

            // Formatar valor
            let formattedValue;
            if (isCurrency) {
                formattedValue = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(current);
            } else {
                formattedValue = current.toLocaleString('pt-BR');
            }
            
            valueElement.textContent = formattedValue;
            valueElement.style.color = ''; // Reset color

            // Calcular variação mensal
            let variation = 0;
            if (previous > 0) {
                variation = ((current - previous) / previous) * 100;
            } else if (current > 0) {
                variation = 100;
            }

            // Obter nome do mês anterior
            const previousMonthName = getPreviousMonthName();

            // Formatar comparação mensal
            const isPositive = variation >= 0;
            const arrow = isPositive ? '↗' : '↘';
            const color = isPositive ? 'var(--success-color)' : 'var(--danger-color)';
            
            // Para o card "semana", mostrar apenas comparação com semana anterior
            if (type === 'semana') {
                compElement.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 0.5rem;">
                        <span style="color: ${color}; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                            <small style="font-size: 0.7rem; opacity: 0.8;">Semana Anterior</small>
                            ${arrow} ${Math.abs(variation).toFixed(1)}%
                        </span>
                    </div>
                `;
            } else {
                // Para outros cards, calcular comparação real com ano anterior
                let yearVariation = 0;
                try {
                    const yearMetric = await calculateYearOverYearComparison(type, current);
                    yearVariation = yearMetric.variation;
                } catch (error) {
                    console.warn(`⚠️ Erro ao calcular comparação anual para ${type}:`, error);
                    yearVariation = 0;
                }
                
                const yearIsPositive = yearVariation >= 0;
                const yearArrow = yearIsPositive ? '↗' : '↘';
                const yearColor = yearIsPositive ? 'var(--success-color)' : 'var(--danger-color)';
                const previousYear = new Date().getFullYear() - 1;
                
                compElement.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <span style="color: ${color}; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                            <small style="font-size: 0.7rem; opacity: 0.8;">${previousMonthName}</small>
                            ${arrow} ${Math.abs(variation).toFixed(1)}%
                        </span>
                        <span style="color: ${yearColor}; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                            <small style="font-size: 0.7rem; opacity: 0.8;">${previousYear}</small>
                            ${yearArrow} ${Math.abs(yearVariation).toFixed(1)}%
                        </span>
                    </div>
                `;
            }

            // Remover a atualização separada do yearCompElement já que está tudo no compElement agora
            if (yearCompElement) {
                yearCompElement.innerHTML = ''; // Limpar para evitar duplicação
            }
        }

        function getPreviousMonthName() {
            const { month, year } = getDateFilterValues();
            
            // Se há filtro específico, calcular baseado no filtro
            if (month && year && month !== '' && year !== '') {
                const currentMonth = parseInt(month);
                let prevMonth = currentMonth - 1;
                
                if (prevMonth < 1) {
                    prevMonth = 12;
                }
                
                const monthNames = [
                    '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                return monthNames[prevMonth];
            } else {
                // Se não há filtro, usar mês atual menos 1
                const now = new Date();
                const currentMonth = now.getMonth(); // 0-11 (Janeiro = 0)
                let prevMonth = currentMonth - 1;
                
                if (prevMonth < 0) {
                    prevMonth = 11;
                }
                
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                return monthNames[prevMonth];
            }
        }

        /**
         * Calcula comparação com o mesmo período do ano anterior
         * @param {string} type - Tipo da métrica (atendimentos, faturamento, clientes)
         * @param {number} currentValue - Valor atual da métrica
         * @returns {object} Objeto com variação percentual
         */
        async function calculateYearOverYearComparison(type, currentValue) {
            try {
                const { month, year } = getDateFilterValues();
                
                // Se não há filtro específico, comparar com os dados de um ano atrás
                if (!month || !year || month === '' || year === '') {
                    // Usar período atual vs mesmo período do ano passado
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1; // getMonth() retorna 0-11, precisamos 1-12
                    
                    return await calculateYearComparisonForPeriod(type, currentMonth, currentYear, currentValue);
                } else {
                    // Usar período filtrado vs mesmo período do ano anterior
                    const currentMonth = parseInt(month);
                    const currentYear = parseInt(year);
                    
                    return await calculateYearComparisonForPeriod(type, currentMonth, currentYear, currentValue);
                }
            } catch (error) {
                console.error('❌ Erro ao calcular comparação anual:', error);
                return { variation: 0, previousYearValue: 0 };
            }
        }

        /**
         * Calcula comparação para um período específico
         * @param {string} type - Tipo da métrica
         * @param {number} month - Mês (1-12)
         * @param {number} year - Ano atual
         * @param {number} currentValue - Valor atual
         * @returns {object} Comparação calculada
         */
        async function calculateYearComparisonForPeriod(type, month, year, currentValue) {
            try {
                const previousYear = year - 1;
                
                // Obter configurações
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                let unitId = userSession.unit_id || localStorage.getItem('selectedUnit');
                
                if (!unitId) {
                    unitId = '53a19414-8331-4b31-a337-e8b43872e2a1';
                }
                
                const targetTable = getSelectedTableName(unitId);
                
                // Construir query para dados do ano anterior
                const { startDate, endDate } = formatDateRange(previousYear, month);
                
                console.log(`📊 Buscando dados do ano anterior para ${type}:`, {
                    period: `${month}/${previousYear}`,
                    dateRange: { startDate, endDate },
                    table: targetTable
                });
                
                const { data: previousYearData, error } = await supabase
                    .from(targetTable)
                    .select('data, valor, cliente, servico, is_divisao')
                    .eq('unit_id', unitId)
                    .gte('data', startDate)
                    .lte('data', endDate);
                
                if (error) {
                    console.warn('⚠️ Erro ao buscar dados do ano anterior:', error);
                    return { variation: 0, previousYearValue: 0 };
                }
                
                if (!previousYearData || previousYearData.length === 0) {
                    console.log('📊 Nenhum dado encontrado para o ano anterior');
                    // Se não há dados do ano anterior, consideramos 100% de crescimento
                    return { variation: currentValue > 0 ? 100 : 0, previousYearValue: 0 };
                }
                
                // Filtrar dados válidos (excluir divisões)
                const validPreviousData = previousYearData.filter(item => item.is_divisao !== 'SIM');
                
                // Calcular valor do ano anterior baseado no tipo de métrica
                let previousYearValue = 0;
                
                switch (type) {
                    case 'atendimentos':
                        previousYearValue = validPreviousData.length;
                        break;
                    case 'faturamento':
                        previousYearValue = validPreviousData.reduce((sum, item) => sum + (parseFloat(item.valor) || 0), 0);
                        break;
                    case 'clientes':
                        previousYearValue = new Set(validPreviousData.map(item => item.cliente).filter(Boolean)).size;
                        break;
                    default:
                        previousYearValue = validPreviousData.length;
                }
                
                // Calcular variação percentual
                let variation = 0;
                if (previousYearValue > 0) {
                    variation = ((currentValue - previousYearValue) / previousYearValue) * 100;
                } else if (currentValue > 0) {
                    variation = 100; // 100% de crescimento se não havia dados no ano anterior
                }
                
                console.log(`📊 Comparação anual para ${type}:`, {
                    current: currentValue,
                    previousYear: previousYearValue,
                    variation: variation.toFixed(1) + '%',
                    period: `${month}/${year} vs ${month}/${previousYear}`
                });
                
                return { variation, previousYearValue };
                
            } catch (error) {
                console.error('❌ Erro ao calcular comparação para período específico:', error);
                return { variation: 0, previousYearValue: 0 };
            }
        }

        function loadResumoPeriodo(data) {
            const container = document.getElementById('resumo-periodo');
            
            // Agrupar por período
            const periodos = {};
            data.forEach(item => {
                const periodo = item.periodo || 'Não informado';
                if (!periodos[periodo]) {
                    periodos[periodo] = { count: 0, value: 0 };
                }
                periodos[periodo].count++;
                periodos[periodo].value += parseFloat(item.valor) || 0;
            });

            const html = Object.entries(periodos)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 5)
                .map(([periodo, data]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-primary);">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${periodo}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${data.count} atendimentos</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--success-color);">
                                ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(data.value)}
                            </div>
                        </div>
                    </div>
                `).join('');

            container.innerHTML = html || '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhum dado encontrado</p>';
        }

        function loadTopServicos(data) {
            const container = document.getElementById('top-servicos');
            
            // Agrupar por serviço
            const servicos = {};
            data.forEach(item => {
                const servico = item.servico || 'Não informado';
                if (!servicos[servico]) {
                    servicos[servico] = { count: 0, value: 0 };
                }
                servicos[servico].count++;
                servicos[servico].value += parseFloat(item.valor) || 0;
            });

            const html = Object.entries(servicos)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 5)
                .map(([servico, data]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-primary);">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${servico}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">${data.count} atendimentos</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--success-color);">
                                ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(data.value)}
                            </div>
                        </div>
                    </div>
                `).join('');

            container.innerHTML = html || '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhum dado encontrado</p>';
        }

        function loadUltimosAtendimentos(data) {
            const container = document.getElementById('ultimos-atendimentos');
            
            const html = data
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 10)
                .map(item => {
                    const date = new Date(item.data);
                    const formattedDate = date.toLocaleDateString('pt-BR');
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-primary);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary);">${item.cliente || 'Cliente não informado'}</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">${item.servico || 'Serviço não informado'}</div>
                            </div>
                            <div style="text-align: center; margin: 0 1rem;">
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">${formattedDate}</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">${item.horario || ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--success-color);">
                                    ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(item.valor) || 0)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            container.innerHTML = html || '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Nenhum atendimento encontrado</p>';
        }

        function displayErrorState() {
            const cards = ['atendimentos', 'faturamento', 'clientes', 'semana'];
            cards.forEach(type => {
                const valueElement = document.getElementById(`metric-${type}`);
                const compElement = document.getElementById(`metric-${type}-comp`);
                if (valueElement) valueElement.textContent = 'Erro';
                if (compElement) compElement.textContent = 'Falha ao carregar dados';
            });
            
            // **CORREÇÃO:** Remover referências a elementos que não existem mais
            // ['resumo-periodo', 'top-servicos', 'ultimos-atendimentos'] - Removidos
        }

        // Variável global para controlar o painel de alertas - REMOVIDO
        // let alertsPanel = null;

        // Função para alternar o painel de alertas - REMOVIDO
        function toggleAlertsPanel() {
            // Painel de alertas foi removido - função mantida para evitar erros
            console.log('Painel de alertas foi removido do sistema');
        }

        // Função para inicializar o painel de alertas - REMOVIDO
        function initializeAlertsPanel() {
            // Painel de alertas foi removido - função mantida para evitar erros
            console.log('Painel de alertas foi removido do sistema');
        }

        // Event listeners relacionados aos alertas - REMOVIDOS
        document.addEventListener('click', function(event) {
            // Event listener do painel de alertas removido
        });

        // Função para carregar dados dos gráficos
        async function loadChartData(allData) {
            // **CORREÇÃO:** Gráficos foram removidos, função mantida para compatibilidade
            console.log('📊 loadChartData chamada, mas gráficos foram removidos');
            return;
        }

        // Função auxiliar para buscar dados de um mês específico
        async function getMonthData(unitId, year, month) {
            try {
                const targetTable = getSelectedTableName(unitId);
                const { startDate, endDate } = formatDateRange(year, month);
                
                const { data, error } = await supabase
                    .from(targetTable)
                    .select('data, valor, cliente, servico, profissional, is_divisao, cadastro')
                    .eq('unit_id', unitId)
                    .gte('data', startDate)
                    .lte('data', endDate)
                    .order('data', { ascending: false });
                
                if (error) {
                    console.error(`❌ Erro ao buscar dados de ${month}/${year}:`, error);
                    return [];
                }
                
                return data || [];
            } catch (error) {
                console.error(`❌ Erro na busca de dados de ${month}/${year}:`, error);
                return [];
            }
        }

        // **NOVA FUNÇÃO:** Limpar cache quando necessário
        function clearSidebarCache() {
            localStorage.removeItem('userSession');
            localStorage.removeItem('unitsCache');
            localStorage.removeItem('cacheTimestamp');
            console.log('🧹 Cache do sidebar limpo');
        }

        // **NOVA FUNÇÃO:** Verificar se cache é válido (1 hora)
        function isCacheValid() {
            const timestamp = localStorage.getItem('cacheTimestamp');
            if (!timestamp) return false;
            
            const cacheAge = Date.now() - parseInt(timestamp);
            const maxAge = 60 * 60 * 1000; // 1 hora
            
            return cacheAge < maxAge;
        }

        // **NOVA FUNÇÃO:** Forçar atualização do cache quando necessário
        function forceRefreshCache() {
            clearSidebarCache();
            console.log('🔄 Forçando atualização do cache...');
            
            // Recarregar dados do usuário
            const userSession = localStorage.getItem('userSession');
            if (userSession) {
                const user = JSON.parse(userSession);
                loadUserUnits(user);
                if (user.unit_id) {
                    loadUserModules(user.unit_id);
                }
            }
        }

        // **NOVA FUNÇÃO:** Inicializar eventos do sidebar com debounce
        function initializeSidebarEvents() {
            const unitSelect = document.getElementById('unitSelect');
            if (unitSelect) {
                // Debounce para evitar múltiplas chamadas
                let timeout;
                unitSelect.addEventListener('change', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        const selectedUnit = this.value;
                        localStorage.setItem('selectedUnit', selectedUnit);
                        console.log('🏢 Unidade alterada para:', selectedUnit);
                        
                        // Recarregar apenas se necessário
                        const contentArea = document.getElementById('contentArea');
                        if (contentArea && contentArea.innerHTML.includes('dashboard-container')) {
                            loadDashboardMetrics();
                        }
                    }, 300);
                });
            }
            
            // **CORREÇÃO:** Definir unidade padrão se não selecionada
            if (unitSelect && !unitSelect.value) {
                const userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
                const selectedUnit = localStorage.getItem('selectedUnit');
                
                if (selectedUnit) {
                    unitSelect.value = selectedUnit;
                } else if (userSession.unit_id) {
                    unitSelect.value = userSession.unit_id;
                    localStorage.setItem('selectedUnit', userSession.unit_id);
                }
            }
        }

        // Inicializar badge de notificação quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Badge de notificação removido
        });

        // **NOVA FUNÇÃO:** Debug do sidebar
        function debugSidebar() {
            const sidebar = document.getElementById('sidebar');
            const userSession = localStorage.getItem('userSession');
            
            console.log('🔍 DEBUG SIDEBAR:');
            console.log('- Elemento sidebar existe:', !!sidebar);
            console.log('- Sidebar opacity:', sidebar?.style.opacity);
            console.log('- Sidebar display:', sidebar?.style.display);
            console.log('- Sidebar classes:', sidebar?.className);
            console.log('- UserSession existe:', !!userSession);
            
            if (userSession) {
                try {
                    const user = JSON.parse(userSession);
                    console.log('- User data:', { id: user.id, name: user.name, role: user.role_name });
                } catch (e) {
                    console.log('- Erro ao parsear user session:', e);
                }
            }
            
            // **CORREÇÃO:** Forçar sidebar a aparecer
            if (sidebar) {
                sidebar.style.opacity = '1';
                sidebar.style.display = 'flex';
                console.log('🔧 Sidebar forçado a aparecer');
            }
        }

        // Executar debug após 2 segundos se sidebar não aparecer
        setTimeout(() => {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar || sidebar.style.opacity === '0' || sidebar.style.display === 'none') {
                console.warn('⚠️ Sidebar não está visível, executando debug...');
                debugSidebar();
            }
        }, 2000);
    </script>

    <!-- Sistema Modular DASHFLOW -->
    <script>
        // Sistema de debug avançado
        window.DASHFLOW_DEBUG = {
            loadedScripts: new Set(),
            errors: [],
            initSteps: [],
            
            log: function(message, type = 'info') {
                const timestamp = new Date().toTimeString().slice(0, 8);
                const logMessage = `[${timestamp}] 🔧 DASHFLOW: ${message}`;
                
                if (type === 'error') {
                    console.error(logMessage);
                    this.errors.push(message);
                } else {
                    console.log(logMessage);
                }
                
                this.initSteps.push(`${timestamp}: ${message}`);
            },
            
            showStatus: function() {
                console.group('🔍 DASHFLOW Debug Status');
                console.log('📁 Scripts carregados:', Array.from(this.loadedScripts));
                console.log('⚙️ Passos de inicialização:', this.initSteps);
                console.log('❌ Erros encontrados:', this.errors);
                console.log('🌍 Window objects:', {
                    DashboardCore: !!window.DashboardCore,
                    CacheManager: !!window.CacheManager,
                    ApiConfig: !!window.ApiConfig,
                    ModuleLoader: !!window.ModuleLoader
                });
                console.groupEnd();
            }
        };

        // Carregar sistema modular com debug detalhado
        async function loadModularSystem() {
            try {
                window.DASHFLOW_DEBUG.log('Iniciando carregamento do sistema modular...');
                
                // Verificar estado inicial
                const initialState = {
                    readyState: document.readyState,
                    location: window.location.href,
                    userAgent: navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other'
                };
                window.DASHFLOW_DEBUG.log(`Estado inicial: ${JSON.stringify(initialState)}`);
                
                // Lista de arquivos core em ordem de dependência
                const coreFiles = [
                    'dashboard/core/cache-manager.js',
                    'dashboard/core/api-config.js', 
                    'dashboard/core/module-loader.js',
                    'dashboard/core/dashboard-core.js'
                ];
                
                window.DASHFLOW_DEBUG.log(`Carregando ${coreFiles.length} arquivos core...`);
                
                // Carregar arquivos core sequencialmente com retry
                for (let i = 0; i < coreFiles.length; i++) {
                    const file = coreFiles[i];
                    const attempt = 1;
                    const maxAttempts = 2;
                    
                    let success = false;
                    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                        try {
                            window.DASHFLOW_DEBUG.log(`Carregando ${file} (tentativa ${attempt}/${maxAttempts})...`);
                            await loadScriptWithTimeout(file, 10000); // 10 segundos timeout
                            window.DASHFLOW_DEBUG.loadedScripts.add(file);
                            window.DASHFLOW_DEBUG.log(`✅ ${file} carregado com sucesso`);
                            success = true;
                            break;
                        } catch (error) {
                            window.DASHFLOW_DEBUG.log(`❌ Erro ao carregar ${file} (tentativa ${attempt}): ${error.message}`, 'error');
                            if (attempt === maxAttempts) {
                                window.DASHFLOW_DEBUG.log(`⚠️ Falha definitiva ao carregar ${file}, continuando...`, 'error');
                            } else {
                                // Aguardar antes de tentar novamente
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                    }
                }
                
                // Aguardar um pouco para garantir que as classes estão disponíveis
                window.DASHFLOW_DEBUG.log('Aguardando classes estarem disponíveis...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Verificar disponibilidade das classes
                const classesStatus = {
                    CacheManager: !!window.CacheManager,
                    ApiConfig: !!window.ApiConfig,
                    ModuleLoader: !!window.ModuleLoader,
                    DashboardCore: !!window.DashboardCore
                };
                window.DASHFLOW_DEBUG.log(`Status das classes: ${JSON.stringify(classesStatus)}`);
                
                // Tentar inicializar sistema core
                if (window.DashboardCore) {
                    window.DASHFLOW_DEBUG.log('DashboardCore encontrado, inicializando...');
                    
                    try {
                        window.dashboardCore = new window.DashboardCore();
                        window.DASHFLOW_DEBUG.log('Instância DashboardCore criada');
                        
                        await window.dashboardCore.init();
                        window.DASHFLOW_DEBUG.log('✅ Sistema modular inicializado com sucesso!');
                        
                        // Mostrar status final
                        setTimeout(() => {
                            window.DASHFLOW_DEBUG.showStatus();
                        }, 1000);
                        
                    } catch (initError) {
                        window.DASHFLOW_DEBUG.log(`❌ Erro na inicialização do DashboardCore: ${initError.message}`, 'error');
                        throw initError;
                    }
                    
                } else {
                    window.DASHFLOW_DEBUG.log('⚠️ DashboardCore não encontrado, usando fallback', 'error');
                    initBasicSidebar();
                }
                
            } catch (error) {
                window.DASHFLOW_DEBUG.log(`❌ Erro fatal no carregamento: ${error.message}`, 'error');
                window.DASHFLOW_DEBUG.showStatus();
                
                // Fallback para funcionamento básico
                window.DASHFLOW_DEBUG.log('Iniciando sistema de fallback...');
                initBasicSidebar();
            }
        }

        // Função auxiliar para carregar scripts com timeout
        function loadScriptWithTimeout(src, timeout = 10000) {
            return new Promise((resolve, reject) => {
                // Verificar se o script já foi carregado
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    window.DASHFLOW_DEBUG.log(`📋 ${src} já estava carregado`);
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.async = false; // Manter ordem de carregamento
                
                // Timeout handler
                const timeoutId = setTimeout(() => {
                    script.remove();
                    reject(new Error(`Timeout ao carregar ${src} (${timeout}ms)`));
                }, timeout);
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    window.DASHFLOW_DEBUG.log(`⚡ ${src} carregado`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    clearTimeout(timeoutId);
                    script.remove();
                    reject(new Error(`Erro de rede ao carregar ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Função de fallback para sidebar básico
        function initBasicSidebar() {
            window.DASHFLOW_DEBUG.log('🔧 Inicializando sidebar básico como fallback...');
            
            try {
                // Garantir que o sidebar esteja visível
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.opacity = '1';
                    sidebar.style.display = 'flex';
                    
                    // Adicionar classe collapsed por padrão
                    sidebar.classList.add('collapsed');
                    
                    window.DASHFLOW_DEBUG.log('✅ Sidebar básico configurado');
                } else {
                    window.DASHFLOW_DEBUG.log('❌ Elemento sidebar não encontrado', 'error');
                }
                
                // Inicializar eventos básicos de navegação
                initBasicNavigation();
                
                // Forçar carregamento do dashboard após 2 segundos
                setTimeout(() => {
                    window.DASHFLOW_DEBUG.log('🚀 Forçando carregamento do dashboard...');
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea && !contentArea.innerHTML.includes('dashboard-container')) {
                        if (typeof window.loadDashboardContent === 'function') {
                            window.loadDashboardContent();
                        } else {
                            window.DASHFLOW_DEBUG.log('⚠️ loadDashboardContent não encontrada, tentando navegação via DashboardCore');
                            if (window.dashboardCore) {
                                window.dashboardCore.handleNavigation('dashboard');
                            }
                        }
                    }
                }, 2000);
                
            } catch (error) {
                window.DASHFLOW_DEBUG.log(`❌ Erro ao inicializar sidebar básico: ${error.message}`, 'error');
            }
        }

        // Função para navegação básica
        function initBasicNavigation() {
            window.DASHFLOW_DEBUG.log('🔗 Configurando navegação básica...');
            
            const navLinks = document.querySelectorAll('[data-module]');
            window.DASHFLOW_DEBUG.log(`Encontrados ${navLinks.length} links de navegação`);
            
            navLinks.forEach((link, index) => {
                const module = link.getAttribute('data-module');
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.DASHFLOW_DEBUG.log(`📱 Navegação básica para: ${module}`);
                    
                    if (module === 'dashboard') {
                        if (typeof window.loadDashboardContent === 'function') {
                            window.loadDashboardContent();
                        } else {
                            window.DASHFLOW_DEBUG.log('⚠️ loadDashboardContent não encontrada, tentando navegação via DashboardCore');
                            if (window.dashboardCore) {
                                window.dashboardCore.handleNavigation('dashboard');
                            }
                        }
                    } else {
                        window.DASHFLOW_DEBUG.log(`⚠️ Módulo ${module} requer sistema modular completo`);
                    }
                });
            });
        }

        // Debug de emergência após 10 segundos
        setTimeout(() => {
            if (!window.dashboardCore && window.DASHFLOW_DEBUG.errors.length > 0) {
                console.group('🚨 DASHFLOW Emergency Debug');
                console.error('Sistema modular falhou ao carregar após 10 segundos');
                window.DASHFLOW_DEBUG.showStatus();
                console.groupEnd();
                
                // Tentar inicializar sidebar básico se ainda não foi feito
                const sidebar = document.getElementById('sidebar');
                if (sidebar && !sidebar.style.opacity) {
                    initBasicSidebar();
                }
            }
        }, 10000);

        // Inicializar sistema modular quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadModularSystem);
        } else {
            loadModularSystem();
        }
    </script>
</body>
</html>
